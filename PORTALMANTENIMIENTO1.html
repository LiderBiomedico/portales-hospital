<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Susana L√≥pez de Valencia - Portal Gesti√≥n de Solicitudes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f8f5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #059669 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            color: white;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto;
            min-height: 5rem;
            padding: 1rem;
            position: relative;
            gap: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .hospital-info h1 {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .hospital-info p {
            font-size: 0.85rem;
            color: #e0f2fe;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-bottom: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .developer-credit {
            font-size: 0.75rem;
            color: #bfdbfe;
            font-weight: 400;
            margin-top: 0.25rem;
            margin-bottom: 0;
            text-align: center;
            font-style: italic;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: white;
            color: #059669;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: rgba(255,255,255,0.1);
            border: none;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
            color: white;
            backdrop-filter: blur(10px);
        }

        .notification-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            font-size: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid #ef4444;
            font-size: 0.875rem;
            z-index: 1000;
        }

        .firebase-status.connected {
            border-color: #059669;
        }

        .firebase-status.error {
            border-color: #ef4444;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .metric-card.total { 
            border-top-color: #2563eb; 
            background: linear-gradient(135deg, #ffffff 0%, #dbeafe 100%);
        }
        .metric-card.biomedica { 
            border-top-color: #059669; 
            background: linear-gradient(135deg, #ffffff 0%, #dcfce7 100%);
        }
        .metric-card.mecanica { 
            border-top-color: #f59e0b; 
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
        }
        .metric-card.infraestructura { 
            border-top-color: #8b5cf6; 
            background: linear-gradient(135deg, #ffffff 0%, #ede9fe 100%);
        }
        .metric-card.pendientes { 
            border-top-color: #ef4444; 
            background: linear-gradient(135deg, #ffffff 0%, #fee2e2 100%);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Area Tabs */
        .area-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .area-tab {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .area-tab.active {
            border-color: #059669;
            background: #dcfce7;
            color: #065f46;
        }

        .area-tab:hover:not(.active) {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .area-tab.biomedica.active {
            border-color: #059669;
            background: #dcfce7;
        }

        .area-tab.mecanica.active {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .area-tab.infraestructura.active {
            border-color: #8b5cf6;
            background: #ede9fe;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }

        .alert-danger {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* System status */
        .system-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid #059669;
            font-size: 0.875rem;
        }

        .status-online {
            color: #059669;
            font-weight: 600;
        }

        /* Technician cards */
        .technician-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .technician-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .technician-card.selectable {
            cursor: pointer;
        }

        .technician-card.selected {
            border-color: #059669;
            background: #dcfce7;
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.2);
        }

        .technician-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .technician-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .technician-id {
            background: #2563eb;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .technician-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .technician-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
        }

        .technician-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .status-disponible {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-ocupado {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-inactivo {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        /* Views */
        .view {
            display: block;
        }

        .view.hidden {
            display: none;
        }

        /* Request cards */
        .request-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .request-card.pending {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .request-card.assigned {
            border-left: 4px solid #2563eb;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .request-card.completed {
            border-left: 4px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .request-number {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.125rem;
        }

        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .request-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .request-detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .request-detail-value {
            color: #1f2937;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* Status badges */
        .status-pendiente {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-asignada {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-proceso {
            background: #fed7aa;
            color: #ea580c;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-completada {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Assignment Modal */
        .tech-selection-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .tech-selection-item {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .tech-selection-item:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .tech-selection-item.selected {
            border-color: #059669;
            background: #dcfce7;
        }

        .tech-selection-item.unavailable {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f9fafb;
        }

        /* Hidden class utility */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 1rem;
                gap: 1rem;
            }

            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }

            .hospital-info h1 {
                font-size: 1rem;
                text-align: center;
            }

            .hospital-info p {
                font-size: 0.75rem;
                text-align: center;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
                margin-top: 1rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .technician-details {
                grid-template-columns: 1fr;
            }

            .technician-actions {
                justify-content: center;
            }

            .request-details {
                grid-template-columns: 1fr;
            }

            .request-actions {
                justify-content: center;
            }
        }
    </style>

    <!-- Firebase SDK v10 -->
    <script type="module">
        // ===== CONFIGURACI√ìN DE FIREBASE =====
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, onSnapshot, query, orderBy, doc, setDoc, updateDoc, deleteDoc, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // üî• CONFIGURACI√ìN DE FIREBASE REAL - DEBES REEMPLAZAR CON TUS DATOS
        const firebaseConfig = {
            apiKey: "TU_API_KEY_AQUI",
            authDomain: "TU_PROJECT_ID.firebaseapp.com",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_PROJECT_ID.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        let firebaseApp;
        let firebaseDB;
        let isFirebaseConnected = false;

        try {
            firebaseApp = initializeApp(firebaseConfig);
            firebaseDB = getFirestore(firebaseApp);
            isFirebaseConnected = true;
            console.log('üî• Firebase inicializado correctamente');
            updateFirebaseStatus('Conectado a Firebase', 'connected');
        } catch (error) {
            console.error('‚ùå Error al inicializar Firebase:', error);
            updateFirebaseStatus('Error en Firebase: ' + error.message, 'error');
        }

        // Hacer disponibles las variables globalmente
        window.firebaseApp = firebaseApp;
        window.firebaseDB = firebaseDB;
        window.isFirebaseConnected = isFirebaseConnected;

        // ===== FUNCIONES DE FIREBASE =====
        
        // Funci√≥n para cargar solicitudes desde Firebase
        window.loadRequestsFromFirebase = async function() {
            if (!isFirebaseConnected || !firebaseDB) {
                console.warn('‚ö†Ô∏è Firebase no est√° conectado, usando localStorage');
                return loadRequestsFromLocalStorage();
            }

            try {
                console.log('üî• Cargando solicitudes desde Firebase...');
                const solicitudesRef = collection(firebaseDB, 'solicitudes');
                const q = query(solicitudesRef, orderBy('fechaCreacion', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const firebaseRequests = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    firebaseRequests.push({
                        id: doc.id,
                        ...data
                    });
                });

                console.log(`üî• ${firebaseRequests.length} solicitudes cargadas desde Firebase`);
                updateFirebaseStatus(`Sincronizado: ${firebaseRequests.length} solicitudes`, 'connected');
                
                return firebaseRequests;
            } catch (error) {
                console.error('‚ùå Error al cargar desde Firebase:', error);
                updateFirebaseStatus('Error de sincronizaci√≥n: ' + error.message, 'error');
                return loadRequestsFromLocalStorage();
            }
        };

        // Funci√≥n para cargar t√©cnicos desde Firebase
        window.loadTechniciansFromFirebase = async function() {
            if (!isFirebaseConnected || !firebaseDB) {
                console.warn('‚ö†Ô∏è Firebase no est√° conectado para t√©cnicos');
                return loadTechniciansFromLocalStorage();
            }

            try {
                console.log('üë• Cargando t√©cnicos desde Firebase...');
                const techniciansRef = collection(firebaseDB, 'technicians');
                const querySnapshot = await getDocs(techniciansRef);
                
                const firebaseTechnicians = {
                    'INGENIERIA_BIOMEDICA': [],
                    'MECANICA': [],
                    'INFRAESTRUCTURA': []
                };

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const technician = {
                        id: doc.id,
                        ...data
                    };
                    
                    if (firebaseTechnicians[data.area]) {
                        firebaseTechnicians[data.area].push(technician);
                    }
                });

                console.log('üë• T√©cnicos cargados desde Firebase:', firebaseTechnicians);
                return firebaseTechnicians;
            } catch (error) {
                console.error('‚ùå Error al cargar t√©cnicos desde Firebase:', error);
                return loadTechniciansFromLocalStorage();
            }
        };

        // Funci√≥n para guardar t√©cnico en Firebase
        window.saveTechnicianToFirebase = async function(technician) {
            if (!isFirebaseConnected || !firebaseDB) {
                console.warn('‚ö†Ô∏è Firebase no est√° conectado, guardando en localStorage');
                return;
            }

            try {
                const techniciansRef = collection(firebaseDB, 'technicians');
                await addDoc(techniciansRef, technician);
                console.log('‚úÖ T√©cnico guardado en Firebase');
            } catch (error) {
                console.error('‚ùå Error al guardar t√©cnico en Firebase:', error);
            }
        };

        // Funci√≥n para actualizar t√©cnico en Firebase
        window.updateTechnicianInFirebase = async function(technicianId, updates) {
            if (!isFirebaseConnected || !firebaseDB) {
                return;
            }

            try {
                const technicianRef = doc(firebaseDB, 'technicians', technicianId);
                await updateDoc(technicianRef, updates);
                console.log('‚úÖ T√©cnico actualizado en Firebase');
            } catch (error) {
                console.error('‚ùå Error al actualizar t√©cnico en Firebase:', error);
            }
        };

        // Funci√≥n para eliminar t√©cnico de Firebase
        window.deleteTechnicianFromFirebase = async function(technicianId) {
            if (!isFirebaseConnected || !firebaseDB) {
                return;
            }

            try {
                const technicianRef = doc(firebaseDB, 'technicians', technicianId);
                await deleteDoc(technicianRef);
                console.log('‚úÖ T√©cnico eliminado de Firebase');
            } catch (error) {
                console.error('‚ùå Error al eliminar t√©cnico de Firebase:', error);
            }
        };

        // Funci√≥n para cargar solicitudes de acceso desde Firebase
        window.loadAccessRequestsFromFirebase = async function() {
            if (!isFirebaseConnected || !firebaseDB) {
                console.warn('‚ö†Ô∏è Firebase no est√° conectado para accesos');
                return [];
            }

            try {
                console.log('üîê Cargando solicitudes de acceso desde Firebase...');
                const accessRef = collection(firebaseDB, 'accessRequests');
                const q = query(accessRef, orderBy('fechaSolicitud', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const firebaseAccessRequests = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    firebaseAccessRequests.push({
                        id: doc.id,
                        ...data
                    });
                });

                console.log(`üîê ${firebaseAccessRequests.length} solicitudes de acceso cargadas desde Firebase`);
                return firebaseAccessRequests;
            } catch (error) {
                console.error('‚ùå Error al cargar solicitudes de acceso desde Firebase:', error);
                return [];
            }
        };

        // Funci√≥n para establecer listener en tiempo real
        window.setupFirebaseListener = function() {
            if (!isFirebaseConnected || !firebaseDB) {
                console.warn('‚ö†Ô∏è No se puede establecer listener de Firebase');
                return;
            }

            try {
                console.log('üëÇ Estableciendo listener en tiempo real de Firebase...');
                
                // Listener para solicitudes
                const solicitudesRef = collection(firebaseDB, 'solicitudes');
                const qSolicitudes = query(solicitudesRef, orderBy('fechaCreacion', 'desc'));
                
                onSnapshot(qSolicitudes, (snapshot) => {
                    console.log('üî• Cambios detectados en solicitudes Firebase');
                    const firebaseRequests = [];
                    snapshot.forEach((doc) => {
                        firebaseRequests.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Actualizar variables globales
                    window.solicitudesFromPortal = firebaseRequests;
                    window.lastRequestCount = firebaseRequests.length;
                    
                    // Actualizar interfaz
                    updateAllCounters();
                    updateRequestsDisplay();
                    updateAreaTabs();
                    checkForCriticalRequests();
                    
                    console.log(`üîÑ ${firebaseRequests.length} solicitudes sincronizadas desde Firebase`);
                    updateFirebaseStatus(`Tiempo real: ${firebaseRequests.length} solicitudes`, 'connected');
                });

                // Listener para t√©cnicos
                const techniciansRef = collection(firebaseDB, 'technicians');
                onSnapshot(techniciansRef, (snapshot) => {
                    console.log('üë• Cambios detectados en t√©cnicos Firebase');
                    const firebaseTechnicians = {
                        'INGENIERIA_BIOMEDICA': [],
                        'MECANICA': [],
                        'INFRAESTRUCTURA': []
                    };

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const technician = {
                            id: doc.id,
                            ...data
                        };
                        
                        if (firebaseTechnicians[data.area]) {
                            firebaseTechnicians[data.area].push(technician);
                        }
                    });
                    
                    // Actualizar variables globales
                    window.tecnicosPorArea = firebaseTechnicians;
                    
                    // Actualizar interfaz
                    updateTechniciansDisplay();
                    updateAllCounters();
                    
                    console.log('üë• T√©cnicos sincronizados desde Firebase');
                });

                // Listener para solicitudes de acceso
                const accessRef = collection(firebaseDB, 'accessRequests');
                const qAccess = query(accessRef, orderBy('fechaSolicitud', 'desc'));
                
                onSnapshot(qAccess, (snapshot) => {
                    console.log('üîê Cambios detectados en solicitudes de acceso Firebase');
                    const firebaseAccessRequests = [];
                    snapshot.forEach((doc) => {
                        firebaseAccessRequests.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Actualizar variables globales de acceso
                    window.accessRequests = firebaseAccessRequests;
                    
                    // Actualizar interfaz de accesos
                    updateAccessDisplay();
                    updateAccessCounters();
                    checkForPendingAccess();
                    
                    console.log(`üîê ${firebaseAccessRequests.length} solicitudes de acceso sincronizadas`);
                });

                console.log('‚úÖ Listeners de Firebase establecidos correctamente');
            } catch (error) {
                console.error('‚ùå Error al establecer listeners de Firebase:', error);
                updateFirebaseStatus('Error en tiempo real: ' + error.message, 'error');
            }
        };

        // Funciones fallback para localStorage
        function loadRequestsFromLocalStorage() {
            try {
                const savedRequests = localStorage.getItem('hospital_solicitudes');
                return savedRequests ? JSON.parse(savedRequests) : [];
            } catch (error) {
                console.error('‚ùå Error al cargar desde localStorage:', error);
                return [];
            }
        }

        function loadTechniciansFromLocalStorage() {
            try {
                const savedTechnicians = localStorage.getItem('hospital_technicians');
                if (savedTechnicians) {
                    return JSON.parse(savedTechnicians);
                }
                return {
                    'INGENIERIA_BIOMEDICA': [],
                    'MECANICA': [],
                    'INFRAESTRUCTURA': []
                };
            } catch (error) {
                console.error('‚ùå Error al cargar t√©cnicos desde localStorage:', error);
                return {
                    'INGENIERIA_BIOMEDICA': [],
                    'MECANICA': [],
                    'INFRAESTRUCTURA': []
                };
            }
        }

        function updateFirebaseStatus(message, status) {
            const statusElement = document.getElementById('firebase-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `firebase-status ${status}`;
            }
        }
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content container">
            <div class="logo">
                <div class="hospital-info">
                    <h1>HOSPITAL SUSANA LOPEZ DE VALENCIA E.S.E.</h1>
                    <p class="developer-credit">Desarrollado por Ing. Paul Eduardo Mu√±oz R.</p>
                    <p>Portal Gesti√≥n de Solicitudes - Sistema Integrado con Firebase</p>
                </div>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showView('dashboard')" data-view="dashboard">
                    üìä Dashboard
                </button>
                <button class="nav-tab" onclick="showView('solicitudes')" data-view="solicitudes">
                    üìã Gesti√≥n (<span id="total-count">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('areas')" data-view="areas">
                    üîß Por √Åreas
                </button>
                <button class="nav-tab" onclick="showView('tecnicos')" data-view="tecnicos">
                    üë• Ingenieros y T√©cnicos (<span id="total-technicians-nav">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('accesos')" data-view="accesos">
                    üîê Gesti√≥n de Accesos (<span id="pending-access-count">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('reportes')" data-view="reportes">
                    üìà Reportes
                </button>
            </nav>

            <div class="user-info">
                <button class="notification-btn" onclick="showNotifications()">
                    üîî
                    <span class="notification-badge" id="notification-count">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-layout container">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <!-- Estado de Firebase -->
            <div id="firebase-status-card" class="alert alert-info">
                <h3 style="font-weight: 600; margin-bottom: 0.5rem;">üî• Estado de Conexi√≥n Firebase</h3>
                <p id="firebase-connection-info">Verificando conexi√≥n...</p>
                <button class="btn btn-primary btn-sm" onclick="testFirebaseConnection()" style="margin-top: 0.5rem;">
                    üîç Probar Conexi√≥n
                </button>
            </div>

            <!-- Alertas de Solicitudes Cr√≠ticas -->
            <div id="critical-alerts"></div>

            <!-- Metrics por √Årea de Ingenier√≠a -->
            <div class="metrics-grid">
                <div class="metric-card total" onclick="filterByArea('all')">
                    <div class="metric-icon">üìã</div>
                    <div class="metric-number" id="metric-total">0</div>
                    <div class="metric-label">Total Solicitudes</div>
                </div>
                <div class="metric-card biomedica" onclick="filterByArea('INGENIERIA_BIOMEDICA')">
                    <div class="metric-icon">üè•</div>
                    <div class="metric-number" id="metric-biomedica">0</div>
                    <div class="metric-label">Ingenier√≠a Biom√©dica</div>
                </div>
                <div class="metric-card mecanica" onclick="filterByArea('MECANICA')">
                    <div class="metric-icon">‚öôÔ∏è</div>
                    <div class="metric-number" id="metric-mecanica">0</div>
                    <div class="metric-label">Mec√°nica</div>
                </div>
                <div class="metric-card infraestructura" onclick="filterByArea('INFRAESTRUCTURA')">
                    <div class="metric-icon">üèóÔ∏è</div>
                    <div class="metric-number" id="metric-infraestructura">0</div>
                    <div class="metric-label">Infraestructura</div>
                </div>
                <div class="metric-card pendientes" onclick="filterByStatus('PENDIENTE')">
                    <div class="metric-icon">‚è≥</div>
                    <div class="metric-number" id="metric-pendientes">0</div>
                    <div class="metric-label">Pendientes Asignaci√≥n</div>
                </div>
            </div>

            <!-- Resumen de Personal por √Årea -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üè• Personal Biom√©dica</h2>
                        <span class="status-disponible" id="biomedica-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">Cargando personal...</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚öôÔ∏è Personal Mec√°nica</h2>
                        <span class="status-disponible" id="mecanica-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">Cargando personal...</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üèóÔ∏è Personal Infraestructura</h2>
                        <span class="status-disponible" id="infraestructura-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">Cargando personal...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Solicitudes View -->
        <div id="solicitudes-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Gesti√≥n General de Solicitudes</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="syncFromFirebase()">
                            üî• Sincronizar Firebase
                        </button>
                        <button class="btn btn-success btn-sm" onclick="autoAssignPending()">
                            ü§ñ Auto-asignar
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="solicitudes-list">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üìã</div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">Cargando solicitudes...</h3>
                            <p style="margin-bottom: 1.5rem;">Conectando con Firebase...</p>
                            <button class="btn btn-primary" onclick="syncFromFirebase()">
                                üî• Sincronizar con Firebase
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Areas View -->
        <div id="areas-view" class="view hidden">
            <div class="area-tabs">
                <div class="area-tab active biomedica" onclick="showAreaTab('biomedica')" data-area="biomedica">
                    üè• Ingenier√≠a Biom√©dica (<span id="tab-biomedica-count">0</span>)
                </div>
                <div class="area-tab mecanica" onclick="showAreaTab('mecanica')" data-area="mecanica">
                    ‚öôÔ∏è Mec√°nica (<span id="tab-mecanica-count">0</span>)
                </div>
                <div class="area-tab infraestructura" onclick="showAreaTab('infraestructura')" data-area="infraestructura">
                    üèóÔ∏è Infraestructura (<span id="tab-infraestructura-count">0</span>)
                </div>
            </div>

            <div id="area-biomedica" class="area-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üè• Solicitudes - Ingenier√≠a Biom√©dica</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAreaRequests('INGENIERIA_BIOMEDICA')">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-requests">
                            <p style="text-align: center; color: #6b7280;">Cargando solicitudes del √°rea...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="area-mecanica" class="area-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚öôÔ∏è Solicitudes - Mec√°nica</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAreaRequests('MECANICA')">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-requests">
                            <p style="text-align: center; color: #6b7280;">Cargando solicitudes del √°rea...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="area-infraestructura" class="area-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üèóÔ∏è Solicitudes - Infraestructura</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAreaRequests('INFRAESTRUCTURA')">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-requests">
                            <p style="text-align: center; color: #6b7280;">Cargando solicitudes del √°rea...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- T√©cnicos View -->
        <div id="tecnicos-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Gesti√≥n de Ingenieros y T√©cnicos</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="showAddTechnicianModal()">
                            ‚ûï Agregar Ingeniero/T√©cnico
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="syncTechniciansFromFirebase()">
                            üî• Sincronizar Firebase
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="exportTechnicians()">
                            üì§ Exportar Lista
                        </button>
                    </div>
                </div>
            </div>

            <!-- Personal por √Årea -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
                <!-- Ingenier√≠a Biom√©dica -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);">
                        <h3 class="card-title" style="color: #065f46;">üè• Ingenier√≠a Biom√©dica</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-disponible" id="biomedica-total">0 ingenieros/t√©cnicos</span>
                            <button class="btn btn-success btn-sm" onclick="showAddTechnicianModal('INGENIERIA_BIOMEDICA')">
                                ‚ûï Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üè•</div>
                                <h4>Cargando personal...</h4>
                                <p style="font-size: 0.875rem;">Conectando con Firebase</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mec√°nica -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #fefbeb 0%, #fef3c7 100%);">
                        <h3 class="card-title" style="color: #d97706;">‚öôÔ∏è Mec√°nica</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-ocupado" id="mecanica-total">0 ingenieros/t√©cnicos</span>
                            <button class="btn btn-warning btn-sm" onclick="showAddTechnicianModal('MECANICA')">
                                ‚ûï Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">‚öôÔ∏è</div>
                                <h4>Cargando personal...</h4>
                                <p style="font-size: 0.875rem;">Conectando con Firebase</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Infraestructura -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #f3f4f6 0%, #ede9fe 100%);">
                        <h3 class="card-title" style="color: #7c3aed;">üèóÔ∏è Infraestructura</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-inactivo" id="infraestructura-total">0 ingenieros/t√©cnicos</span>
                            <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('INFRAESTRUCTURA')">
                                ‚ûï Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üèóÔ∏è</div>
                                <h4>Cargando personal...</h4>
                                <p style="font-size: 0.875rem;">Conectando con Firebase</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas de Personal -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Estad√≠sticas de Personal T√©cnico</h3>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2563eb;" id="total-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Total Personal</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #eff6ff; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2563eb;" id="total-engineers">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Ingenieros</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #059669;" id="total-technicians-only">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">T√©cnicos</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #059669;" id="available-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Disponibles</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="busy-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Ocupados</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #fee2e2; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #ef4444;" id="inactive-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Inactivos</div>
                        </div>
                    </div>

                    <!-- Informaci√≥n adicional -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #2563eb;">
                        <h4 style="color: #1f2937; margin-bottom: 0.5rem;">üí° Sistema Firebase Integrado</h4>
                        <ul style="color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
                            <li><strong>üî• Sincronizaci√≥n:</strong> Datos sincronizados en tiempo real con Firebase</li>
                            <li><strong>üåê Multi-dispositivo:</strong> Accesible desde cualquier computador</li>
                            <li><strong>üéØ Asignaci√≥n:</strong> Sistema autom√°tico y manual para asignar t√©cnicos</li>
                            <li><strong>üìä Persistencia:</strong> Datos guardados en la nube permanentemente</li>
                            <li><strong>‚ö° Tiempo real:</strong> Cambios visibles instant√°neamente en todos los dispositivos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accesos View -->
        <div id="accesos-view" class="view hidden">
            <div class="alert alert-info">
                <h3 style="font-weight: 600; margin-bottom: 0.5rem;">üîê Sistema de C√≥digos de Acceso</h3>
                <p>Gesti√≥n de accesos al Portal de Solicitudes con c√≥digos √∫nicos de 4 d√≠gitos integrado con Firebase.</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîê Solicitudes de Acceso Pendientes</h2>
                    <button class="btn btn-primary btn-sm" onclick="syncAccessFromFirebase()">
                        üî• Sincronizar Accesos
                    </button>
                </div>
                <div class="card-content">
                    <div id="pending-access-list">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üîê</div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">Cargando solicitudes de acceso...</h3>
                            <p style="margin-bottom: 1.5rem;">Conectando con Firebase...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reportes View -->
        <div id="reportes-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìà Reportes y Estad√≠sticas por Departamento</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="generateDepartmentReport()">
                            üìä Generar Reporte Completo
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportDepartmentStats()">
                            üì§ Exportar Estad√≠sticas
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="generateRealTimeReport()">
                            üî• Reporte Firebase
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="reports-content">
                        <!-- Estad√≠sticas en Tiempo Real -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div class="card">
                                <div class="card-header" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                                    <h3 style="color: #1e40af;">üìä Estad√≠sticas Generales</h3>
                                </div>
                                <div class="card-content">
                                    <div id="general-stats">
                                        <p style="color: #6b7280; text-align: center;">Cargando estad√≠sticas...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                                    <h3 style="color: #166534;">üë• Personal por √Årea</h3>
                                </div>
                                <div class="card-content">
                                    <div id="personnel-stats">
                                        <p style="color: #6b7280; text-align: center;">Cargando personal...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header" style="background: linear-gradient(135deg, #fefbeb 0%, #fef3c7 100%);">
                                    <h3 style="color: #d97706;">‚ö° Rendimiento</h3>
                                </div>
                                <div class="card-content">
                                    <div id="performance-stats">
                                        <p style="color: #6b7280; text-align: center;">Calculando rendimiento...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gr√°fico de Solicitudes por √Årea -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">üìà Distribuci√≥n de Solicitudes por √Årea</h3>
                            </div>
                            <div class="card-content">
                                <div id="area-distribution-chart">
                                    <canvas id="areaChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase Status Indicator -->
    <div id="firebase-status" class="firebase-status">
        üî• Inicializando Firebase...
    </div>

    <!-- System Status -->
    <div class="system-status">
        <div class="status-online" id="sync-status">
            üîÑ Sistema iniciando...
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES =====
        let solicitudesFromPortal = [];
        let accessRequests = [];
        let approvedUsers = [];
        let rejectedUsers = [];
        let tecnicosPorArea = {
            'INGENIERIA_BIOMEDICA': [],
            'MECANICA': [],
            'INFRAESTRUCTURA': []
        };
        let lastSyncTime = null;
        let isFirebaseReady = false;
        let selectedTechnicianForAssignment = null;

        // Mapas de servicios y areas
        const serviciosIngenieria = {
            'INGENIERIA_BIOMEDICA': 'Ingenier√≠a Biom√©dica',
            'INFRAESTRUCTURA': 'Infraestructura',
            'MECANICA': 'Mec√°nica'
        };

        const iconosIngenieria = {
            'INGENIERIA_BIOMEDICA': 'üè•',
            'INFRAESTRUCTURA': 'üèóÔ∏è',
            'MECANICA': '‚öôÔ∏è'
        };

        // ===== FUNCIONES DE SINCRONIZACI√ìN FIREBASE =====
        
        async function syncFromFirebase() {
            console.log('üî• Iniciando sincronizaci√≥n manual desde Firebase...');
            
            if (!window.isFirebaseConnected) {
                alert('‚ùå Firebase no est√° conectado. Verificar configuraci√≥n.');
                return;
            }

            try {
                const firebaseRequests = await window.loadRequestsFromFirebase();
                
                if (firebaseRequests && firebaseRequests.length > 0) {
                    solicitudesFromPortal = firebaseRequests;
                    lastSyncTime = new Date();
                    
                    updateAllCounters();
                    updateRequestsDisplay();
                    updateAreaTabs();
                    checkForCriticalRequests();
                    
                    alert(`üî• Sincronizaci√≥n completada\n\nüìä Solicitudes encontradas: ${firebaseRequests.length}\n‚è∞ √öltima sync: ${lastSyncTime.toLocaleTimeString('es-CO')}\n\n‚úÖ Datos cargados desde Firebase Firestore`);
                } else {
                    alert('üìã No se encontraron solicitudes en Firebase\n\nüí° Verifica que:\n‚Ä¢ Las solicitudes se est√©n enviando correctamente\n‚Ä¢ La colecci√≥n "solicitudes" existe en Firestore\n‚Ä¢ Los permisos de lectura est√°n configurados');
                }
            } catch (error) {
                console.error('‚ùå Error en sincronizaci√≥n:', error);
                alert('‚ùå Error al sincronizar con Firebase:\n\n' + error.message);
            }
        }

        async function syncTechniciansFromFirebase() {
            console.log('üë• Sincronizando t√©cnicos desde Firebase...');
            
            if (!window.isFirebaseConnected) {
                alert('‚ùå Firebase no est√° conectado para t√©cnicos');
                return;
            }

            try {
                const firebaseTechnicians = await window.loadTechniciansFromFirebase();
                
                if (firebaseTechnicians) {
                    tecnicosPorArea = firebaseTechnicians;
                    updateTechniciansDisplay();
                    updateAllCounters();
                    
                    const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
                    alert(`üë• T√©cnicos sincronizados desde Firebase: ${totalTechnicians}`);
                }
            } catch (error) {
                console.error('‚ùå Error al sincronizar t√©cnicos:', error);
                alert('‚ùå Error al sincronizar t√©cnicos desde Firebase:\n\n' + error.message);
            }
        }

        async function syncAccessFromFirebase() {
            console.log('üîê Sincronizando solicitudes de acceso desde Firebase...');
            
            if (!window.isFirebaseConnected) {
                alert('‚ùå Firebase no est√° conectado para accesos');
                return;
            }

            try {
                const firebaseAccessRequests = await window.loadAccessRequestsFromFirebase();
                
                if (firebaseAccessRequests) {
                    accessRequests = firebaseAccessRequests;
                    updateAccessDisplay();
                    updateAccessCounters();
                    checkForPendingAccess();
                    
                    alert(`üîê Solicitudes de acceso sincronizadas: ${firebaseAccessRequests.length}`);
                }
            } catch (error) {
                console.error('‚ùå Error al sincronizar accesos:', error);
                alert('‚ùå Error al sincronizar solicitudes de acceso:\n\n' + error.message);
            }
        }

        async function testFirebaseConnection() {
            console.log('üîç Probando conexi√≥n Firebase...');
            
            const statusCard = document.getElementById('firebase-connection-info');
            statusCard.textContent = 'Probando conexi√≥n...';
            
            if (!window.isFirebaseConnected || !window.firebaseDB) {
                statusCard.innerHTML = `‚ùå <strong>ERROR:</strong> Firebase no est√° inicializado correctamente<br><br>
                üìã <strong>Pasos para corregir:</strong><br>
                1. Verifica tu configuraci√≥n de Firebase en el c√≥digo<br>
                2. Aseg√∫rate de que los datos de firebaseConfig sean correctos<br>
                3. Verifica que tu proyecto de Firebase est√© activo<br>
                4. Revisa las reglas de seguridad de Firestore`;
                return;
            }

            try {
                const testRequests = await window.loadRequestsFromFirebase();
                const testTechnicians = await window.loadTechniciansFromFirebase();
                const testAccess = await window.loadAccessRequestsFromFirebase();
                
                statusCard.innerHTML = `‚úÖ <strong>CONEXI√ìN EXITOSA</strong><br><br>
                üìä <strong>Datos encontrados:</strong><br>
                ‚Ä¢ Solicitudes: ${testRequests.length}<br>
                ‚Ä¢ T√©cnicos: ${Object.values(testTechnicians).reduce((sum, area) => sum + area.length, 0)}<br>
                ‚Ä¢ Solicitudes de acceso: ${testAccess.length}<br>
                ‚Ä¢ Proyecto: ${window.firebaseApp.options.projectId}<br>
                ‚Ä¢ Estado: Conectado y funcionando<br><br>
                üîÑ <strong>Sincronizaci√≥n autom√°tica activa</strong>`;
                
                // Actualizar datos
                solicitudesFromPortal = testRequests;
                tecnicosPorArea = testTechnicians;
                accessRequests = testAccess;
                updateAllCounters();
                updateRequestsDisplay();
                updateTechniciansDisplay();
                updateAccessDisplay();
                
            } catch (error) {
                statusCard.innerHTML = `‚ùå <strong>ERROR DE CONEXI√ìN:</strong><br><br>
                ${error.message}<br><br>
                üìã <strong>Posibles causas:</strong><br>
                ‚Ä¢ Configuraci√≥n de Firebase incorrecta<br>
                ‚Ä¢ Reglas de seguridad muy restrictivas<br>
                ‚Ä¢ Proyecto Firebase inactivo<br>
                ‚Ä¢ Problemas de red`;
            }
        }

        // ===== FUNCIONES DE GESTI√ìN DE T√âCNICOS =====

        function showAddTechnicianModal(area = '') {
            const modalHTML = `
                <div id="add-technician-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">‚ûï Agregar Nuevo Ingeniero/T√©cnico</h3>
                            <button class="modal-close" onclick="closeAddTechnicianModal()">‚úï</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <form id="add-technician-form">
                                <div class="form-group">
                                    <label class="form-label">üîß √Årea de Ingenier√≠a *</label>
                                    <select id="tech-area" class="form-select" required>
                                        <option value="">Seleccionar √°rea</option>
                                        <option value="INGENIERIA_BIOMEDICA" ${area === 'INGENIERIA_BIOMEDICA' ? 'selected' : ''}>üè• Ingenier√≠a Biom√©dica</option>
                                        <option value="MECANICA" ${area === 'MECANICA' ? 'selected' : ''}>‚öôÔ∏è Mec√°nica</option>
                                        <option value="INFRAESTRUCTURA" ${area === 'INFRAESTRUCTURA' ? 'selected' : ''}>üèóÔ∏è Infraestructura</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üë®‚Äçüéì Tipo de Personal *</label>
                                    <select id="tech-type" class="form-select" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="INGENIERO">üéì Ingeniero (T√≠tulo Profesional)</option>
                                        <option value="TECNICO">üîß T√©cnico Especializado</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üë§ Nombre Completo *</label>
                                    <input type="text" id="tech-name" class="form-input" required placeholder="Ej: Mar√≠a Garc√≠a Rodr√≠guez">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üéì Especialidad *</label>
                                    <input type="text" id="tech-specialty" class="form-input" required placeholder="Ej: Equipos Cr√≠ticos y Ventilaci√≥n">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üìû Tel√©fono *</label>
                                    <input type="tel" id="tech-phone" class="form-input" required placeholder="+57 300 123 4567">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üìß Email *</label>
                                    <input type="email" id="tech-email" class="form-input" required placeholder="nombre.apellido@hospital.com">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üìã Estado Inicial</label>
                                    <select id="tech-status" class="form-select">
                                        <option value="disponible">‚úÖ Disponible</option>
                                        <option value="ocupado">‚è≥ Ocupado</option>
                                        <option value="inactivo">‚ùå Inactivo</option>
                                    </select>
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; font-size: 0.875rem; border-left: 3px solid #2563eb;">
                                    <h4 style="color: #1e40af; margin-bottom: 0.5rem;">üî• Sistema Firebase</h4>
                                    <ul style="color: #1e40af; margin: 0; padding-left: 1rem;">
                                        <li>Los datos se guardan autom√°ticamente en Firebase</li>
                                        <li>Sincronizaci√≥n en tiempo real con todos los dispositivos</li>
                                        <li>Accesible desde cualquier computador</li>
                                    </ul>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
                                    <button type="button" class="btn btn-secondary" onclick="closeAddTechnicianModal()">Cancelar</button>
                                    <button type="submit" class="btn btn-success">‚úÖ Agregar al Sistema</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            document.getElementById('add-technician-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewTechnician();
            });
        }

        async function addNewTechnician() {
            try {
                const area = document.getElementById('tech-area')?.value;
                const type = document.getElementById('tech-type')?.value;
                const name = document.getElementById('tech-name')?.value?.trim();
                const specialty = document.getElementById('tech-specialty')?.value?.trim();
                const phone = document.getElementById('tech-phone')?.value?.trim();
                const email = document.getElementById('tech-email')?.value?.trim();
                const status = document.getElementById('tech-status')?.value || 'disponible';

                if (!area || !type || !name || !specialty || !phone || !email) {
                    alert('‚ùå Por favor complete todos los campos obligatorios');
                    return;
                }

                // Generar ID √∫nico
                const areaPrefix = area === 'INGENIERIA_BIOMEDICA' ? 'IB' : 
                                 area === 'MECANICA' ? 'ME' : 'IN';
                const timestamp = Date.now();
                const techId = `${areaPrefix}${timestamp}`;

                const prefix = type === 'INGENIERO' ? 'Ing.' : 'T√©c.';
                const fullName = `${prefix} ${name}`;

                const newTechnician = {
                    nombre: fullName,
                    tipo: type,
                    area: area,
                    especialidad: specialty,
                    telefono: phone,
                    email: email,
                    estado: status,
                    disponible: status === 'disponible',
                    fechaCreacion: new Date().toISOString(),
                    fechaCreacionLocal: new Date().toLocaleString('es-CO')
                };

                // Guardar en Firebase
                if (window.isFirebaseConnected) {
                    await window.saveTechnicianToFirebase(newTechnician);
                    console.log('‚úÖ T√©cnico guardado en Firebase');
                } else {
                    console.warn('‚ö†Ô∏è Firebase no conectado, guardando localmente');
                    // Fallback a localStorage
                    tecnicosPorArea[area].push({
                        id: techId,
                        ...newTechnician
                    });
                    localStorage.setItem('hospital_technicians', JSON.stringify(tecnicosPorArea));
                }

                closeAddTechnicianModal();
                
                alert(`‚úÖ ${type === 'INGENIERO' ? 'Ingeniero' : 'T√©cnico'} ${name} agregado exitosamente\n\nüìß Email: ${email}\nüìû Tel√©fono: ${phone}\nüî• Guardado en Firebase\n\nüåê Disponible desde cualquier computador`);
                
                // La actualizaci√≥n de la interfaz se har√° autom√°ticamente por el listener de Firebase
                if (!window.isFirebaseConnected) {
                    updateTechniciansDisplay();
                    updateAllCounters();
                }

            } catch (error) {
                console.error('‚ùå Error al agregar t√©cnico:', error);
                alert(`‚ùå Error al agregar el t√©cnico: ${error.message}`);
            }
        }

        function closeAddTechnicianModal() {
            const modal = document.getElementById('add-technician-modal');
            if (modal) {
                modal.remove();
            }
        }

        function updateTechniciansDisplay() {
            const areas = [
                { key: 'INGENIERIA_BIOMEDICA', name: 'biomedica', display: 'ingenier√≠a biom√©dica', icon: 'üè•' },
                { key: 'MECANICA', name: 'mecanica', display: 'mec√°nica', icon: '‚öôÔ∏è' },
                { key: 'INFRAESTRUCTURA', name: 'infraestructura', display: 'infraestructura', icon: 'üèóÔ∏è' }
            ];
            
            areas.forEach(area => {
                const technicians = tecnicosPorArea[area.key] || [];
                const listContainer = document.getElementById(`${area.name}-technicians-list`);
                
                if (!listContainer) return;
                
                if (technicians.length === 0) {
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">${area.icon}</div>
                            <h4>No hay personal registrado</h4>
                            <p style="font-size: 0.875rem;">Agregue personal especializado en ${area.display}</p>
                            <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('${area.key}')" style="margin-top: 1rem;">
                                ‚ûï Agregar Primer T√©cnico
                            </button>
                        </div>
                    `;
                } else {
                    const techniciansHTML = technicians.map(tech => createTechnicianCard(tech, area.key)).join('');
                    listContainer.innerHTML = techniciansHTML;
                }
            });
        }

        function createTechnicianCard(tech, area) {
            const statusClass = `status-${tech.estado}`;
            const typeIcon = tech.tipo === 'INGENIERO' ? 'üéì' : 'üîß';
            
            return `
                <div class="technician-card">
                    <div class="technician-header">
                        <div class="technician-name">${typeIcon} ${tech.nombre}</div>
                        <div class="technician-id">${tech.id || 'Firebase'}</div>
                    </div>
                    <div class="technician-details">
                        <div class="technician-detail">
                            <span>üéØ</span>
                            <span>${tech.especialidad}</span>
                        </div>
                        <div class="technician-detail">
                            <span>üìû</span>
                            <span>${tech.telefono}</span>
                        </div>
                        <div class="technician-detail">
                            <span>üìß</span>
                            <span>${tech.email}</span>
                        </div>
                        <div class="technician-detail">
                            <span>üìÖ</span>
                            <span>${tech.fechaCreacionLocal || new Date(tech.fechaCreacion).toLocaleString('es-CO')}</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <span class="${statusClass}">${tech.estado.charAt(0).toUpperCase() + tech.estado.slice(1)}</span>
                    </div>
                    <div class="technician-actions">
                        <button class="btn btn-warning btn-sm" onclick="toggleTechnicianStatus('${area}', '${tech.id}')">
                            üîÑ Cambiar Estado
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTechnician('${area}', '${tech.id}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `;
        }

        async function toggleTechnicianStatus(area, techId) {
            try {
                const technician = findTechnicianById(techId);
                if (!technician) {
                    alert('‚ùå T√©cnico no encontrado');
                    return;
                }

                const statusOptions = ['disponible', 'ocupado', 'inactivo'];
                const currentIndex = statusOptions.indexOf(technician.estado);
                const nextIndex = (currentIndex + 1) % statusOptions.length;
                const newStatus = statusOptions[nextIndex];

                const confirmation = confirm(`¬øCambiar estado de ${technician.nombre}?\n\n${technician.estado} ‚Üí ${newStatus}`);
                
                if (confirmation) {
                    if (window.isFirebaseConnected) {
                        await window.updateTechnicianInFirebase(techId, {
                            estado: newStatus,
                            disponible: newStatus === 'disponible'
                        });
                    } else {
                        technician.estado = newStatus;
                        technician.disponible = newStatus === 'disponible';
                        localStorage.setItem('hospital_technicians', JSON.stringify(tecnicosPorArea));
                    }
                    
                    alert(`‚úÖ Estado cambiado: ${technician.nombre} ahora est√° ${newStatus}`);
                }
            } catch (error) {
                console.error('‚ùå Error al cambiar estado:', error);
                alert('‚ùå Error al cambiar el estado del t√©cnico');
            }
        }

        async function deleteTechnician(area, techId) {
            try {
                const technician = findTechnicianById(techId);
                if (!technician) {
                    alert('‚ùå T√©cnico no encontrado');
                    return;
                }

                const confirmation = confirm(`¬øELIMINAR permanentemente a ${technician.nombre}?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`);
                
                if (confirmation) {
                    if (window.isFirebaseConnected) {
                        await window.deleteTechnicianFromFirebase(techId);
                    } else {
                        const index = tecnicosPorArea[area].findIndex(tech => tech.id === techId);
                        if (index > -1) {
                            tecnicosPorArea[area].splice(index, 1);
                            localStorage.setItem('hospital_technicians', JSON.stringify(tecnicosPorArea));
                        }
                    }
                    
                    alert(`üóëÔ∏è ${technician.nombre} eliminado exitosamente`);
                }
            } catch (error) {
                console.error('‚ùå Error al eliminar t√©cnico:', error);
                alert('‚ùå Error al eliminar el t√©cnico');
            }
        }

        function findTechnicianById(techId) {
            for (const area of Object.values(tecnicosPorArea)) {
                const technician = area.find(tech => tech.id === techId);
                if (technician) return technician;
            }
            return null;
        }

        function exportTechnicians() {
            const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            
            if (totalTechnicians === 0) {
                alert('üìã No hay t√©cnicos registrados para exportar');
                return;
            }

            const exportData = {
                fechaExportacion: new Date().toLocaleString('es-CO'),
                totalTecnicos: totalTechnicians,
                sistemaConectado: window.isFirebaseConnected ? 'Firebase' : 'Local',
                datosPorArea: tecnicosPorArea
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `tecnicos_hospital_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert(`üì§ Lista de ${totalTechnicians} t√©cnicos exportada exitosamente`);
        }

        // ===== FUNCIONES DE ASIGNACI√ìN =====

        function assignTechnicianToRequest(requestNumber) {
            const request = solicitudesFromPortal.find(r => (r.numero || r.id) === requestNumber);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }

            const areaKey = request.servicioIngenieria;
            if (!areaKey) {
                alert('‚ùå La solicitud no tiene √°rea especificada');
                return;
            }

            const availableTechnicians = getAvailableTechnicians(areaKey);
            
            if (availableTechnicians.length === 0) {
                alert(`‚ùå No hay t√©cnicos disponibles en ${serviciosIngenieria[areaKey]}`);
                return;
            }

            showTechnicianAssignmentModal(request, availableTechnicians);
        }

        function getAvailableTechnicians(areaKey) {
            if (!tecnicosPorArea[areaKey]) return [];
            return tecnicosPorArea[areaKey].filter(tech => tech.estado === 'disponible');
        }

        function showTechnicianAssignmentModal(request, availableTechnicians) {
            const areaName = serviciosIngenieria[request.servicioIngenieria];
            const areaIcon = iconosIngenieria[request.servicioIngenieria];
            
            const modalHTML = `
                <div id="assignment-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">üë®‚Äçüîß Asignar T√©cnico/Ingeniero</h3>
                            <button class="modal-close" onclick="closeAssignmentModal()">‚úï</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem; border-left: 4px solid #2563eb;">
                                <h4 style="color: #1f2937; margin-bottom: 0.5rem;">üìã Solicitud: ${request.numero || request.id}</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                    <div><strong>üè• √Årea:</strong> ${areaIcon} ${areaName}</div>
                                    <div><strong>‚ö° Prioridad:</strong> ${request.prioridad || 'MEDIA'}</div>
                                    <div><strong>üñ•Ô∏è Equipo:</strong> ${request.equipo || 'No especificado'}</div>
                                    <div><strong>üìç Ubicaci√≥n:</strong> ${request.ubicacion || 'No especificado'}</div>
                                </div>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <h4 style="color: #1f2937; margin-bottom: 1rem;">üë• T√©cnicos Disponibles (${availableTechnicians.length})</h4>
                                
                                <div class="tech-selection-list">
                                    ${availableTechnicians.map(tech => createTechnicianSelectionItem(tech)).join('')}
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: end;">
                                <button class="btn btn-secondary" onclick="closeAssignmentModal()">Cancelar</button>
                                <button class="btn btn-success" onclick="confirmTechnicianAssignment('${request.numero || request.id}')" 
                                        id="confirm-assignment-btn" disabled>
                                    ‚úÖ Asignar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function createTechnicianSelectionItem(tech) {
            return `
                <div class="tech-selection-item" onclick="selectTechnician('${tech.id}')" data-tech-id="${tech.id}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.25rem;">${tech.tipo === 'INGENIERO' ? 'üéì' : 'üîß'}</span>
                            <strong style="color: #1f2937;">${tech.nombre}</strong>
                        </div>
                        <span class="status-disponible">Disponible</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                        <div><span>üéØ</span> ${tech.especialidad}</div>
                        <div><span>üìû</span> ${tech.telefono}</div>
                    </div>
                </div>
            `;
        }

        function selectTechnician(techId) {
            document.querySelectorAll('.tech-selection-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const selectedItem = document.querySelector(`[data-tech-id="${techId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
                selectedTechnicianForAssignment = techId;
                
                const confirmBtn = document.getElementById('confirm-assignment-btn');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    const techName = selectedItem.querySelector('strong').textContent;
                    confirmBtn.innerHTML = `‚úÖ Asignar A: ${techName}`;
                }
            }
        }

        async function confirmTechnicianAssignment(requestNumber) {
            if (!selectedTechnicianForAssignment) {
                alert('‚ùå Por favor seleccione un t√©cnico');
                return;
            }

            const request = solicitudesFromPortal.find(r => (r.numero || r.id) === requestNumber);
            const technician = findTechnicianById(selectedTechnicianForAssignment);
            
            if (!request || !technician) {
                alert('‚ùå Error: Solicitud o t√©cnico no encontrado');
                return;
            }

            const confirmation = confirm(`¬øConfirmar asignaci√≥n?\n\nüìã Solicitud: ${request.numero || request.id}\nüë®‚Äçüîß T√©cnico: ${technician.nombre}`);
            
            if (confirmation) {
                try {
                    // Actualizar en Firebase o localStorage
                    if (window.isFirebaseConnected) {
                        await window.updateTechnicianInFirebase(selectedTechnicianForAssignment, {
                            estado: 'ocupado',
                            disponible: false,
                            solicitudAsignada: request.numero || request.id
                        });
                    } else {
                        technician.estado = 'ocupado';
                        technician.disponible = false;
                        technician.solicitudAsignada = request.numero || request.id;
                        localStorage.setItem('hospital_technicians', JSON.stringify(tecnicosPorArea));
                    }

                    closeAssignmentModal();
                    alert(`‚úÖ Asignaci√≥n completada exitosamente\n\nüìã Solicitud: ${request.numero || request.id}\nüë®‚Äçüîß Asignado a: ${technician.nombre}`);
                    
                    selectedTechnicianForAssignment = null;
                } catch (error) {
                    console.error('‚ùå Error en asignaci√≥n:', error);
                    alert('‚ùå Error al confirmar la asignaci√≥n');
                }
            }
        }

        function closeAssignmentModal() {
            const modal = document.getElementById('assignment-modal');
            if (modal) {
                modal.remove();
            }
            selectedTechnicianForAssignment = null;
        }

        function autoAssignPending() {
            const pendingRequests = solicitudesFromPortal.filter(r => 
                r.estado === 'PENDIENTE' && !r.tecnicoAsignado
            );
            
            if (pendingRequests.length === 0) {
                alert('‚úÖ No hay solicitudes pendientes para asignar');
                return;
            }

            alert(`ü§ñ Funci√≥n de asignaci√≥n autom√°tica para ${pendingRequests.length} solicitudes en desarrollo`);
        }

        // ===== FUNCIONES DE VISUALIZACI√ìN =====
        
        function updateAllCounters() {
            const total = solicitudesFromPortal.length;
            const biomedica = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INGENIERIA_BIOMEDICA').length;
            const mecanica = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'MECANICA').length;
            const infraestructura = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INFRAESTRUCTURA').length;
            const pendientes = solicitudesFromPortal.filter(r => r.estado === 'PENDIENTE').length;

            document.getElementById('metric-total').textContent = total;
            document.getElementById('metric-biomedica').textContent = biomedica;
            document.getElementById('metric-mecanica').textContent = mecanica;
            document.getElementById('metric-infraestructura').textContent = infraestructura;
            document.getElementById('metric-pendientes').textContent = pendientes;
            document.getElementById('total-count').textContent = total;
            document.getElementById('notification-count').textContent = pendientes;

            // Contadores de √°reas
            document.getElementById('tab-biomedica-count').textContent = biomedica;
            document.getElementById('tab-mecanica-count').textContent = mecanica;
            document.getElementById('tab-infraestructura-count').textContent = infraestructura;

            // Contadores de t√©cnicos
            updateTechnicianCounters();
        }

        function updateTechnicianCounters() {
            const biomedica = tecnicosPorArea['INGENIERIA_BIOMEDICA'].length;
            const mecanica = tecnicosPorArea['MECANICA'].length;
            const infraestructura = tecnicosPorArea['INFRAESTRUCTURA'].length;
            const total = biomedica + mecanica + infraestructura;

            document.getElementById('biomedica-total').textContent = `${biomedica} ingenieros/t√©cnicos`;
            document.getElementById('mecanica-total').textContent = `${mecanica} ingenieros/t√©cnicos`;
            document.getElementById('infraestructura-total').textContent = `${infraestructura} ingenieros/t√©cnicos`;
            document.getElementById('total-technicians-nav').textContent = total;

            document.getElementById('biomedica-personnel-count').textContent = `${biomedica} registrados`;
            document.getElementById('mecanica-personnel-count').textContent = `${mecanica} registrados`;
            document.getElementById('infraestructura-personnel-count').textContent = `${infraestructura} registrados`;

            let totalEngineers = 0;
            let totalTechnicians = 0;
            let availableCount = 0;
            let busyCount = 0;
            let inactiveCount = 0;

            Object.values(tecnicosPorArea).forEach(areaList => {
                areaList.forEach(tech => {
                    if (tech.tipo === 'INGENIERO') totalEngineers++;
                    else totalTechnicians++;

                    if (tech.estado === 'disponible') availableCount++;
                    else if (tech.estado === 'ocupado') busyCount++;
                    else if (tech.estado === 'inactivo') inactiveCount++;
                });
            });

            document.getElementById('total-technicians').textContent = total;
            document.getElementById('total-engineers').textContent = totalEngineers;
            document.getElementById('total-technicians-only').textContent = totalTechnicians;
            document.getElementById('available-technicians').textContent = availableCount;
            document.getElementById('busy-technicians').textContent = busyCount;
            document.getElementById('inactive-technicians').textContent = inactiveCount;

            updatePersonnelSummaries();
        }

        function updatePersonnelSummaries() {
            const areas = [
                { key: 'INGENIERIA_BIOMEDICA', name: 'biomedica' },
                { key: 'MECANICA', name: 'mecanica' },
                { key: 'INFRAESTRUCTURA', name: 'infraestructura' }
            ];

            areas.forEach(area => {
                const personnel = tecnicosPorArea[area.key];
                const summaryContainer = document.getElementById(`${area.name}-personnel-summary`);
                
                if (!summaryContainer) return;
                
                if (personnel.length === 0) {
                    summaryContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No hay personal registrado</p>';
                } else {
                    const available = personnel.filter(p => p.estado === 'disponible').length;
                    const busy = personnel.filter(p => p.estado === 'ocupado').length;
                    const inactive = personnel.filter(p => p.estado === 'inactivo').length;
                    
                    summaryContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                            <div>
                                <div style="font-weight: bold; color: #059669;">${available}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Disponibles</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #f59e0b;">${busy}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Ocupados</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #ef4444;">${inactive}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Inactivos</div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function updateRequestsDisplay() {
            const container = document.getElementById('solicitudes-list');
            
            if (solicitudesFromPortal.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üìã</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes registradas</h3>
                        <p style="margin-bottom: 1.5rem;">Las solicitudes aparecer√°n aqu√≠ cuando lleguen desde Firebase</p>
                        <button class="btn btn-primary" onclick="syncFromFirebase()">
                            üî• Sincronizar con Firebase
                        </button>
                    </div>
                `;
            } else {
                const requestsHTML = solicitudesFromPortal
                    .sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion))
                    .map(request => createRequestCard(request))
                    .join('');
                
                container.innerHTML = requestsHTML;
            }
        }

        function createRequestCard(request) {
            const estadoClass = getStatusClass(request.estado);
            const areaInfo = request.servicioIngenieria ? serviciosIngenieria[request.servicioIngenieria] : 'Sin especificar';
            const iconoArea = request.servicioIngenieria ? iconosIngenieria[request.servicioIngenieria] : 'üîß';
            
            return `
                <div class="request-card ${getRequestCardClass(request.estado)}">
                    <div class="request-header">
                        <div class="request-number">üìã ${request.numero || request.id}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-${estadoClass}">${request.estado}</span>
                            <span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">
                                ${request.prioridad || 'MEDIA'}
                            </span>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.25rem;">${iconoArea}</span>
                            <strong style="color: #1f2937;">√Årea: ${areaInfo}</strong>
                        </div>
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            <strong>Solicitante:</strong> ${request.solicitante || 'No especificado'}
                        </div>
                    </div>

                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">üè• Servicio</div>
                            <div class="request-detail-value">${request.servicioHospitalario || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üñ•Ô∏è Equipo</div>
                            <div class="request-detail-value">${request.equipo || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üìç Ubicaci√≥n</div>
                            <div class="request-detail-value">${request.ubicacion || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üìÖ Fecha</div>
                            <div class="request-detail-value">${request.fechaCreacion || 'No especificado'}</div>
                        </div>
                    </div>

                    <div style="margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border-left: 3px solid #2563eb;">
                        <div class="request-detail-label">üìù Descripci√≥n</div>
                        <div style="margin-top: 0.5rem; color: #1f2937;">${request.descripcion || 'No especificada'}</div>
                    </div>

                    <div class="request-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewRequestDetails('${request.numero || request.id}')">
                            üëÅÔ∏è Ver Detalles
                        </button>
                        <button class="btn btn-success btn-sm" onclick="assignTechnicianToRequest('${request.numero || request.id}')">
                            üë®‚Äçüîß Asignar T√©cnico
                        </button>
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            const statusMap = {
                'PENDIENTE': 'pendiente',
                'ASIGNADA': 'asignada',
                'EN_PROCESO': 'proceso',
                'COMPLETADA': 'completada'
            };
            return statusMap[status] || 'pendiente';
        }

        function getRequestCardClass(status) {
            const classMap = {
                'PENDIENTE': 'pending',
                'ASIGNADA': 'assigned',
                'EN_PROCESO': 'assigned',
                'COMPLETADA': 'completed'
            };
            return classMap[status] || 'pending';
        }

        function checkForCriticalRequests() {
            const criticalRequests = solicitudesFromPortal.filter(r => 
                r.prioridad === 'CRITICA' && r.estado === 'PENDIENTE'
            );
            
            const alertsContainer = document.getElementById('critical-alerts');
            
            if (criticalRequests.length > 0) {
                alertsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">üö® SOLICITUDES CR√çTICAS</h3>
                        <p><strong>${criticalRequests.length} solicitudes cr√≠ticas</strong> requieren atenci√≥n inmediata</p>
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = '';
            }
        }

        function updateAreaTabs() {
            // Actualizar contadores en las pesta√±as de √°rea
            const biomedica = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INGENIERIA_BIOMEDICA').length;
            const mecanica = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'MECANICA').length;
            const infraestructura = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INFRAESTRUCTURA').length;

            document.getElementById('tab-biomedica-count').textContent = biomedica;
            document.getElementById('tab-mecanica-count').textContent = mecanica;
            document.getElementById('tab-infraestructura-count').textContent = infraestructura;
        }

        // ===== FUNCIONES DE GESTI√ìN DE ACCESOS =====
        
        function updateAccessDisplay() {
            // Implementar cuando sea necesario
        }

        function updateAccessCounters() {
            const pendingCount = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
            document.getElementById('pending-access-count').textContent = pendingCount;
        }

        function checkForPendingAccess() {
            // Implementar cuando sea necesario
        }

        // ===== FUNCIONES DE √ÅREAS =====

        function showAreaTab(areaName) {
            document.querySelectorAll('.area-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const targetArea = document.getElementById(`area-${areaName}`);
            if (targetArea) {
                targetArea.classList.remove('hidden');
            }
            
            document.querySelectorAll('.area-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-area="${areaName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            showAreaRequests(getAreaKeyFromName(areaName));
        }

        function getAreaKeyFromName(areaName) {
            const areaMap = {
                'biomedica': 'INGENIERIA_BIOMEDICA',
                'mecanica': 'MECANICA',
                'infraestructura': 'INFRAESTRUCTURA'
            };
            return areaMap[areaName] || 'INGENIERIA_BIOMEDICA';
        }

        function showAreaRequests(areaKey) {
            const areaRequests = solicitudesFromPortal.filter(r => r.servicioIngenieria === areaKey);
            const areaNames = {
                'INGENIERIA_BIOMEDICA': 'biomedica',
                'MECANICA': 'mecanica',
                'INFRAESTRUCTURA': 'infraestructura'
            };
            
            const containerName = areaNames[areaKey];
            const container = document.getElementById(`${containerName}-requests`);
            
            if (!container) return;
            
            if (areaRequests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${iconosIngenieria[areaKey]}</div>
                        <h4>No hay solicitudes para ${serviciosIngenieria[areaKey]}</h4>
                        <p style="font-size: 0.875rem;">Las solicitudes aparecer√°n aqu√≠ cuando lleguen del Portal</p>
                        <button class="btn btn-primary btn-sm" onclick="syncFromFirebase()" style="margin-top: 1rem;">
                            üîÑ Sincronizar Firebase
                        </button>
                    </div>
                `;
            } else {
                const requestsHTML = areaRequests
                    .sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion))
                    .map(request => createRequestCard(request))
                    .join('');
                
                container.innerHTML = requestsHTML;
            }
        }

        // ===== FUNCIONES DE REPORTES =====

        function generateDepartmentReport() {
            const totalRequests = solicitudesFromPortal.length;
            const totalPersonnel = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            
            // Actualizar estad√≠sticas generales
            document.getElementById('general-stats').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; text-align: center;">
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #2563eb;">${totalRequests}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Total Solicitudes</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #059669;">${totalPersonnel}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Total Personal</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${solicitudesFromPortal.filter(r => r.estado === 'PENDIENTE').length}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Pendientes</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;">${solicitudesFromPortal.filter(r => r.estado === 'COMPLETADA').length}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Completadas</div>
                    </div>
                </div>
            `;

            // Actualizar estad√≠sticas de personal
            document.getElementById('personnel-stats').innerHTML = `
                <div style="text-align: center; font-size: 0.875rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üè• Biom√©dica:</strong> ${tecnicosPorArea['INGENIERIA_BIOMEDICA'].length} personas
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>‚öôÔ∏è Mec√°nica:</strong> ${tecnicosPorArea['MECANICA'].length} personas
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üèóÔ∏è Infraestructura:</strong> ${tecnicosPorArea['INFRAESTRUCTURA'].length} personas
                    </div>
                </div>
            `;

            // Calcular rendimiento
            const availablePersonnel = Object.values(tecnicosPorArea).reduce((sum, area) => 
                sum + area.filter(tech => tech.estado === 'disponible').length, 0
            );
            const busyPersonnel = Object.values(tecnicosPorArea).reduce((sum, area) => 
                sum + area.filter(tech => tech.estado === 'ocupado').length, 0
            );

            document.getElementById('performance-stats').innerHTML = `
                <div style="text-align: center; font-size: 0.875rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>‚úÖ Disponibles:</strong> ${availablePersonnel}
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>‚è≥ Ocupados:</strong> ${busyPersonnel}
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>üìä Eficiencia:</strong> ${totalPersonnel > 0 ? Math.round((busyPersonnel / totalPersonnel) * 100) : 0}%
                    </div>
                </div>
            `;

            alert(`üìä Reporte generado exitosamente\n\nüî• Sistema Firebase: ${window.isFirebaseConnected ? 'Conectado' : 'Desconectado'}\nüìÖ Fecha: ${new Date().toLocaleString('es-CO')}`);
        }

        function generateRealTimeReport() {
            if (!window.isFirebaseConnected) {
                alert('‚ùå Firebase no est√° conectado\n\nEl reporte en tiempo real requiere conexi√≥n a Firebase');
                return;
            }

            const report = `üî• REPORTE FIREBASE EN TIEMPO REAL\n\nüìä ESTADO DEL SISTEMA:\n‚Ä¢ Proyecto: ${window.firebaseApp.options.projectId}\n‚Ä¢ Conexi√≥n: ‚úÖ Activa\n‚Ä¢ Sincronizaci√≥n: ‚úÖ Tiempo real\n\nüìã DATOS SINCRONIZADOS:\n‚Ä¢ Solicitudes: ${solicitudesFromPortal.length}\n‚Ä¢ T√©cnicos: ${Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0)}\n‚Ä¢ Accesos: ${accessRequests.length}\n\nüåê DISPONIBILIDAD:\n‚Ä¢ Multi-dispositivo: ‚úÖ Funcional\n‚Ä¢ Tiempo real: ‚úÖ Activo\n‚Ä¢ Persistencia: ‚úÖ En la nube\n\nüìÖ Generado: ${new Date().toLocaleString('es-CO')}`;

            alert(report);
        }

        function exportDepartmentStats() {
            const stats = {
                fechaExportacion: new Date().toLocaleString('es-CO'),
                sistemaConectado: window.isFirebaseConnected ? 'Firebase' : 'Local',
                solicitudes: solicitudesFromPortal.length,
                personal: Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0),
                detallesPorArea: {
                    biomedica: {
                        solicitudes: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INGENIERIA_BIOMEDICA').length,
                        personal: tecnicosPorArea['INGENIERIA_BIOMEDICA'].length
                    },
                    mecanica: {
                        solicitudes: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'MECANICA').length,
                        personal: tecnicosPorArea['MECANICA'].length
                    },
                    infraestructura: {
                        solicitudes: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INFRAESTRUCTURA').length,
                        personal: tecnicosPorArea['INFRAESTRUCTURA'].length
                    }
                }
            };

            const dataStr = JSON.stringify(stats, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `estadisticas_hospital_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('üì§ Estad√≠sticas exportadas exitosamente');
        }

        // ===== FUNCIONES DE NAVEGACI√ìN =====
        
        function showView(viewName) {
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.add('hidden'));
            
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const activeTab = document.querySelector(`[data-view="${viewName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // Cargar datos seg√∫n la vista
            if (viewName === 'solicitudes') {
                if (window.isFirebaseConnected) {
                    // Los datos se actualizan autom√°ticamente por el listener
                } else {
                    syncFromFirebase();
                }
            } else if (viewName === 'tecnicos') {
                if (window.isFirebaseConnected) {
                    // Los datos se actualizan autom√°ticamente por el listener
                } else {
                    syncTechniciansFromFirebase();
                }
            } else if (viewName === 'accesos') {
                syncAccessFromFirebase();
            } else if (viewName === 'areas') {
                showAreaTab('biomedica');
            } else if (viewName === 'reportes') {
                generateDepartmentReport();
            }
        }

        // ===== FUNCIONES AUXILIARES =====
        
        function filterByArea(area) {
            console.log(`Filtrando por √°rea: ${area}`);
        }

        function filterByStatus(status) {
            console.log(`Filtrando por estado: ${status}`);
        }

        function viewRequestDetails(requestId) {
            const request = solicitudesFromPortal.find(r => (r.numero || r.id) === requestId);
            if (request) {
                const details = `üìã DETALLES COMPLETOS - ${requestId}

üè• INFORMACI√ìN GENERAL:
‚Ä¢ √Årea: ${request.servicioIngenieria ? serviciosIngenieria[request.servicioIngenieria] : 'No especificada'}
‚Ä¢ Tipo: ${request.tipoServicio || 'No especificado'}
‚Ä¢ Prioridad: ${request.prioridad || 'MEDIA'}
‚Ä¢ Estado: ${request.estado}

üë§ SOLICITANTE:
‚Ä¢ Nombre: ${request.solicitante || 'No especificado'}
‚Ä¢ Servicio: ${request.servicioHospitalario || 'No especificado'}

üñ•Ô∏è EQUIPO/SISTEMA:
‚Ä¢ Equipo: ${request.equipo || 'No especificado'}
‚Ä¢ Ubicaci√≥n: ${request.ubicacion || 'No especificado'}
‚Ä¢ Tiempo estimado: ${request.tiempoEstimado || 'No especificado'}

üìù DESCRIPCI√ìN:
${request.descripcion || 'No especificada'}

üìÖ FECHAS:
‚Ä¢ Creaci√≥n: ${request.fechaCreacion || 'No disponible'}
‚Ä¢ ID Firebase: ${request.id || 'N/A'}

üî• SISTEMA: Firebase ${window.isFirebaseConnected ? 'Conectado' : 'Desconectado'}`;

                alert(details);
            }
        }

        function showNotifications() {
            const totalPersonnel = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            const pendingRequests = solicitudesFromPortal.filter(r => r.estado === 'PENDIENTE').length;
            const criticalRequests = solicitudesFromPortal.filter(r => r.prioridad === 'CRITICA' && r.estado === 'PENDIENTE').length;
            const pendingAccess = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
            
            alert(`üîî NOTIFICACIONES DEL SISTEMA

üìä ESTADO ACTUAL:
‚Ä¢ ${solicitudesFromPortal.length} Solicitudes totales
‚Ä¢ ${pendingRequests} Solicitudes pendientes
‚Ä¢ ${criticalRequests} Solicitudes cr√≠ticas
‚Ä¢ ${totalPersonnel} Ingenieros/T√©cnicos registrados

üîê GESTI√ìN DE ACCESOS:
‚Ä¢ ${pendingAccess} Solicitudes de acceso pendientes
‚Ä¢ ${approvedUsers.length} Usuarios con acceso aprobado

üî• SISTEMA FIREBASE:
‚Ä¢ Conexi√≥n: ${window.isFirebaseConnected ? '‚úÖ Conectado' : '‚ùå Desconectado'}
‚Ä¢ Proyecto: ${window.isFirebaseConnected ? window.firebaseApp.options.projectId : 'N/A'}
‚Ä¢ Sincronizaci√≥n: ${window.isFirebaseConnected ? '‚úÖ Tiempo real activo' : '‚ùå Sin conexi√≥n'}

üåê MULTI-DISPOSITIVO:
‚Ä¢ Accesible desde cualquier computador: ${window.isFirebaseConnected ? '‚úÖ S√ç' : '‚ùå Solo local'}
‚Ä¢ Datos sincronizados: ${window.isFirebaseConnected ? '‚úÖ En tiempo real' : '‚ùå Solo localmente'}

${lastSyncTime ? `üîÑ √öltima sincronizaci√≥n: ${lastSyncTime.toLocaleTimeString('es-CO')}` : '‚ö†Ô∏è Sin sincronizaci√≥n reciente'}

${criticalRequests > 0 ? 'üö® ¬°HAY SOLICITUDES CR√çTICAS QUE REQUIEREN ATENCI√ìN INMEDIATA!' : ''}
${pendingAccess > 0 ? '\nüîê ¬°HAY SOLICITUDES DE ACCESO PENDIENTES!' : ''}
${(criticalRequests === 0 && pendingAccess === 0) ? '‚úÖ Sistema funcionando normalmente' : ''}`);
        }

        // ===== INICIALIZACI√ìN =====
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Portal de Gesti√≥n Completo con Firebase - Hospital Susana L√≥pez de Valencia');
            console.log('üî• Iniciando sistema integrado con funcionalidades completas...');
            
            // Esperar a que Firebase est√© listo
            setTimeout(async () => {
                if (window.isFirebaseConnected) {
                    console.log('üî• Firebase conectado, estableciendo listeners...');
                    window.setupFirebaseListener();
                    
                    // Sincronizaci√≥n inicial completa
                    console.log('üìä Cargando datos iniciales...');
                    
                    try {
                        // Cargar solicitudes
                        const requests = await window.loadRequestsFromFirebase();
                        solicitudesFromPortal = requests || [];
                        
                        // Cargar t√©cnicos
                        const technicians = await window.loadTechniciansFromFirebase();
                        tecnicosPorArea = technicians || {
                            'INGENIERIA_BIOMEDICA': [],
                            'MECANICA': [],
                            'INFRAESTRUCTURA': []
                        };
                        
                        // Cargar solicitudes de acceso
                        const access = await window.loadAccessRequestsFromFirebase();
                        accessRequests = access || [];
                        
                        // Actualizar interfaz
                        updateAllCounters();
                        updateRequestsDisplay();
                        updateTechniciansDisplay();
                        updateAccessDisplay();
                        updateAreaTabs();
                        checkForCriticalRequests();
                        
                        console.log('‚úÖ Datos iniciales cargados desde Firebase');
                        document.getElementById('sync-status').textContent = 'üî• Firebase Conectado - Todas las funciones activas';
                        
                        // Probar conexi√≥n autom√°ticamente
                        testFirebaseConnection();
                        
                    } catch (error) {
                        console.error('‚ùå Error en carga inicial:', error);
                        document.getElementById('sync-status').textContent = '‚ö†Ô∏è Error en carga inicial de Firebase';
                    }
                    
                } else {
                    console.warn('‚ö†Ô∏è Firebase no conectado, funcionando en modo local');
                    document.getElementById('sync-status').textContent = '‚ö†Ô∏è Sin conexi√≥n Firebase - Funciones limitadas';
                    
                    // Cargar datos locales como fallback
                    tecnicosPorArea = {
                        'INGENIERIA_BIOMEDICA': [],
                        'MECANICA': [],
                        'INFRAESTRUCTURA': []
                    };
                    updateTechniciansDisplay();
                    updateAllCounters();
                    
                    // Probar conexi√≥n autom√°ticamente
                    setTimeout(testFirebaseConnection, 1000);
                }
                
                console.log('üéØ Sistema completamente inicializado:');
                console.log('   ‚úÖ Gesti√≥n de solicitudes');
                console.log('   ‚úÖ Gesti√≥n de t√©cnicos e ingenieros');
                console.log('   ‚úÖ Gesti√≥n por √°reas');
                console.log('   ‚úÖ Gesti√≥n de accesos');
                console.log('   ‚úÖ Sistema de reportes');
                console.log('   ‚úÖ Asignaci√≥n autom√°tica y manual');
                console.log('   ‚úÖ Funcionamiento multi-dispositivo');
                console.log('   üî• Integraci√≥n Firebase completa');
                
            }, 2000);
        });
    </script>
</body>
</html>