<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Susana López de Valencia - Portal Gestión de Solicitudes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f8f5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #059669 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            color: white;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto;
            min-height: 5rem;
            padding: 1rem;
            position: relative;
            gap: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .hospital-info h1 {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .hospital-info p {
            font-size: 0.85rem;
            color: #e0f2fe;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-bottom: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: white;
            color: #059669;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: rgba(255,255,255,0.1);
            border: none;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
            color: white;
            backdrop-filter: blur(10px);
        }

        .notification-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            font-size: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .metric-card.total { 
            border-top-color: #2563eb; 
            background: linear-gradient(135deg, #ffffff 0%, #dbeafe 100%);
        }
        .metric-card.biomedica { 
            border-top-color: #059669; 
            background: linear-gradient(135deg, #ffffff 0%, #dcfce7 100%);
        }
        .metric-card.mecanica { 
            border-top-color: #f59e0b; 
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
        }
        .metric-card.infraestructura { 
            border-top-color: #8b5cf6; 
            background: linear-gradient(135deg, #ffffff 0%, #ede9fe 100%);
        }
        .metric-card.pendientes { 
            border-top-color: #ef4444; 
            background: linear-gradient(135deg, #ffffff 0%, #fee2e2 100%);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Area Tabs */
        .area-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .area-tab {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .area-tab.active {
            border-color: #059669;
            background: #dcfce7;
            color: #065f46;
        }

        .area-tab:hover:not(.active) {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .area-tab.biomedica.active {
            border-color: #059669;
            background: #dcfce7;
        }

        .area-tab.mecanica.active {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .area-tab.infraestructura.active {
            border-color: #8b5cf6;
            background: #ede9fe;
        }

        /* Action buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Technician cards */
        .technician-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .technician-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .technician-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .technician-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .technician-id {
            background: #2563eb;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .technician-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .technician-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
        }

        .technician-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .status-disponible {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-ocupado {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-inactivo {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-asignada {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-proceso {
            background: #fed7aa;
            color: #ea580c;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-completada {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Request cards */
        .request-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .request-card.pending {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .request-card.assigned {
            border-left: 4px solid #2563eb;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .request-card.completed {
            border-left: 4px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .request-number {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.125rem;
        }

        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .request-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .request-detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .request-detail-value {
            color: #1f2937;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* Views */
        .view {
            display: block;
        }

        .view.hidden {
            display: none;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }

        .alert-danger {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* System status */
        .system-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid #059669;
            font-size: 0.875rem;
        }

        .status-online {
            color: #059669;
            font-weight: 600;
        }

        /* Access Code Display */
        .access-code-display {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #2563eb;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
        }

        .access-code-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e40af;
            letter-spacing: 0.5rem;
            font-family: 'Courier New', monospace;
            margin: 0.5rem 0;
            text-shadow: 0 2px 4px rgba(30, 64, 175, 0.3);
        }

        .access-code-label {
            font-size: 0.875rem;
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .access-code-info {
            font-size: 0.75rem;
            color: #3b82f6;
            margin-top: 0.5rem;
        }

        /* Hidden class utility */
        .hidden {
            display: none !important;
        }

        /* Animación para notificaciones críticas */
        @keyframes blink {
            0%, 50% { opacity: 1; background: #ef4444; }
            51%, 100% { opacity: 0.5; background: #fca5a5; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 1rem;
                gap: 1rem;
            }

            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }

            .hospital-info h1 {
                font-size: 1rem;
                text-align: center;
            }

            .hospital-info p {
                font-size: 0.75rem;
                text-align: center;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
                margin-top: 1rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .technician-details {
                grid-template-columns: 1fr;
            }

            .technician-actions {
                justify-content: center;
            }

            .request-details {
                grid-template-columns: 1fr;
            }

            .request-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content container">
            <div class="logo">
                <div class="hospital-info">
                    <h1>HOSPITAL SUSANA LOPEZ DE VALENCIA E.S.E.</h1>
                    <p>Portal Gestión de Solicitudes - Sistema con Códigos de Acceso</p>
                    <p style="font-size: 0.75rem; color: #e0f2fe; margin-top: 0.25rem;">Desarrollado por Ing. Paul Eduardo Muñoz R.</p>
                </div>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showView('dashboard')" data-view="dashboard">
                    📊 Dashboard
                </button>
                <button class="nav-tab" onclick="showView('solicitudes')" data-view="solicitudes">
                    📋 Gestión (<span id="total-count">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('areas')" data-view="areas">
                    🔧 Por Áreas
                </button>
                <button class="nav-tab" onclick="showView('tecnicos')" data-view="tecnicos">
                    👥 Gestión de Ingenieros y Técnicos (<span id="total-technicians-nav">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('accesos')" data-view="accesos">
                    🔐 Gestión de Accesos (<span id="pending-access-count">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('reportes')" data-view="reportes">
                    📈 Reportes
                </button>
            </nav>

            <div class="user-info">
                <button class="notification-btn" onclick="showNotifications()">
                    🔔
                    <span class="notification-badge" id="notification-count">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-layout container">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <!-- Alert de Sincronización Automática -->
            <div id="sync-alert" class="alert alert-info">
                <h3 style="font-weight: 600; margin-bottom: 0.5rem;">🔄 Sincronización Automática</h3>
                <p id="sync-status">Iniciando sincronización automática...</p>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-sm" onclick="forceSyncRequests()">
                        🔄 Sincronizar Ahora
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="toggleAutoSync()">
                        <span id="toggle-sync-text">⏸️ Desactivar Auto-Sync</span>
                    </button>
                </div>
            </div>

            <!-- Alertas de Solicitudes Críticas -->
            <div id="critical-alerts"></div>

            <!-- Metrics por Área de Ingeniería -->
            <div class="metrics-grid">
                <div class="metric-card total" onclick="filterByArea('all')">
                    <div class="metric-icon">📋</div>
                    <div class="metric-number" id="metric-total">0</div>
                    <div class="metric-label">Total Solicitudes</div>
                </div>
                <div class="metric-card biomedica" onclick="filterByArea('INGENIERIA_BIOMEDICA')">
                    <div class="metric-icon">🏥</div>
                    <div class="metric-number" id="metric-biomedica">0</div>
                    <div class="metric-label">Ingeniería Biomédica</div>
                </div>
                <div class="metric-card mecanica" onclick="filterByArea('MECANICA')">
                    <div class="metric-icon">⚙️</div>
                    <div class="metric-number" id="metric-mecanica">0</div>
                    <div class="metric-label">Mecánica</div>
                </div>
                <div class="metric-card infraestructura" onclick="filterByArea('INFRAESTRUCTURA')">
                    <div class="metric-icon">🏗️</div>
                    <div class="metric-number" id="metric-infraestructura">0</div>
                    <div class="metric-label">Infraestructura</div>
                </div>
                <div class="metric-card pendientes" onclick="filterByStatus('PENDIENTE')">
                    <div class="metric-icon">⏳</div>
                    <div class="metric-number" id="metric-pendientes">0</div>
                    <div class="metric-label">Pendientes Asignación</div>
                </div>
            </div>

            <!-- Alert de Solicitudes Pendientes -->
            <div id="pending-alerts">
                <!-- Las alertas aparecerán aquí cuando haya solicitudes pendientes -->
            </div>

            <!-- Resumen de Personal por Área -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">🏥 Personal Biomédica</h2>
                        <span class="status-disponible" id="biomedica-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">No hay personal registrado</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">⚙️ Personal Mecánica</h2>
                        <span class="status-disponible" id="mecanica-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">No hay personal registrado</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">🏗️ Personal Infraestructura</h2>
                        <span class="status-disponible" id="infraestructura-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">No hay personal registrado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Solicitudes View -->
        <div id="solicitudes-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">📋 Gestión General de Solicitudes</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="autoAssignPending()">
                            🤖 Auto-asignar Pendientes
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="forceSyncRequests()">
                            🔄 Sincronizar
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="solicitudes-list">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">📋</div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes registradas</h3>
                            <p style="margin-bottom: 1.5rem;">Las solicitudes aparecerán aquí cuando lleguen del Portal de Solicitudes</p>
                            <button class="btn btn-primary" onclick="forceSyncRequests()">
                                🔄 Sincronizar con Portal de Solicitudes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Areas View -->
        <div id="areas-view" class="view hidden">
            <div class="area-tabs">
                <div class="area-tab active biomedica" onclick="showAreaTab('biomedica')" data-area="biomedica">
                    🏥 Ingeniería Biomédica (<span id="tab-biomedica-count">0</span>)
                </div>
                <div class="area-tab mecanica" onclick="showAreaTab('mecanica')" data-area="mecanica">
                    ⚙️ Mecánica (<span id="tab-mecanica-count">0</span>)
                </div>
                <div class="area-tab infraestructura" onclick="showAreaTab('infraestructura')" data-area="infraestructura">
                    🏗️ Infraestructura (<span id="tab-infraestructura-count">0</span>)
                </div>
            </div>

            <div id="area-biomedica" class="area-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">🏥 Solicitudes - Ingeniería Biomédica</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAreaRequests('INGENIERIA_BIOMEDICA')">
                            🔄 Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-requests">
                            <p style="text-align: center; color: #6b7280;">Las solicitudes del área aparecerán aquí...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="area-mecanica" class="area-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">⚙️ Solicitudes - Mecánica</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAreaRequests('MECANICA')">
                            🔄 Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-requests">
                            <p style="text-align: center; color: #6b7280;">Las solicitudes del área aparecerán aquí...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="area-infraestructura" class="area-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">🏗️ Solicitudes - Infraestructura</h2>
                        <button class="btn btn-primary btn-sm" onclick="showAreaRequests('INFRAESTRUCTURA')">
                            🔄 Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-requests">
                            <p style="text-align: center; color: #6b7280;">Las solicitudes del área aparecerán aquí...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tecnicos View -->
        <div id="tecnicos-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">👥 Gestión de Ingenieros y Técnicos</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="showAddTechnicianModal()">
                            ➕ Agregar Ingeniero/Técnico
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="exportTechnicians()">
                            📤 Exportar Lista
                        </button>
                    </div>
                </div>
            </div>

            <!-- Personal por Área -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
                <!-- Ingeniería Biomédica -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);">
                        <h3 class="card-title" style="color: #065f46;">🏥 Ingeniería Biomédica</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-disponible" id="biomedica-total">0 ingenieros/técnicos</span>
                            <button class="btn btn-success btn-sm" onclick="showAddTechnicianModal('INGENIERIA_BIOMEDICA')">
                                ➕ Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">🏥</div>
                                <h4>No hay ingenieros ni técnicos registrados</h4>
                                <p style="font-size: 0.875rem;">Comience agregando personal especializado en ingeniería biomédica</p>
                                <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('INGENIERIA_BIOMEDICA')" style="margin-top: 1rem;">
                                    ➕ Agregar Primer Ingeniero/Técnico
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mecánica -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #fefbeb 0%, #fef3c7 100%);">
                        <h3 class="card-title" style="color: #d97706;">⚙️ Mecánica</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-ocupado" id="mecanica-total">0 ingenieros/técnicos</span>
                            <button class="btn btn-warning btn-sm" onclick="showAddTechnicianModal('MECANICA')">
                                ➕ Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">⚙️</div>
                                <h4>No hay ingenieros ni técnicos registrados</h4>
                                <p style="font-size: 0.875rem;">Comience agregando personal especializado en mecánica</p>
                                <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('MECANICA')" style="margin-top: 1rem;">
                                    ➕ Agregar Primer Ingeniero/Técnico
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Infraestructura -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #f3f4f6 0%, #ede9fe 100%);">
                        <h3 class="card-title" style="color: #7c3aed;">🏗️ Infraestructura</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-inactivo" id="infraestructura-total">0 ingenieros/técnicos</span>
                            <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('INFRAESTRUCTURA')">
                                ➕ Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">🏗️</div>
                                <h4>No hay ingenieros ni técnicos registrados</h4>
                                <p style="font-size: 0.875rem;">Comience agregando personal especializado en infraestructura</p>
                                <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('INFRAESTRUCTURA')" style="margin-top: 1rem;">
                                    ➕ Agregar Primer Ingeniero/Técnico
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estadísticas de Personal -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">📊 Estadísticas de Personal Técnico</h3>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2563eb;" id="total-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Total Personal</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #eff6ff; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2563eb;" id="total-engineers">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Ingenieros</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #059669;" id="total-technicians-only">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Técnicos</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #059669;" id="available-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Disponibles</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="busy-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Ocupados</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #fee2e2; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #ef4444;" id="inactive-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Inactivos</div>
                        </div>
                    </div>

                    <!-- Información adicional -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #2563eb;">
                        <h4 style="color: #1f2937; margin-bottom: 0.5rem;">💡 Información del Sistema</h4>
                        <ul style="color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
                            <li><strong>Ingenieros:</strong> Personal con título profesional para manejo de proyectos complejos</li>
                            <li><strong>Técnicos:</strong> Personal especializado en mantenimiento y reparación de equipos</li>
                            <li><strong>Clasificación por áreas:</strong> Biomédica, Mecánica e Infraestructura para asignación correcta</li>
                            <li><strong>Estados:</strong> Disponible (puede recibir asignaciones), Ocupado (tiene solicitud asignada), Inactivo (fuera de servicio)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accesos View -->
        <div id="accesos-view" class="view hidden">
            <!-- Alert de Códigos de Acceso -->
            <div class="alert alert-info">
                <h3 style="font-weight: 600; margin-bottom: 0.5rem;">🔢 Sistema de Códigos de Acceso de 4 Dígitos</h3>
                <p>Al aprobar solicitudes de acceso, el sistema genera automáticamente códigos únicos de 4 dígitos para el acceso al Portal de Solicitudes.</p>
                <ul style="margin: 0.5rem 0 0 1rem;">
                    <li><strong>Automático:</strong> Los códigos se generan al momento de aprobar</li>
                    <li><strong>Único:</strong> Cada usuario recibe un código diferente</li>
                    <li><strong>Seguro:</strong> Solo válido para el email específico</li>
                    <li><strong>Renovable:</strong> Se puede regenerar si es necesario</li>
                </ul>
            </div>

            <!-- Alert de Solicitudes de Acceso Pendientes -->
            <div id="access-alerts">
                <!-- Las alertas aparecerán aquí cuando haya solicitudes pendientes -->
            </div>

            <!-- Estadísticas de Accesos -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="metric-card total">
                    <div class="metric-icon">👥</div>
                    <div class="metric-number" id="total-users">0</div>
                    <div class="metric-label">Usuarios Registrados</div>
                </div>
                <div class="metric-card pendientes">
                    <div class="metric-icon">⏳</div>
                    <div class="metric-number" id="pending-access">0</div>
                    <div class="metric-label">Accesos Pendientes</div>
                </div>
                <div class="metric-card biomedica">
                    <div class="metric-icon">✅</div>
                    <div class="metric-number" id="approved-users">0</div>
                    <div class="metric-label">Usuarios Aprobados</div>
                </div>
                <div class="metric-card infraestructura">
                    <div class="metric-icon">❌</div>
                    <div class="metric-number" id="rejected-users">0</div>
                    <div class="metric-label">Accesos Rechazados</div>
                </div>
            </div>

            <!-- Solicitudes de Acceso Pendientes -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">⏳ Solicitudes de Acceso Pendientes</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="approveAllPending()">
                            ✅ Aprobar Todas
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="syncAccessRequests()">
                            🔄 Sincronizar
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="debugAccessRequests()">
                            🔍 Debug Sistema
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="pending-access-list">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">🔐</div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes de acceso pendientes</h3>
                            <p style="margin-bottom: 1.5rem;">Las solicitudes de acceso aparecerán aquí cuando los usuarios se registren</p>
                            <button class="btn btn-primary" onclick="syncAccessRequests()">
                                🔄 Sincronizar Solicitudes de Acceso
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usuarios Aprobados -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">✅ Usuarios con Acceso Aprobado</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="regenerateAllCodes()">
                            🔄 Regenerar Todos los Códigos
                        </button>
                        <button class="btn btn-success btn-sm" onclick="showAddUserModal()">
                            ➕ Agregar Usuario Manualmente
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="exportUsersList()">
                            📤 Exportar Lista
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="approved-users-list">
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
                            <h4>No hay usuarios aprobados</h4>
                            <p style="font-size: 0.875rem;">Los usuarios aprobados aparecerán aquí</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Accesos Rechazados -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">❌ Historial de Accesos Rechazados</h2>
                    <button class="btn btn-secondary btn-sm" onclick="clearRejectedHistory()">
                        🗑️ Limpiar Historial
                    </button>
                </div>
                <div class="card-content">
                    <div id="rejected-users-list">
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                            <h4>No hay accesos rechazados</h4>
                            <p style="font-size: 0.875rem;">El historial de rechazos aparecerá aquí</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reportes View -->
        <div id="reportes-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">📈 Reportes y Estadísticas por Departamento</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="generateDepartmentReport()">
                            📊 Generar Reporte Completo
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportDepartmentStats()">
                            📤 Exportar Estadísticas
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="reports-content">
                        <p style="text-align: center; color: #6b7280; padding: 2rem;">Los reportes aparecerán aquí...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- System Status -->
    <div class="system-status">
        <div class="status-online">
            🔄 Auto-Sync Iniciando...
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES MEJORADAS =====
        let solicitudesFromPortal = []; // Solicitudes del Portal de Solicitudes
        let localSolicitudes = []; // Solicitudes locales (asignaciones, estados)
        let accessRequests = []; // Solicitudes de acceso al portal
        let approvedUsers = []; // Usuarios con acceso aprobado
        let rejectedUsers = []; // Usuarios con acceso rechazado
        let lastSyncTime = null;
        let lastChangeDetected = null;
        let syncInterval = null;
        let lastRequestCount = 0;
        let isAutoSyncEnabled = true;

        // Base de datos de técnicos por área
        const tecnicosPorArea = {
            'INGENIERIA_BIOMEDICA': [],
            'MECANICA': [],
            'INFRAESTRUCTURA': []
        };

        // Mapas de servicios y areas
        const serviciosIngenieria = {
            'INGENIERIA_BIOMEDICA': 'Ingeniería Biomédica',
            'INFRAESTRUCTURA': 'Infraestructura',
            'MECANICA': 'Mecánica'
        };

        const iconosIngenieria = {
            'INGENIERIA_BIOMEDICA': '🏥',
            'INFRAESTRUCTURA': '🏗️',
            'MECANICA': '⚙️'
        };

        // ===== FUNCIÓN PARA GENERAR CÓDIGO DE 4 DÍGITOS ÚNICO =====
        function generateAccessCode() {
            let code;
            let isUnique = false;
            
            do {
                // Generar número de 4 dígitos (1000-9999)
                code = Math.floor(1000 + Math.random() * 9000).toString();
                
                // Verificar que sea único entre usuarios aprobados
                isUnique = !approvedUsers.some(user => user.codigoAcceso === code);
            } while (!isUnique);
            
            console.log(`🔢 Código de acceso generado: ${code}`);
            return code;
        }

        // ===== FUNCIONES DE SINCRONIZACIÓN AUTOMÁTICA =====
        function loadRequestsFromPortal() {
            console.log('🔄 Cargando solicitudes del Portal de Solicitudes...');
            
            try {
                const savedRequests = localStorage.getItem('hospital_solicitudes');
                const newRequests = savedRequests ? JSON.parse(savedRequests) : [];
                
                // Detectar si hay cambios
                const hasChanges = newRequests.length !== lastRequestCount || 
                                 JSON.stringify(newRequests) !== JSON.stringify(solicitudesFromPortal);
                
                if (hasChanges) {
                    console.log(`🔄 Cambios detectados: ${newRequests.length} solicitudes (anteriores: ${lastRequestCount})`);
                    
                    solicitudesFromPortal = newRequests;
                    lastRequestCount = newRequests.length;
                    
                    // Actualizar timestamp de sincronización
                    lastSyncTime = new Date();
                    
                    // Fusionar con solicitudes locales para mantener asignaciones y estados
                    mergeRequestsWithLocalData();
                    
                    // Actualizar interfaz automáticamente
                    updateSyncStatus();
                    updateAllCounters();
                    updateRequestsDisplay();
                    updateAreaTabs();
                    checkForCriticalRequests();
                    
                    // Mostrar notificación discreta de sincronización
                    showAutoSyncNotification(newRequests.length);
                }
                
                return solicitudesFromPortal;
            } catch (error) {
                console.error('❌ Error al cargar solicitudes:', error);
                solicitudesFromPortal = [];
                return [];
            }
        }

        function showAutoSyncNotification(count) {
            // Actualizar el indicador de estado del sistema
            const systemStatus = document.querySelector('.system-status .status-online');
            if (systemStatus) {
                lastChangeDetected = new Date();
                const timeString = lastChangeDetected.toLocaleTimeString('es-CO', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                // Mostrar notificación de cambio detectado
                systemStatus.textContent = `🔄 ¡Nuevos cambios! ${count} solicitudes - ${timeString}`;
                systemStatus.style.color = '#2563eb';
                systemStatus.style.fontWeight = '600';
                
                // Volver al estado normal después de 3 segundos
                setTimeout(() => {
                    systemStatus.textContent = `🟢 Auto-Sync Activo - Última actualización: ${timeString}`;
                    systemStatus.style.color = '#059669';
                    systemStatus.style.fontWeight = '600';
                }, 3000);
            }

            // Actualizar contador de notificaciones si hay solicitudes pendientes
            const pendingCount = solicitudesFromPortal.filter(r => 
                r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado
            ).length;
            
            const notificationBadge = document.getElementById('notification-count');
            if (notificationBadge) {
                notificationBadge.textContent = pendingCount;
                
                // Hacer parpadear la notificación si hay solicitudes críticas
                const criticalCount = solicitudesFromPortal.filter(r => 
                    r.prioridad === 'CRITICA' && (r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado)
                ).length;
                
                if (criticalCount > 0) {
                    notificationBadge.style.animation = 'blink 1s infinite';
                    setTimeout(() => {
                        notificationBadge.style.animation = '';
                    }, 5000);
                }
            }
        }

        function startAutoSync() {
            console.log('🚀 Iniciando sincronización automática...');
            isAutoSyncEnabled = true;
            
            // Sincronización inicial
            loadRequestsFromPortal();
            loadAccessRequests(); // Cargar solicitudes de acceso
            
            // Configurar sincronización automática cada 5 segundos
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            syncInterval = setInterval(() => {
                if (isAutoSyncEnabled) {
                    loadRequestsFromPortal();
                    loadAccessRequests(); // Sincronizar también accesos
                }
            }, 5000); // Cada 5 segundos
            
            console.log('✅ Sincronización automática configurada (cada 5 segundos)');
        }

        function stopAutoSync() {
            console.log('⏸️ Deteniendo sincronización automática...');
            isAutoSyncEnabled = false;
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        // Función para sincronización basada en eventos de localStorage
        function setupStorageListener() {
            console.log('📡 Configurando listeners de sincronización...');
            
            // Escuchar cambios en localStorage desde otras pestañas/ventanas
            window.addEventListener('storage', function(e) {
                console.log('📡 Evento storage detectado:', e.key, e.newValue !== e.oldValue);
                
                if (e.key === 'hospital_solicitudes' && e.newValue !== e.oldValue) {
                    console.log('📡 Cambio detectado en solicitudes desde otra pestaña');
                    loadRequestsFromPortal();
                }
                if (e.key === 'hospital_access_requests' && e.newValue !== e.oldValue) {
                    console.log('📡 Cambio detectado en solicitudes de acceso desde otra pestaña');
                    loadAccessRequests();
                }
            });
            
            // Detectar cambios dentro de la misma pestaña usando polling más frecuente
            let lastStorageValue = localStorage.getItem('hospital_solicitudes');
            let lastAccessValue = localStorage.getItem('hospital_access_requests');
            
            const storageWatcher = setInterval(() => {
                const currentValue = localStorage.getItem('hospital_solicitudes');
                const currentAccessValue = localStorage.getItem('hospital_access_requests');
                
                if (currentValue !== lastStorageValue) {
                    console.log('📡 Cambio detectado en solicitudes (misma pestaña)');
                    lastStorageValue = currentValue;
                    loadRequestsFromPortal();
                }
                
                if (currentAccessValue !== lastAccessValue) {
                    console.log('📡 ¡CAMBIO DETECTADO EN SOLICITUDES DE ACCESO! (misma pestaña)');
                    lastAccessValue = currentAccessValue;
                    
                    // Forzar recarga inmediata
                    setTimeout(() => {
                        loadAccessRequests();
                    }, 100);
                }
            }, 500); // Verificar cada 500ms para cambios locales (más frecuente)
            
            console.log('✅ Listeners de sincronización configurados');
        }

        function mergeRequestsWithLocalData() {
            console.log('🔗 Fusionando datos de solicitudes...');
            
            solicitudesFromPortal.forEach(request => {
                // Buscar si ya existe en datos locales
                const localRequest = localSolicitudes.find(r => r.numero === request.numero);
                
                if (localRequest) {
                    // Mantener datos de gestión local
                    request.tecnicoAsignado = localRequest.tecnicoAsignado;
                    request.estadoGestion = localRequest.estadoGestion || request.estado;
                    request.fechaAsignacion = localRequest.fechaAsignacion;
                    request.notas = localRequest.notas;
                } else {
                    // Nueva solicitud - establecer estado inicial
                    request.estadoGestion = request.estado || 'PENDIENTE';
                    request.tecnicoAsignado = null;
                    request.fechaAsignacion = null;
                    request.notas = '';
                }
            });
            
            console.log('✅ Fusión de datos completada');
        }

        function forceSyncRequests() {
            console.log('🔄 Sincronización manual solicitada...');
            
            const previousCount = solicitudesFromPortal.length;
            loadRequestsFromPortal();
            const newCount = solicitudesFromPortal.length;
            
            // Mostrar resultado de la sincronización manual
            const message = `🔄 Sincronización manual completada
            
📊 RESULTADOS:
• Solicitudes encontradas: ${newCount}
• Cambios detectados: ${Math.abs(newCount - previousCount)}
• Última sincronización: ${lastSyncTime ? lastSyncTime.toLocaleTimeString('es-CO') : 'Ahora'}
• Sincronización automática: ${isAutoSyncEnabled ? '✅ Activa (cada 5 seg)' : '❌ Desactivada'}

${newCount > 0 ? '✅ Las solicitudes están disponibles en el sistema' : '📋 No hay solicitudes pendientes'}`;
            
            alert(message);
        }

        function updateSyncStatus() {
            const syncAlert = document.getElementById('sync-alert');
            const syncStatus = document.getElementById('sync-status');
            
            if (solicitudesFromPortal.length > 0) {
                syncAlert.className = 'alert alert-success';
                syncStatus.innerHTML = `✅ <strong>Sincronización Automática Activa</strong> - ${solicitudesFromPortal.length} solicitudes sincronizadas
                <br><small style="color: #047857;">🔄 Actualización automática cada 5 segundos | Última sync: ${lastSyncTime ? lastSyncTime.toLocaleTimeString('es-CO') : 'Iniciando...'}</small>`;
            } else {
                syncAlert.className = 'alert alert-info';
                syncStatus.innerHTML = `🔄 <strong>Sincronización Automática Activa</strong> - Esperando solicitudes del Portal
                <br><small style="color: #1e40af;">📡 Monitoreando cambios automáticamente | Verificación: ${lastSyncTime ? lastSyncTime.toLocaleTimeString('es-CO') : 'En curso...'}</small>`;
            }
        }

        function toggleAutoSync() {
            if (isAutoSyncEnabled) {
                stopAutoSync();
                document.getElementById('toggle-sync-text').innerHTML = '🚀 Activar Auto-Sync';
                alert('⏸️ Sincronización automática DESACTIVADA\n\nAhora deberás sincronizar manualmente usando el botón "Sincronizar Ahora"');
            } else {
                startAutoSync();
                document.getElementById('toggle-sync-text').innerHTML = '⏸️ Desactivar Auto-Sync';
                alert('🚀 Sincronización automática ACTIVADA\n\nEl sistema se sincronizará automáticamente cada 5 segundos');
            }
            updateSyncStatus();
        }

        // Función para mostrar el estado de sincronización en tiempo real
        function updateSyncIndicator() {
            const indicator = document.querySelector('.system-status .status-online');
            if (indicator && isAutoSyncEnabled) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('es-CO', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                indicator.textContent = `🔄 Auto-Sync Activo - ${timeString}`;
            }
        }

        function checkForCriticalRequests() {
            const criticalRequests = solicitudesFromPortal.filter(r => 
                r.prioridad === 'CRITICA' && (r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado)
            );
            
            const alertsContainer = document.getElementById('critical-alerts');
            
            if (criticalRequests.length > 0) {
                alertsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">🚨 SOLICITUDES CRÍTICAS SIN ASIGNAR</h3>
                        <p><strong>${criticalRequests.length} solicitudes críticas</strong> requieren atención inmediata:</p>
                        <ul style="margin: 0.5rem 0 0 1rem;">
                            ${criticalRequests.map(r => `<li><strong>${r.numero}</strong> - ${r.servicioIngenieria ? serviciosIngenieria[r.servicioIngenieria] : 'Sin área'} - ${r.descripcion?.substring(0, 50)}...</li>`).join('')}
                        </ul>
                        <button class="btn btn-danger btn-sm" onclick="assignCriticalRequests()" style="margin-top: 0.5rem;">
                            🚨 Asignar Solicitudes Críticas
                        </button>
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = '';
            }
        }

        // ===== FUNCIONES DE GESTIÓN DE ACCESOS =====
        function loadAccessRequests() {
            console.log('🔐 Cargando solicitudes de acceso...');
            
            try {
                const savedAccessRequests = localStorage.getItem('hospital_access_requests');
                let rawRequests = savedAccessRequests ? JSON.parse(savedAccessRequests) : [];
                
                console.log(`📝 Datos crudos encontrados: ${rawRequests.length} solicitudes`, rawRequests);
                
                // Solo crear datos de ejemplo si NO HAY NADA en localStorage
                if (rawRequests.length === 0) {
                    console.log('📝 No hay datos en localStorage, creando datos de ejemplo para demostración');
                    rawRequests = [
                        {
                            id: 'ACC001',
                            nombreCompleto: 'Dr. Carlos Rodríguez Méndez',
                            email: 'carlos.rodriguez@hospital.com',
                            telefono: '+57 300 123 4567',
                            numeroDocumento: '12345678',
                            servicioHospitalario: 'URGENCIAS_ADULTO',
                            cargo: 'Médico Especialista en Medicina de Urgencias',
                            jefeSupervisor: 'Dr. Ana María Torres',
                            justificacion: 'Requiero acceso para solicitar mantenimiento preventivo y correctivo de equipos médicos en el área de urgencias, especialmente monitores de signos vitales y equipos de reanimación.',
                            fechaSolicitud: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                            estado: 'PENDIENTE',
                            esUrgente: true
                        },
                        {
                            id: 'ACC002',
                            nombreCompleto: 'Enfermera María Elena Vargas',
                            email: 'maria.vargas@hospital.com',
                            telefono: '+57 301 987 6543',
                            numeroDocumento: '87654321',
                            servicioHospitalario: 'UCI_ADULTO',
                            cargo: 'Jefe de Enfermería UCI',
                            jefeSupervisor: 'Dr. Patricia Jiménez',
                            justificacion: 'Necesito acceso para reportar fallas en ventiladores mecánicos y bombas de infusión que son críticas para el cuidado de pacientes en estado crítico.',
                            fechaSolicitud: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(),
                            estado: 'PENDIENTE',
                            esUrgente: false
                        }
                    ];
                    
                    // Guardar los datos de ejemplo
                    localStorage.setItem('hospital_access_requests', JSON.stringify(rawRequests));
                    console.log('📝 Datos de ejemplo creados y guardados');
                }
                
                // Normalizar TODOS los datos (reales + ejemplos)
                const newAccessRequests = rawRequests.map(request => {
                    console.log('🔄 Normalizando solicitud:', request);
                    return {
                        id: request.id || `ACC${Date.now()}${Math.random().toString(36).substring(2, 3)}`,
                        nombreCompleto: request.nombreCompleto || request.name || 'Nombre no especificado',
                        email: request.email || 'Sin email',
                        telefono: request.telefono || request.phone || 'Sin teléfono',
                        numeroDocumento: request.numeroDocumento || request.document || '',
                        servicioHospitalario: request.servicioHospitalario || request.service || 'No especificado',
                        cargo: request.cargo || request.position || 'No especificado',
                        jefeSupervisor: request.jefeSupervisor || '',
                        justificacion: request.justificacion || request.justification || 'Sin justificación',
                        fechaSolicitud: request.fechaSolicitud || request.requestDate || new Date().toISOString(),
                        estado: request.estado || request.status || 'PENDIENTE',
                        esUrgente: request.esUrgente || false
                    };
                });
                
                console.log(`✅ Solicitudes normalizadas: ${newAccessRequests.length}`, newAccessRequests);
                
                // Detectar cambios comparando con las solicitudes actuales
                const hasChanges = newAccessRequests.length !== accessRequests.length || 
                                 JSON.stringify(newAccessRequests) !== JSON.stringify(accessRequests);
                
                if (hasChanges || accessRequests.length === 0) {
                    console.log(`🔐 Cambios detectados en solicitudes de acceso: ${newAccessRequests.length} (anteriores: ${accessRequests.length})`);
                    accessRequests = newAccessRequests;
                    
                    // Actualizar interfaz solo si hay cambios reales
                    updateAccessDisplay();
                    checkForPendingAccess();
                    
                    // Guardar los datos normalizados en localStorage
                    localStorage.setItem('hospital_access_requests', JSON.stringify(newAccessRequests));
                }
                
                // Cargar usuarios aprobados
                const savedApprovedUsers = localStorage.getItem('hospital_approved_users');
                approvedUsers = savedApprovedUsers ? JSON.parse(savedApprovedUsers) : [];
                
                // Cargar usuarios rechazados
                const savedRejectedUsers = localStorage.getItem('hospital_rejected_users');
                rejectedUsers = savedRejectedUsers ? JSON.parse(savedRejectedUsers) : [];
                
                updateAccessCounters();
                
                return accessRequests;
            } catch (error) {
                console.error('❌ Error al cargar solicitudes de acceso:', error);
                accessRequests = [];
                return [];
            }
        }

        function syncAccessRequests() {
            console.log('🔄 Sincronización manual de solicitudes de acceso solicitada...');
            
            // Mostrar el estado actual del localStorage
            const currentData = localStorage.getItem('hospital_access_requests');
            console.log('📋 Datos actuales en localStorage:', currentData);
            
            const previousCount = accessRequests.length;
            
            // Forzar recarga completa
            accessRequests = []; // Limpiar para forzar detección de cambios
            loadAccessRequests();
            
            const newCount = accessRequests.length;
            
            // Mostrar logs detallados
            console.log(`📊 Sincronización completada: ${previousCount} → ${newCount}`);
            console.log('📋 Solicitudes actuales:', accessRequests);
            
            const message = `🔐 Sincronización de accesos completada
            
📊 RESULTADOS:
• Solicitudes encontradas: ${newCount}
• Cambios detectados: ${Math.abs(newCount - previousCount)}
• Usuarios aprobados: ${approvedUsers.length}
• Usuarios rechazados: ${rejectedUsers.length}

📋 DETALLES TÉCNICOS:
• localStorage clave: 'hospital_access_requests'
• Datos encontrados: ${currentData ? 'SÍ' : 'NO'}
• Última verificación: ${new Date().toLocaleTimeString('es-CO')}

${newCount > 0 ? '✅ Las solicitudes están disponibles para revisión' : '⚠️ No hay solicitudes de acceso pendientes\n\n💡 Si acabas de enviar una solicitud desde el Portal de Solicitudes, verifica que se haya guardado correctamente.'}`;
            
            alert(message);
        }

        function updateAccessDisplay() {
            updatePendingAccessList();
            updateApprovedUsersList();
            updateRejectedUsersList();
        }

        function updatePendingAccessList() {
            const container = document.getElementById('pending-access-list');
            const pendingRequests = accessRequests.filter(req => req.estado === 'PENDIENTE');
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">🔐</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes de acceso pendientes</h3>
                        <p style="margin-bottom: 1.5rem;">Las solicitudes de acceso aparecerán aquí cuando los usuarios se registren</p>
                        <button class="btn btn-primary" onclick="syncAccessRequests()">
                            🔄 Sincronizar Solicitudes de Acceso
                        </button>
                    </div>
                `;
            } else {
                const requestsHTML = pendingRequests
                    .sort((a, b) => new Date(b.fechaSolicitud) - new Date(a.fechaSolicitud))
                    .map(request => createAccessRequestCard(request))
                    .join('');
                
                container.innerHTML = requestsHTML;
            }
        }

        function createAccessRequestCard(request) {
            return `
                <div class="request-card pending">
                    <div class="request-header">
                        <div class="request-number">🔐 Solicitud de Acceso - ${request.id}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-pendiente">PENDIENTE REVISIÓN</span>
                            ${request.esUrgente ? '<span style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">URGENTE</span>' : ''}
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.25rem;">👤</span>
                            <strong style="color: #1f2937;">Solicitante: ${request.nombreCompleto}</strong>
                        </div>
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            <strong>Email:</strong> ${request.email} |
                            <strong>Cargo:</strong> ${request.cargo}
                        </div>
                    </div>

                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">🏥 Servicio</div>
                            <div class="request-detail-value">${request.servicioHospitalario}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">📞 Teléfono</div>
                            <div class="request-detail-value">${request.telefono || 'No proporcionado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">📅 Fecha</div>
                            <div class="request-detail-value">${new Date(request.fechaSolicitud).toLocaleString('es-CO')}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">🆔 Documento</div>
                            <div class="request-detail-value">${request.numeroDocumento}</div>
                        </div>
                    </div>

                    ${request.justificacion ? `
                        <div style="margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border-left: 3px solid #2563eb;">
                            <div class="request-detail-label">📝 Justificación</div>
                            <div style="margin-top: 0.5rem; color: #1f2937;">${request.justificacion}</div>
                        </div>
                    ` : ''}

                    <div class="request-actions">
                        <button class="btn btn-success btn-sm" onclick="approveAccessWithCode('${request.id}')">
                            ✅ Aprobar y Generar Código
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="rejectAccess('${request.id}')">
                            ❌ Rechazar Acceso
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="viewAccessDetails('${request.id}')">
                            👁️ Ver Detalles
                        </button>
                    </div>
                </div>
            `;
        }

        function approveAccessWithCode(requestId) {
            const request = accessRequests.find(req => req.id === requestId);
            if (!request) {
                alert('❌ Solicitud no encontrada');
                return;
            }

            // Generar código de 4 dígitos único
            const accessCode = generateAccessCode();

            const confirmation = confirm(`¿Aprobar acceso y generar código para:\n\n👤 ${request.nombreCompleto}\n📧 ${request.email}\n🏥 ${request.servicioHospitalario}\n👔 ${request.cargo}\n\n🔢 Se generará un código de 4 dígitos automáticamente.\n\n✅ El usuario podrá usar su email y el código para acceder al Portal de Solicitudes.`);
            
            if (confirmation) {
                // Actualizar estado de la solicitud
                request.estado = 'APROBADO';
                request.fechaAprobacion = new Date().toISOString();
                request.aprobadoPor = 'Sistema de Gestión';
                request.codigoGenerado = accessCode;

                // Agregar a usuarios aprobados con código
                const approvedUser = {
                    id: request.id,
                    nombreCompleto: request.nombreCompleto,
                    email: request.email,
                    telefono: request.telefono,
                    numeroDocumento: request.numeroDocumento,
                    servicioHospitalario: request.servicioHospitalario,
                    cargo: request.cargo,
                    fechaAprobacion: request.fechaAprobacion,
                    aprobadoPor: request.aprobadoPor,
                    estado: 'ACTIVO',
                    codigoAcceso: accessCode, // Código de 4 dígitos
                    fechaGeneracionCodigo: new Date().toISOString()
                };

                approvedUsers.push(approvedUser);

                // Guardar en localStorage
                localStorage.setItem('hospital_approved_users', JSON.stringify(approvedUsers));
                localStorage.setItem('hospital_access_requests', JSON.stringify(accessRequests));

                // Mostrar código generado
                showAccessCodeModal(approvedUser);

                // Actualizar interfaz
                updateAccessDisplay();
                updateAccessCounters();
                checkForPendingAccess();
            }
        }

        function showAccessCodeModal(user) {
            const modalHTML = `
                <div id="access-code-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🎉</div>
                        <h2 style="color: #1f2937; margin-bottom: 1rem;">¡Acceso Aprobado Exitosamente!</h2>
                        
                        <div style="background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); padding: 1rem; border-radius: 0.75rem; margin: 1rem 0; border: 2px solid #2563eb;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">👤 Usuario: ${user.nombreCompleto}</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">📧 ${user.email}</div>
                        </div>
                        
                        <div class="access-code-display">
                            <div class="access-code-label">🔢 CÓDIGO DE ACCESO GENERADO</div>
                            <div class="access-code-number">${user.codigoAcceso}</div>
                            <div class="access-code-info">Este código debe ser proporcionado al usuario para acceder al Portal de Solicitudes</div>
                        </div>
                        
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border-left: 3px solid #22c55e;">
                            <div style="font-weight: 600; color: #15803d; margin-bottom: 0.5rem;">✅ Instrucciones para el Usuario:</div>
                            <div style="font-size: 0.875rem; color: #15803d; text-align: left;">
                                <p>1. Ir al Portal de Solicitudes</p>
                                <p>2. Usar su email: <strong>${user.email}</strong></p>
                                <p>3. Ingresar el código: <strong>${user.codigoAcceso}</strong></p>
                                <p>4. ¡Ya puede crear solicitudes de mantenimiento!</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="copyAccessCode('${user.codigoAcceso}')">
                                📋 Copiar Código
                            </button>
                            <button class="btn btn-success" onclick="closeAccessCodeModal()">
                                ✅ Entendido
                            </button>
                        </div>
                        
                        <div style="margin-top: 1rem; font-size: 0.75rem; color: #6b7280;">
                            📅 Generado: ${new Date().toLocaleString('es-CO')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function copyAccessCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert(`📋 Código ${code} copiado al portapapeles`);
            }).catch(() => {
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`📋 Código ${code} copiado al portapapeles`);
            });
        }

        function closeAccessCodeModal() {
            const modal = document.getElementById('access-code-modal');
            if (modal) {
                modal.remove();
            }
        }

        function updateApprovedUsersList() {
            const container = document.getElementById('approved-users-list');
            
            if (approvedUsers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
                        <h4>No hay usuarios aprobados</h4>
                        <p style="font-size: 0.875rem;">Los usuarios aprobados aparecerán aquí</p>
                    </div>
                `;
            } else {
                const usersHTML = approvedUsers
                    .sort((a, b) => new Date(b.fechaAprobacion) - new Date(a.fechaAprobacion))
                    .map(user => createApprovedUserCard(user))
                    .join('');
                
                container.innerHTML = usersHTML;
            }
        }

        function createApprovedUserCard(user) {
            return `
                <div class="request-card" style="border-left: 4px solid #059669; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                    <div class="request-header">
                        <div class="request-number">✅ ${user.nombreCompleto}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-completada">ACTIVO</span>
                            <div style="background: #2563eb; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">${user.id}</div>
                        </div>
                    </div>
                    
                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">📧 Email</div>
                            <div class="request-detail-value">${user.email}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">🏥 Servicio</div>
                            <div class="request-detail-value">${user.servicioHospitalario}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">👔 Cargo</div>
                            <div class="request-detail-value">${user.cargo}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">📞 Teléfono</div>
                            <div class="request-detail-value">${user.telefono || 'No registrado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">📅 Aprobado</div>
                            <div class="request-detail-value">${new Date(user.fechaAprobacion).toLocaleString('es-CO')}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">👤 Por</div>
                            <div class="request-detail-value">${user.aprobadoPor}</div>
                        </div>
                    </div>

                    <div class="access-code-display">
                        <div class="access-code-label">🔢 CÓDIGO DE ACCESO ACTUAL</div>
                        <div class="access-code-number">${user.codigoAcceso || 'Sin código'}</div>
                        <div class="access-code-info">Generado: ${user.fechaGeneracionCodigo ? new Date(user.fechaGeneracionCodigo).toLocaleString('es-CO') : 'No disponible'}</div>
                    </div>

                    <div class="request-actions">
                        <button class="btn btn-primary btn-sm" onclick="regenerateCode('${user.id}')">
                            🔄 Regenerar Código
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="copyAccessCode('${user.codigoAcceso}')">
                            📋 Copiar Código
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="viewUserActivity('${user.id}')">
                            📊 Ver Actividad
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="revokeAccess('${user.id}')">
                            🚫 Revocar Acceso
                        </button>
                    </div>
                </div>
            `;
        }

        function regenerateCode(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) {
                alert('❌ Usuario no encontrado');
                return;
            }

            const confirmation = confirm(`¿Regenerar código de acceso para ${user.nombreCompleto}?\n\n⚠️ El código actual será invalidado y se generará uno nuevo.\n\nCódigo actual: ${user.codigoAcceso}`);
            
            if (confirmation) {
                const newCode = generateAccessCode();
                const oldCode = user.codigoAcceso;
                
                user.codigoAcceso = newCode;
                user.fechaGeneracionCodigo = new Date().toISOString();
                user.codigoAnterior = oldCode;
                
                localStorage.setItem('hospital_approved_users', JSON.stringify(approvedUsers));
                
                alert(`🔄 Código regenerado exitosamente\n\n👤 Usuario: ${user.nombreCompleto}\n📧 Email: ${user.email}\n🔢 Código anterior: ${oldCode}\n🔢 Código nuevo: ${newCode}\n📅 Generado: ${new Date().toLocaleString('es-CO')}\n\n💡 Proporcione el nuevo código al usuario para su próximo acceso.`);
                
                updateApprovedUsersList();
            }
        }

        function regenerateAllCodes() {
            if (approvedUsers.length === 0) {
                alert('❌ No hay usuarios aprobados para regenerar códigos');
                return;
            }

            const confirmation = confirm(`¿Regenerar TODOS los códigos de acceso?\n\n⚠️ Esto afectará a ${approvedUsers.length} usuarios.\n⚠️ Los códigos actuales serán invalidados.\n\nEsta acción no se puede deshacer.`);
            
            if (confirmation) {
                let regeneratedCount = 0;
                const now = new Date().toISOString();
                
                approvedUsers.forEach(user => {
                    const oldCode = user.codigoAcceso;
                    const newCode = generateAccessCode();
                    
                    user.codigoAcceso = newCode;
                    user.fechaGeneracionCodigo = now;
                    user.codigoAnterior = oldCode;
                    regeneratedCount++;
                });
                
                localStorage.setItem('hospital_approved_users', JSON.stringify(approvedUsers));
                
                alert(`🔄 Regeneración masiva completada\n\n📊 Códigos regenerados: ${regeneratedCount}\n📅 Fecha: ${new Date().toLocaleString('es-CO')}\n\n💡 Todos los usuarios necesitarán sus nuevos códigos para acceder.`);
                
                updateApprovedUsersList();
            }
        }

        function updateAccessCounters() {
            const pendingCount = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
            const approvedCount = approvedUsers.length;
            const rejectedCount = rejectedUsers.length;
            const totalUsers = approvedCount;

            // Actualizar métricas
            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('pending-access').textContent = pendingCount;
            document.getElementById('approved-users').textContent = approvedCount;
            document.getElementById('rejected-users').textContent = rejectedCount;

            // Actualizar navegación
            document.getElementById('pending-access-count').textContent = pendingCount;
        }

        function checkForPendingAccess() {
            const pendingCount = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
            const urgentCount = accessRequests.filter(req => req.estado === 'PENDIENTE' && req.esUrgente).length;
            
            const alertsContainer = document.getElementById('access-alerts');
            
            if (pendingCount > 0) {
                alertsContainer.innerHTML = `
                    <div class="alert ${urgentCount > 0 ? 'alert-danger' : 'alert-warning'}">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">${urgentCount > 0 ? '🚨 SOLICITUDES URGENTES DE ACCESO' : '⏳ SOLICITUDES DE ACCESO PENDIENTES'}</h3>
                        <p><strong>${pendingCount} solicitudes</strong> requieren revisión para acceso al Portal de Solicitudes:</p>
                        ${urgentCount > 0 ? `<p style="color: #dc2626; font-weight: 600;">• ${urgentCount} solicitudes marcadas como URGENTES</p>` : ''}
                        <p>• ${pendingCount - urgentCount} solicitudes normales</p>
                        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn ${urgentCount > 0 ? 'btn-danger' : 'btn-warning'} btn-sm" onclick="showView('accesos')">
                                🔐 Revisar Solicitudes
                            </button>
                            <button class="btn btn-success btn-sm" onclick="approveAllPending()">
                                ✅ Aprobar Todas
                            </button>
                        </div>
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = '';
            }
        }

        // ===== FUNCIONES DE VISUALIZACIÓN =====
        function updateAllCounters() {
            console.log('📊 Actualizando contadores...');
            
            // Contadores de solicitudes por área
            const total = solicitudesFromPortal.length;
            const biomedica = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INGENIERIA_BIOMEDICA').length;
            const mecanica = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'MECANICA').length;
            const infraestructura = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INFRAESTRUCTURA').length;
            const pendientes = solicitudesFromPortal.filter(r => r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado).length;

            // Actualizar métricas del dashboard
            document.getElementById('metric-total').textContent = total;
            document.getElementById('metric-biomedica').textContent = biomedica;
            document.getElementById('metric-mecanica').textContent = mecanica;
            document.getElementById('metric-infraestructura').textContent = infraestructura;
            document.getElementById('metric-pendientes').textContent = pendientes;

            // Actualizar navegación
            document.getElementById('total-count').textContent = total;
            document.getElementById('notification-count').textContent = pendientes;

            // Actualizar tabs de área
            document.getElementById('tab-biomedica-count').textContent = biomedica;
            document.getElementById('tab-mecanica-count').textContent = mecanica;
            document.getElementById('tab-infraestructura-count').textContent = infraestructura;

            // Contadores de técnicos
            updateTechnicianCounters();
            
            console.log(`📊 Contadores actualizados: Total=${total}, Pendientes=${pendientes}`);
        }

        function updateTechnicianCounters() {
            // Contar totales por área
            const biomedica = tecnicosPorArea['INGENIERIA_BIOMEDICA'].length;
            const mecanica = tecnicosPorArea['MECANICA'].length;
            const infraestructura = tecnicosPorArea['INFRAESTRUCTURA'].length;
            const total = biomedica + mecanica + infraestructura;

            // Actualizar contadores en headers de área
            document.getElementById('biomedica-total').textContent = `${biomedica} ingenieros/técnicos`;
            document.getElementById('mecanica-total').textContent = `${mecanica} ingenieros/técnicos`;
            document.getElementById('infraestructura-total').textContent = `${infraestructura} ingenieros/técnicos`;

            // Actualizar contadores en dashboard
            document.getElementById('biomedica-personnel-count').textContent = `${biomedica} registrados`;
            document.getElementById('mecanica-personnel-count').textContent = `${mecanica} registrados`;
            document.getElementById('infraestructura-personnel-count').textContent = `${infraestructura} registrados`;

            // Actualizar navegación
            document.getElementById('total-technicians-nav').textContent = total;

            // Contar por tipo y estado
            let totalEngineers = 0;
            let totalTechnicians = 0;
            let availableCount = 0;
            let busyCount = 0;
            let inactiveCount = 0;

            Object.values(tecnicosPorArea).forEach(areaList => {
                areaList.forEach(tech => {
                    if (tech.tipo === 'INGENIERO') totalEngineers++;
                    else totalTechnicians++;

                    if (tech.estado === 'disponible') availableCount++;
                    else if (tech.estado === 'ocupado') busyCount++;
                    else if (tech.estado === 'inactivo') inactiveCount++;
                });
            });

            // Actualizar estadísticas
            document.getElementById('total-technicians').textContent = total;
            document.getElementById('total-engineers').textContent = totalEngineers;
            document.getElementById('total-technicians-only').textContent = totalTechnicians;
            document.getElementById('available-technicians').textContent = availableCount;
            document.getElementById('busy-technicians').textContent = busyCount;
            document.getElementById('inactive-technicians').textContent = inactiveCount;

            // Actualizar resúmenes de personal en dashboard
            updatePersonnelSummaries();
        }

        function updatePersonnelSummaries() {
            const areas = [
                { key: 'INGENIERIA_BIOMEDICA', name: 'biomedica' },
                { key: 'MECANICA', name: 'mecanica' },
                { key: 'INFRAESTRUCTURA', name: 'infraestructura' }
            ];

            areas.forEach(area => {
                const personnel = tecnicosPorArea[area.key];
                const summaryContainer = document.getElementById(`${area.name}-personnel-summary`);
                
                if (personnel.length === 0) {
                    summaryContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No hay personal registrado</p>';
                } else {
                    const available = personnel.filter(p => p.estado === 'disponible').length;
                    const busy = personnel.filter(p => p.estado === 'ocupado').length;
                    const inactive = personnel.filter(p => p.estado === 'inactivo').length;
                    
                    summaryContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                            <div>
                                <div style="font-weight: bold; color: #059669;">${available}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Disponibles</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #f59e0b;">${busy}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Ocupados</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #ef4444;">${inactive}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Inactivos</div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function updateRequestsDisplay() {
            const container = document.getElementById('solicitudes-list');
            
            if (solicitudesFromPortal.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">📋</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes registradas</h3>
                        <p style="margin-bottom: 1.5rem;">Las solicitudes aparecerán aquí cuando lleguen del Portal de Solicitudes</p>
                        <button class="btn btn-primary" onclick="forceSyncRequests()">
                            🔄 Sincronizar con Portal de Solicitudes
                        </button>
                    </div>
                `;
            } else {
                const requestsHTML = solicitudesFromPortal
                    .sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion))
                    .map(request => createRequestCard(request))
                    .join('');
                
                container.innerHTML = requestsHTML;
            }
        }

        function createRequestCard(request) {
            const estadoClass = getStatusClass(request.estadoGestion || request.estado);
            const areaInfo = request.servicioIngenieria ? serviciosIngenieria[request.servicioIngenieria] : 'Sin especificar';
            const iconoArea = request.servicioIngenieria ? iconosIngenieria[request.servicioIngenieria] : '🔧';
            const prioridadColor = getPriorityColor(request.prioridad);
            
            return `
                <div class="request-card ${getRequestCardClass(request.estadoGestion || request.estado)}">
                    <div class="request-header">
                        <div class="request-number">📋 ${request.numero}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="status-${estadoClass}">${(request.estadoGestion || request.estado).replace('_', ' ')}</span>
                            <span style="background: ${prioridadColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;">
                                ${request.prioridad}
                            </span>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.25rem;">${iconoArea}</span>
                            <strong style="color: #1f2937;">Área: ${areaInfo}</strong>
                        </div>
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            <strong>Tipo:</strong> ${request.tipoServicio?.replace('_', ' ') || 'No especificado'} |
                            <strong>Tiempo estimado:</strong> ${request.tiempoEstimado || 'No especificado'}
                        </div>
                    </div>

                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">🏥 Servicio Hospitalario</div>
                            <div class="request-detail-value">${request.servicioHospitalario || request.servicioSolicitante || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">👤 Solicitante</div>
                            <div class="request-detail-value">${request.solicitante || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">🖥️ Equipo/Sistema</div>
                            <div class="request-detail-value">${request.equipo || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">📍 Ubicación</div>
                            <div class="request-detail-value">${request.ubicacion || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">📅 Fecha Creación</div>
                            <div class="request-detail-value">${request.fechaCreacion || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">👨‍🔧 Técnico Asignado</div>
                            <div class="request-detail-value">${request.tecnicoAsignado || '<span style="color: #f59e0b;">Pendiente de asignación</span>'}</div>
                        </div>
                    </div>

                    <div style="margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border-left: 3px solid #2563eb;">
                        <div class="request-detail-label">📝 Descripción del Problema</div>
                        <div style="margin-top: 0.5rem; color: #1f2937;">${request.descripcion || 'No especificada'}</div>
                        ${request.observaciones ? `<div style="margin-top: 0.5rem; font-style: italic; color: #6b7280;"><strong>Observaciones:</strong> ${request.observaciones}</div>` : ''}
                    </div>

                    <div class="request-actions">
                        ${!request.tecnicoAsignado ? `
                            <button class="btn btn-success btn-sm" onclick="assignTechnicianToRequest('${request.numero}')">
                                👨‍🔧 Asignar Técnico
                            </button>
                        ` : ''}
                        <button class="btn btn-primary btn-sm" onclick="viewRequestDetails('${request.numero}')">
                            👁️ Ver Detalles
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="updateRequestStatus('${request.numero}')">
                            🔄 Cambiar Estado
                        </button>
                        ${request.tecnicoAsignado ? `
                            <button class="btn btn-secondary btn-sm" onclick="reassignRequest('${request.numero}')">
                                🔄 Reasignar
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            const statusMap = {
                'PENDIENTE': 'pendiente',
                'ASIGNADA': 'asignada',
                'EN_PROCESO': 'proceso',
                'COMPLETADA': 'completada'
            };
            return statusMap[status] || 'pendiente';
        }

        function getRequestCardClass(status) {
            const classMap = {
                'PENDIENTE': 'pending',
                'ASIGNADA': 'assigned',
                'EN_PROCESO': 'assigned',
                'COMPLETADA': 'completed'
            };
            return classMap[status] || 'pending';
        }

        function getPriorityColor(priority) {
            const colorMap = {
                'CRITICA': '#ef4444',
                'ALTA': '#f59e0b',
                'MEDIA': '#3b82f6',
                'BAJA': '#059669'
            };
            return colorMap[priority] || '#6b7280';
        }

        function updateAreaTabs() {
            // Esta función se llama para actualizar las pestañas de área
            // Por ahora simplemente actualiza los contadores que ya se actualizan en updateAllCounters
            console.log('📊 Actualizando tabs de área...');
        }

        function updateRejectedUsersList() {
            const container = document.getElementById('rejected-users-list');
            
            if (rejectedUsers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                        <h4>No hay accesos rechazados</h4>
                        <p style="font-size: 0.875rem;">El historial de rechazos aparecerá aquí</p>
                    </div>
                `;
            } else {
                const usersHTML = rejectedUsers
                    .sort((a, b) => new Date(b.fechaRechazo) - new Date(a.fechaRechazo))
                    .map(user => createRejectedUserCard(user))
                    .join('');
                
                container.innerHTML = usersHTML;
            }
        }

        function createRejectedUserCard(user) {
            return `
                <div class="technician-card" style="border-left: 4px solid #ef4444; background: #fef2f2;">
                    <div class="technician-header">
                        <div class="technician-name">❌ ${user.nombreCompleto}</div>
                        <span class="status-inactivo">RECHAZADO</span>
                    </div>
                    <div class="technician-details">
                        <div class="technician-detail">
                            <span>🏥</span>
                            <span>${user.servicioHospitalario}</span>
                        </div>
                        <div class="technician-detail">
                            <span>👔</span>
                            <span>${user.cargo}</span>
                        </div>
                        <div class="technician-detail">
                            <span>📧</span>
                            <span>${user.email}</span>
                        </div>
                        <div class="technician-detail">
                            <span>📅</span>
                            <span>${new Date(user.fechaRechazo).toLocaleString('es-CO')}</span>
                        </div>
                    </div>
                    <div style="margin: 1rem 0; padding: 0.75rem; background: #fee2e2; border-radius: 0.5rem; border-left: 3px solid #ef4444;">
                        <div style="font-weight: 600; color: #dc2626; margin-bottom: 0.25rem;">Motivo del Rechazo:</div>
                        <div style="color: #dc2626; font-size: 0.875rem;">${user.motivoRechazo}</div>
                    </div>
                    <div class="technician-actions">
                        <button class="btn btn-success btn-sm" onclick="reconsiderAccess('${user.id}')">
                            🔄 Reconsiderar
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="removeFromRejected('${user.id}')">
                            🗑️ Eliminar del Historial
                        </button>
                    </div>
                </div>
            `;
        }

        // ===== FUNCIONES DE GESTIÓN DE TÉCNICOS =====
        function showAddTechnicianModal(area = '') {
            const modalHTML = `
                <div id="add-technician-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">➕ Agregar Nuevo Ingeniero/Técnico</h3>
                            <button class="modal-close" onclick="closeAddTechnicianModal()">✕</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <form id="add-technician-form">
                                <div class="form-group">
                                    <label class="form-label">🔧 Área de Ingeniería *</label>
                                    <select id="tech-area" class="form-select" required>
                                        <option value="">Seleccionar área</option>
                                        <option value="INGENIERIA_BIOMEDICA" ${area === 'INGENIERIA_BIOMEDICA' ? 'selected' : ''}>🏥 Ingeniería Biomédica</option>
                                        <option value="MECANICA" ${area === 'MECANICA' ? 'selected' : ''}>⚙️ Mecánica</option>
                                        <option value="INFRAESTRUCTURA" ${area === 'INFRAESTRUCTURA' ? 'selected' : ''}>🏗️ Infraestructura</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">👨‍🎓 Tipo de Personal *</label>
                                    <select id="tech-type" class="form-select" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="INGENIERO">🎓 Ingeniero (Título Profesional)</option>
                                        <option value="TECNICO">🔧 Técnico Especializado</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">👤 Nombre Completo *</label>
                                    <input type="text" id="tech-name" class="form-input" required placeholder="Ej: María García Rodríguez (sin prefijo Ing./Téc.)">
                                    <small style="color: #6b7280; font-size: 0.75rem;">El prefijo se agregará automáticamente según el tipo seleccionado</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">🎓 Especialidad/Área de Expertise *</label>
                                    <input type="text" id="tech-specialty" class="form-input" required placeholder="Ej: Equipos Críticos y Ventilación Mecánica">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">📞 Teléfono de Contacto *</label>
                                    <input type="tel" id="tech-phone" class="form-input" required placeholder="+57 300 123 4567">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">📧 Email Institucional *</label>
                                    <input type="email" id="tech-email" class="form-input" required placeholder="nombre.apellido@hospital.com">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">📋 Estado Inicial</label>
                                    <select id="tech-status" class="form-select">
                                        <option value="disponible">✅ Disponible (Puede recibir asignaciones)</option>
                                        <option value="ocupado">⏳ Ocupado (Tiene trabajo asignado)</option>
                                        <option value="inactivo">❌ Inactivo (Fuera de servicio)</option>
                                    </select>
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; font-size: 0.875rem; border-left: 3px solid #2563eb;">
                                    <h4 style="color: #1e40af; margin-bottom: 0.5rem;">💡 Información</h4>
                                    <ul style="color: #1e40af; margin: 0; padding-left: 1rem;">
                                        <li><strong>Ingenieros:</strong> Personal con título profesional para proyectos complejos</li>
                                        <li><strong>Técnicos:</strong> Personal especializado en mantenimiento y reparación</li>
                                        <li>El personal será asignado automáticamente a solicitudes del área seleccionada</li>
                                    </ul>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
                                    <button type="button" class="btn btn-secondary" onclick="closeAddTechnicianModal()">Cancelar</button>
                                    <button type="submit" class="btn btn-success">✅ Agregar al Sistema</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Manejar envío del formulario
            document.getElementById('add-technician-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewTechnician();
            });
        }

        function addNewTechnician() {
            console.log('🔧 Iniciando addNewTechnician...');
            
            try {
                // Obtener valores del formulario con validación
                const area = document.getElementById('tech-area')?.value;
                const type = document.getElementById('tech-type')?.value;
                const name = document.getElementById('tech-name')?.value?.trim();
                const specialty = document.getElementById('tech-specialty')?.value?.trim();
                const phone = document.getElementById('tech-phone')?.value?.trim();
                const email = document.getElementById('tech-email')?.value?.trim();
                const status = document.getElementById('tech-status')?.value || 'disponible';

                console.log('📋 Datos del formulario:', { area, type, name, specialty, phone, email, status });

                // Validación de campos obligatorios
                if (!area) {
                    alert('❌ Por favor seleccione un área de ingeniería');
                    return false;
                }
                if (!type) {
                    alert('❌ Por favor seleccione el tipo de personal');
                    return false;
                }
                if (!name) {
                    alert('❌ Por favor ingrese el nombre completo');
                    return false;
                }
                if (!specialty) {
                    alert('❌ Por favor ingrese la especialidad');
                    return false;
                }
                if (!phone) {
                    alert('❌ Por favor ingrese el teléfono de contacto');
                    return false;
                }
                if (!email) {
                    alert('❌ Por favor ingrese el email');
                    return false;
                }

                // Validar formato de email
                if (!email.includes('@') || !email.includes('.')) {
                    alert('❌ Por favor ingrese un email válido (debe contener @ y .)');
                    return false;
                }

                // Generar ID único
                let areaPrefix;
                switch(area) {
                    case 'INGENIERIA_BIOMEDICA':
                        areaPrefix = 'IB';
                        break;
                    case 'MECANICA':
                        areaPrefix = 'ME';
                        break;
                    case 'INFRAESTRUCTURA':
                        areaPrefix = 'IN';
                        break;
                    default:
                        areaPrefix = 'XX';
                }

                // Asegurar que el array existe
                if (!tecnicosPorArea[area]) {
                    tecnicosPorArea[area] = [];
                    console.log(`📝 Creado array para área: ${area}`);
                }

                const existingIds = tecnicosPorArea[area].map(t => t.id);
                let newId = 1;
                let techId;
                do {
                    techId = `${areaPrefix}${String(newId).padStart(3, '0')}`;
                    newId++;
                } while (existingIds.includes(techId));

                console.log(`🆔 ID generado: ${techId}`);

                // Agregar prefijo al nombre según el tipo
                const prefix = type === 'INGENIERO' ? 'Ing.' : 'Téc.';
                const fullName = `${prefix} ${name}`;

                // Crear nuevo técnico/ingeniero
                const newTechnician = {
                    id: techId,
                    nombre: fullName,
                    tipo: type,
                    especialidad: specialty,
                    telefono: phone,
                    email: email,
                    disponible: status === 'disponible',
                    estado: status,
                    fechaCreacion: new Date().toLocaleString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                };

                console.log('👤 Nuevo técnico creado:', newTechnician);

                // Agregar a la lista
                tecnicosPorArea[area].push(newTechnician);
                console.log(`✅ Técnico agregado a ${area}. Total en área: ${tecnicosPorArea[area].length}`);
                console.log('📊 Estado completo tecnicosPorArea:', tecnicosPorArea);

                // Cerrar modal
                closeAddTechnicianModal();

                // Mostrar confirmación
                const areaName = area === 'INGENIERIA_BIOMEDICA' ? 'Ingeniería Biomédica' : 
                                area === 'MECANICA' ? 'Mecánica' : 'Infraestructura';
                const typeText = type === 'INGENIERO' ? 'Ingeniero' : 'Técnico';
                
                alert(`✅ ${typeText} ${name} agregado exitosamente al área de ${areaName}\n\n🆔 ID asignado: ${techId}\n📧 Email: ${email}\n📞 Teléfono: ${phone}\n📅 Fecha: ${newTechnician.fechaCreacion}`);
                
                // Actualizar la interfaz
                console.log('🔄 Actualizando interfaz...');
                updateTechniciansDisplay();
                updateAllCounters();
                console.log('✅ Interfaz actualizada');

                return true;

            } catch (error) {
                console.error('❌ Error en addNewTechnician:', error);
                alert(`❌ Error al agregar el técnico: ${error.message}`);
                return false;
            }
        }

        function updateTechniciansDisplay() {
            console.log('🔄 Iniciando updateTechniciansDisplay...');
            console.log('📊 Estado actual tecnicosPorArea:', tecnicosPorArea);
            
            try {
                // Actualizar la lista de técnicos para cada área
                const areas = [
                    { key: 'INGENIERIA_BIOMEDICA', name: 'biomedica', display: 'ingeniería biomédica', icon: '🏥' },
                    { key: 'MECANICA', name: 'mecanica', display: 'mecánica', icon: '⚙️' },
                    { key: 'INFRAESTRUCTURA', name: 'infraestructura', display: 'infraestructura', icon: '🏗️' }
                ];
                
                areas.forEach(area => {
                    console.log(`🔧 Procesando área: ${area.key}`);
                    
                    const technicians = tecnicosPorArea[area.key] || [];
                    console.log(`👥 Técnicos en ${area.key}: ${technicians.length}`, technicians);
                    
                    const listContainer = document.getElementById(`${area.name}-technicians-list`);
                    
                    if (!listContainer) {
                        console.warn(`⚠️ No se encontró el contenedor: ${area.name}-technicians-list`);
                        return;
                    }
                    
                    if (technicians.length === 0) {
                        // Mostrar mensaje de "no hay técnicos"
                        listContainer.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">${area.icon}</div>
                                <h4>No hay ingenieros ni técnicos registrados</h4>
                                <p style="font-size: 0.875rem;">Comience agregando personal especializado en ${area.display}</p>
                                <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('${area.key}')" style="margin-top: 1rem;">
                                    ➕ Agregar Primer Ingeniero/Técnico
                                </button>
                            </div>
                        `;
                        console.log(`📝 Mostrando mensaje vacío para ${area.key}`);
                    } else {
                        // Mostrar la lista de técnicos
                        const techniciansHTML = technicians.map(tech => createTechnicianCard(tech, area.key)).join('');
                        listContainer.innerHTML = techniciansHTML;
                        console.log(`📋 Mostrando ${technicians.length} técnicos para ${area.key}`);
                    }
                });
                
                console.log('✅ updateTechniciansDisplay completado');
                
            } catch (error) {
                console.error('❌ Error en updateTechniciansDisplay:', error);
                alert(`❌ Error al actualizar la visualización: ${error.message}`);
            }
        }

        function createTechnicianCard(tech, area) {
            try {
                console.log(`🎨 Creando tarjeta para técnico:`, tech);
                
                const statusClass = `status-${tech.estado}`;
                const typeIcon = tech.tipo === 'INGENIERO' ? '🎓' : '🔧';
                
                return `
                    <div class="technician-card">
                        <div class="technician-header">
                            <div class="technician-name">${typeIcon} ${tech.nombre}</div>
                            <div class="technician-id">${tech.id}</div>
                        </div>
                        <div class="technician-details">
                            <div class="technician-detail">
                                <span>🎯</span>
                                <span>${tech.especialidad}</span>
                            </div>
                            <div class="technician-detail">
                                <span>📞</span>
                                <span>${tech.telefono}</span>
                            </div>
                            <div class="technician-detail">
                                <span>📧</span>
                                <span>${tech.email}</span>
                            </div>
                            <div class="technician-detail">
                                <span>📅</span>
                                <span>${tech.fechaCreacion}</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span class="${statusClass}">${tech.estado.charAt(0).toUpperCase() + tech.estado.slice(1)}</span>
                        </div>
                        <div class="technician-actions">
                            <button class="btn btn-primary btn-sm" onclick="editTechnician('${area}', '${tech.id}')">
                                ✏️ Editar
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="toggleTechnicianStatus('${area}', '${tech.id}')">
                                🔄 Cambiar Estado
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTechnician('${area}', '${tech.id}')">
                                🗑️ Eliminar
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('❌ Error en createTechnicianCard:', error);
                return `<div class="technician-card" style="background: #fee2e2; color: #dc2626;">
                    <p>Error al mostrar técnico: ${tech.nombre || 'Sin nombre'}</p>
                </div>`;
            }
        }

        function closeAddTechnicianModal() {
            const modal = document.getElementById('add-technician-modal');
            if (modal) {
                modal.remove();
            }
        }

        function exportTechnicians() {
            alert('📤 Función de exportación de técnicos en desarrollo');
        }

        function editTechnician(area, techId) {
            alert('✏️ Función de edición en desarrollo');
        }

        function toggleTechnicianStatus(area, techId) {
            alert('🔄 Función de cambio de estado en desarrollo');
        }

        function deleteTechnician(area, techId) {
            alert('🗑️ Función de eliminación en desarrollo');
        }

        // ===== FUNCIONES DE NAVEGACIÓN =====
        function showView(viewName) {
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.add('hidden'));
            
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const activeTab = document.querySelector(`[data-view="${viewName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // Actualizar contadores cuando se cambie de vista
            updateAllCounters();

            // Si se muestra la vista de solicitudes, asegurar que estén actualizadas
            if (viewName === 'solicitudes') {
                updateRequestsDisplay();
            }

            // Si se muestra la vista de áreas, mostrar contenido del área activa
            if (viewName === 'areas') {
                showAreaTab('biomedica');
            }

            // Si se muestra la vista de accesos, actualizar la información
            if (viewName === 'accesos') {
                updateAccessDisplay();
                updateAccessCounters();
                checkForPendingAccess();
            }
        }

        function showAreaTab(areaName) {
            // Ocultar todas las áreas
            document.querySelectorAll('.area-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Mostrar área seleccionada
            const targetArea = document.getElementById(`area-${areaName}`);
            if (targetArea) {
                targetArea.classList.remove('hidden');
            }
            
            // Actualizar tabs
            document.querySelectorAll('.area-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-area="${areaName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // Mostrar solicitudes del área
            showAreaRequests(getAreaKeyFromName(areaName));
        }

        function getAreaKeyFromName(areaName) {
            const areaMap = {
                'biomedica': 'INGENIERIA_BIOMEDICA',
                'mecanica': 'MECANICA',
                'infraestructura': 'INFRAESTRUCTURA'
            };
            return areaMap[areaName] || 'INGENIERIA_BIOMEDICA';
        }

        function showAreaRequests(areaKey) {
            const areaRequests = solicitudesFromPortal.filter(r => r.servicioIngenieria === areaKey);
            const areaNames = {
                'INGENIERIA_BIOMEDICA': 'biomedica',
                'MECANICA': 'mecanica',
                'INFRAESTRUCTURA': 'infraestructura'
            };
            
            const containerName = areaNames[areaKey];
            const container = document.getElementById(`${containerName}-requests`);
            
            if (!container) return;
            
            if (areaRequests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">${iconosIngenieria[areaKey]}</div>
                        <h4>No hay solicitudes para ${serviciosIngenieria[areaKey]}</h4>
                        <p style="font-size: 0.875rem;">Las solicitudes aparecerán aquí cuando lleguen del Portal de Solicitudes</p>
                        <button class="btn btn-primary btn-sm" onclick="forceSyncRequests()" style="margin-top: 1rem;">
                            🔄 Sincronizar Solicitudes
                        </button>
                    </div>
                `;
            } else {
                const requestsHTML = areaRequests
                    .sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion))
                    .map(request => createRequestCard(request))
                    .join('');
                
                container.innerHTML = requestsHTML;
            }
        }

        // ===== FUNCIONES ADICIONALES =====
        function filterByArea(area) {
            console.log(`Filtrando por área: ${area}`);
            // Implementar filtrado si es necesario
        }

        function filterByStatus(status) {
            console.log(`Filtrando por estado: ${status}`);
            // Implementar filtrado si es necesario
        }

        function showNotifications() {
            const totalPersonnel = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            const pendingRequests = solicitudesFromPortal.filter(r => r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado).length;
            const criticalRequests = solicitudesFromPortal.filter(r => r.prioridad === 'CRITICA' && (r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado)).length;
            const pendingAccess = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
            const urgentAccess = accessRequests.filter(req => req.estado === 'PENDIENTE' && req.esUrgente).length;
            
            alert(`🔔 NOTIFICACIONES DEL SISTEMA\n\n📊 ESTADO ACTUAL:\n• ${solicitudesFromPortal.length} Solicitudes de mantenimiento totales\n• ${pendingRequests} Solicitudes pendientes de asignación\n• ${criticalRequests} Solicitudes críticas sin asignar\n• ${totalPersonnel} Ingenieros/Técnicos registrados\n\n🔐 GESTIÓN DE ACCESOS:\n• ${pendingAccess} Solicitudes de acceso pendientes\n• ${urgentAccess} Solicitudes de acceso urgentes\n• ${approvedUsers.length} Usuarios con acceso aprobado\n\n${lastSyncTime ? `🔄 Última sincronización: ${lastSyncTime.toLocaleTimeString('es-CO')}` : '⚠️ Sin sincronización reciente'}\n\n${criticalRequests > 0 ? '🚨 ¡HAY SOLICITUDES CRÍTICAS QUE REQUIEREN ATENCIÓN INMEDIATA!' : ''}${urgentAccess > 0 ? '\n🔐 ¡HAY SOLICITUDES DE ACCESO URGENTES!' : ''}${(criticalRequests === 0 && urgentAccess === 0) ? '✅ Sistema funcionando normalmente' : ''}`);
        }

        function generateDepartmentReport() {
            const totalRequests = solicitudesFromPortal.length;
            const totalPersonnel = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            
            const reportData = {
                biomedica: {
                    requests: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INGENIERIA_BIOMEDICA').length,
                    personnel: tecnicosPorArea['INGENIERIA_BIOMEDICA'].length,
                    pending: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INGENIERIA_BIOMEDICA' && (r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado)).length
                },
                mecanica: {
                    requests: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'MECANICA').length,
                    personnel: tecnicosPorArea['MECANICA'].length,
                    pending: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'MECANICA' && (r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado)).length
                },
                infraestructura: {
                    requests: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INFRAESTRUCTURA').length,
                    personnel: tecnicosPorArea['INFRAESTRUCTURA'].length,
                    pending: solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INFRAESTRUCTURA' && (r.estadoGestion === 'PENDIENTE' || !r.tecnicoAsignado)).length
                }
            };

            alert(`📊 REPORTE DEPARTAMENTAL GENERADO\n\n📋 RESUMEN GENERAL:\n• Total solicitudes: ${totalRequests}\n• Total personal: ${totalPersonnel}\n• Pendientes: ${reportData.biomedica.pending + reportData.mecanica.pending + reportData.infraestructura.pending}\n\n🏥 INGENIERÍA BIOMÉDICA:\n• Solicitudes: ${reportData.biomedica.requests}\n• Personal: ${reportData.biomedica.personnel}\n• Pendientes: ${reportData.biomedica.pending}\n\n⚙️ MECÁNICA:\n• Solicitudes: ${reportData.mecanica.requests}\n• Personal: ${reportData.mecanica.personnel}\n• Pendientes: ${reportData.mecanica.pending}\n\n🏗️ INFRAESTRUCTURA:\n• Solicitudes: ${reportData.infraestructura.requests}\n• Personal: ${reportData.infraestructura.personnel}\n• Pendientes: ${reportData.infraestructura.pending}`);
        }

        function exportDepartmentStats() {
            alert('📤 Estadísticas departamentales exportadas correctamente');
        }

        // Funciones adicionales para gestión de accesos
        function showAddUserModal() {
            const modalHTML = `
                <div id="add-user-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">➕ Agregar Usuario Manualmente</h3>
                            <button class="modal-close" onclick="closeAddUserModal()">✕</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <form id="add-user-form">
                                <div class="form-group">
                                    <label class="form-label">👤 Nombre Completo *</label>
                                    <input type="text" id="user-name" class="form-input" required placeholder="Ej: Dr. María García López">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">📧 Email *</label>
                                    <input type="email" id="user-email" class="form-input" required placeholder="maria.garcia@hospital.com">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">📞 Teléfono</label>
                                    <input type="tel" id="user-phone" class="form-input" placeholder="+57 300 123 4567">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">🆔 Número de Documento *</label>
                                    <input type="text" id="user-document" class="form-input" required placeholder="12345678">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">🏥 Servicio Hospitalario *</label>
                                    <select id="user-service" class="form-select" required>
                                        <option value="">Seleccionar servicio</option>
                                        <option value="URGENCIAS">Urgencias</option>
                                        <option value="CIRUGIA">Cirugía</option>
                                        <option value="MEDICINA_INTERNA">Medicina Interna</option>
                                        <option value="PEDIATRIA">Pediatría</option>
                                        <option value="GINECOLOGIA">Ginecología</option>
                                        <option value="ORTOPEDIA">Ortopedia</option>
                                        <option value="UCI">Unidad de Cuidados Intensivos</option>
                                        <option value="LABORATORIO">Laboratorio</option>
                                        <option value="RADIOLOGIA">Radiología</option>
                                        <option value="FARMACIA">Farmacia</option>
                                        <option value="MANTENIMIENTO">Mantenimiento</option>
                                        <option value="SISTEMAS">Sistemas</option>
                                        <option value="ADMINISTRACION">Administración</option>
                                        <option value="OTRO">Otro</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">👔 Cargo/Función *</label>
                                    <input type="text" id="user-position" class="form-input" required placeholder="Ej: Médico Especialista, Enfermero Jefe, etc.">
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; font-size: 0.875rem; border-left: 3px solid #2563eb;">
                                    <h4 style="color: #1e40af; margin-bottom: 0.5rem;">💡 Información</h4>
                                    <p style="color: #1e40af; margin: 0;">Este usuario tendrá acceso inmediato al Portal de Solicitudes con código generado automáticamente.</p>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
                                    <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">Cancelar</button>
                                    <button type="submit" class="btn btn-success">✅ Agregar Usuario</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            document.getElementById('add-user-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addUserManually();
            });
        }

        function addUserManually() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const phone = document.getElementById('user-phone').value.trim();
            const documentNumber = document.getElementById('user-document').value.trim();
            const service = document.getElementById('user-service').value;
            const position = document.getElementById('user-position').value.trim();

            if (!name || !email || !documentNumber || !service || !position) {
                alert('❌ Por favor complete todos los campos obligatorios');
                return;
            }

            // Verificar si el email ya existe
            const existingUser = approvedUsers.find(user => user.email === email);
            if (existingUser) {
                alert('❌ Ya existe un usuario con ese email');
                return;
            }

            // Generar ID único y código de acceso
            const userId = `USR${Date.now()}`;
            const accessCode = generateAccessCode();

            const newUser = {
                id: userId,
                nombreCompleto: name,
                email: email,
                telefono: phone,
                numeroDocumento: documentNumber,
                servicioHospitalario: service,
                cargo: position,
                fechaAprobacion: new Date().toISOString(),
                aprobadoPor: 'Agregado Manualmente',
                estado: 'ACTIVO',
                codigoAcceso: accessCode,
                fechaGeneracionCodigo: new Date().toISOString()
            };

            approvedUsers.push(newUser);
            localStorage.setItem('hospital_approved_users', JSON.stringify(approvedUsers));

            closeAddUserModal();
            
            // Mostrar código generado
            showAccessCodeModal(newUser);

            updateAccessDisplay();
            updateAccessCounters();
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.remove();
            }
        }

        function viewUserActivity(userId) {
            alert('📊 Funcionalidad de actividad del usuario en desarrollo');
        }

        function revokeAccess(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (user) {
                const confirmation = confirm(`¿REVOCAR acceso de ${user.nombreCompleto}?\n\n⚠️ Su código será invalidado y no podrá acceder al Portal de Solicitudes.`);
                if (confirmation) {
                    const index = approvedUsers.findIndex(u => u.id === userId);
                    if (index > -1) {
                        approvedUsers.splice(index, 1);
                        localStorage.setItem('hospital_approved_users', JSON.stringify(approvedUsers));
                        
                        alert(`🚫 Acceso revocado para ${user.nombreCompleto}`);
                        updateApprovedUsersList();
                        updateAccessCounters();
                    }
                }
            }
        }

        function reconsiderAccess(userId) {
            const user = rejectedUsers.find(u => u.id === userId);
            if (user) {
                const confirmation = confirm(`¿Reconsiderar y APROBAR el acceso de ${user.nombreCompleto}?\n\nEl usuario será movido a la lista de usuarios aprobados.`);
                if (confirmation) {
                    // Generar nuevo código de acceso
                    const accessCode = generateAccessCode();
                    
                    // Mover a usuarios aprobados
                    const approvedUser = {
                        id: user.id,
                        nombreCompleto: user.nombreCompleto,
                        email: user.email,
                        telefono: user.telefono || '',
                        numeroDocumento: user.numeroDocumento || '',
                        servicioHospitalario: user.servicioHospitalario,
                        cargo: user.cargo,
                        fechaAprobacion: new Date().toISOString(),
                        aprobadoPor: 'Reconsideración Manual',
                        estado: 'ACTIVO',
                        codigoAcceso: accessCode,
                        fechaGeneracionCodigo: new Date().toISOString()
                    };

                    approvedUsers.push(approvedUser);

                    // Eliminar de rechazados
                    const index = rejectedUsers.findIndex(u => u.id === userId);
                    if (index > -1) {
                        rejectedUsers.splice(index, 1);
                    }

                    // Guardar cambios
                    localStorage.setItem('hospital_approved_users', JSON.stringify(approvedUsers));
                    localStorage.setItem('hospital_rejected_users', JSON.stringify(rejectedUsers));

                    alert(`✅ Acceso aprobado tras reconsideración para ${user.nombreCompleto}\n🔢 Nuevo código generado: ${accessCode}`);
                    
                    updateAccessDisplay();
                    updateAccessCounters();
                }
            }
        }

        function removeFromRejected(userId) {
            const user = rejectedUsers.find(u => u.id === userId);
            if (user) {
                const confirmation = confirm(`¿Eliminar del historial de rechazados a ${user.nombreCompleto}?\n\nEsto limpiará el registro pero no aprobará el acceso.`);
                if (confirmation) {
                    const index = rejectedUsers.findIndex(u => u.id === userId);
                    if (index > -1) {
                        rejectedUsers.splice(index, 1);
                        localStorage.setItem('hospital_rejected_users', JSON.stringify(rejectedUsers));
                        
                        alert(`🗑️ ${user.nombreCompleto} eliminado del historial de rechazados`);
                        updateAccessDisplay();
                        updateAccessCounters();
                    }
                }
            }
        }

        function clearRejectedHistory() {
            if (rejectedUsers.length === 0) {
                alert('📋 No hay registros de rechazos para limpiar');
                return;
            }

            const confirmation = confirm(`¿Limpiar completamente el historial de ${rejectedUsers.length} accesos rechazados?\n\n⚠️ Esta acción no se puede deshacer.`);
            if (confirmation) {
                rejectedUsers = [];
                localStorage.setItem('hospital_rejected_users', JSON.stringify(rejectedUsers));
                
                alert('🗑️ Historial de rechazos limpiado completamente');
                updateAccessDisplay();
                updateAccessCounters();
            }
        }

        function debugAccessRequests() {
            const debugInfo = `🔍 DEBUG - Sistema de Códigos de Acceso

📋 SOLICITUDES DE ACCESO:
• Total solicitudes: ${accessRequests.length}
• Pendientes: ${accessRequests.filter(r => r.estado === 'PENDIENTE').length}
• Aprobadas: ${accessRequests.filter(r => r.estado === 'APROBADO').length}

👥 USUARIOS APROBADOS:
• Total usuarios: ${approvedUsers.length}
• Con código: ${approvedUsers.filter(u => u.codigoAcceso).length}
• Sin código: ${approvedUsers.filter(u => !u.codigoAcceso).length}

🔢 CÓDIGOS GENERADOS:
${approvedUsers.filter(u => u.codigoAcceso).map((u, i) => `${i+1}. ${u.nombreCompleto} - ${u.email} - Código: ${u.codigoAcceso}`).join('\n')}

🔧 ESTADO TÉCNICO:
• localStorage: hospital_access_requests, hospital_approved_users
• Generación: Códigos únicos de 4 dígitos (1000-9999)
• Sincronización: Automática cada 5 segundos`;

            alert(debugInfo);
        }

        // Funciones adicionales simplificadas para la demo
        function assignTechnicianToRequest(requestNumber) {
            alert('👨‍🔧 Función de asignación de técnicos en desarrollo - Requiere técnicos registrados');
        }

        function viewRequestDetails(requestNumber) {
            alert('👁️ Función de detalles de solicitud en desarrollo');
        }

        function updateRequestStatus(requestNumber) {
            alert('🔄 Función de cambio de estado en desarrollo');
        }

        function reassignRequest(requestNumber) {
            alert('🔄 Función de reasignación en desarrollo');
        }

        function assignCriticalRequests() {
            alert('🚨 Función de asignación crítica en desarrollo');
        }

        function autoAssignPending() {
            alert('🤖 Función de auto-asignación en desarrollo');
        }

        function rejectAccess(requestId) {
            const request = accessRequests.find(req => req.id === requestId);
            if (request) {
                const reason = prompt(`¿Por qué rechazar el acceso para ${request.nombreCompleto}?\n\nMotivo del rechazo:`);
                if (reason !== null && reason.trim() !== '') {
                    request.estado = 'RECHAZADO';
                    request.fechaRechazo = new Date().toISOString();
                    request.motivoRechazo = reason.trim();
                    request.rechazadoPor = 'Sistema de Gestión';
                    
                    // Agregar a usuarios rechazados
                    const rejectedUser = {
                        id: request.id,
                        nombreCompleto: request.nombreCompleto,
                        email: request.email,
                        servicioHospitalario: request.servicioHospitalario,
                        cargo: request.cargo,
                        fechaRechazo: request.fechaRechazo,
                        motivoRechazo: request.motivoRechazo,
                        rechazadoPor: request.rechazadoPor
                    };

                    rejectedUsers.push(rejectedUser);
                    
                    localStorage.setItem('hospital_access_requests', JSON.stringify(accessRequests));
                    localStorage.setItem('hospital_rejected_users', JSON.stringify(rejectedUsers));
                    
                    alert(`❌ Acceso rechazado para ${request.nombreCompleto}\nMotivo: ${reason}`);
                    updateAccessDisplay();
                    updateAccessCounters();
                    checkForPendingAccess();
                }
            }
        }

        function viewAccessDetails(requestId) {
            const request = accessRequests.find(req => req.id === requestId);
            if (request) {
                alert(`🔍 Detalles de la solicitud\n\n👤 ${request.nombreCompleto}\n📧 ${request.email}\n🏥 ${request.servicioHospitalario}\n👔 ${request.cargo}\n📅 ${new Date(request.fechaSolicitud).toLocaleString('es-CO')}\n\n📝 Justificación:\n${request.justificacion || 'No proporcionada'}`);
            }
        }

        function approveAllPending() {
            const pendingRequests = accessRequests.filter(req => req.estado === 'PENDIENTE');
            
            if (pendingRequests.length === 0) {
                alert('✅ No hay solicitudes pendientes para aprobar');
                return;
            }

            const confirmation = confirm(`¿Aprobar automáticamente ${pendingRequests.length} solicitudes?\n\n⚠️ Se generarán códigos de acceso para todos los usuarios.`);
            
            if (confirmation) {
                let approvedCount = 0;
                const now = new Date().toISOString();

                pendingRequests.forEach(request => {
                    const accessCode = generateAccessCode();
                    
                    request.estado = 'APROBADO';
                    request.fechaAprobacion = now;
                    request.aprobadoPor = 'Aprobación Masiva';
                    request.codigoGenerado = accessCode;

                    const approvedUser = {
                        id: request.id,
                        nombreCompleto: request.nombreCompleto,
                        email: request.email,
                        telefono: request.telefono,
                        numeroDocumento: request.numeroDocumento,
                        servicioHospitalario: request.servicioHospitalario,
                        cargo: request.cargo,
                        fechaAprobacion: request.fechaAprobacion,
                        aprobadoPor: request.aprobadoPor,
                        estado: 'ACTIVO',
                        codigoAcceso: accessCode,
                        fechaGeneracionCodigo: now
                    };

                    approvedUsers.push(approvedUser);
                    approvedCount++;
                });

                localStorage.setItem('hospital_approved_users', JSON.stringify(approvedUsers));
                localStorage.setItem('hospital_access_requests', JSON.stringify(accessRequests));

                alert(`✅ Aprobación masiva completada\n\n📊 Usuarios aprobados: ${approvedCount}\n🔢 Códigos generados: ${approvedCount}\n📅 Fecha: ${new Date().toLocaleString('es-CO')}`);

                updateAccessDisplay();
                updateAccessCounters();
                checkForPendingAccess();
            }
        }

        function exportUsersList() {
            alert('📤 Funcionalidad de exportación en desarrollo');
        }

        // ===== INICIALIZACIÓN AUTOMÁTICA =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Portal de Gestión Integrado con Códigos de Acceso - Hospital Susana López de Valencia');
            console.log('🔄 Iniciando sistema de sincronización automática...');
            
            // Configurar listener de localStorage para sincronización instantánea
            setupStorageListener();
            
            // Iniciar sincronización automática
            startAutoSync();
            
            // Inicializar contadores y visualizaciones
            updateTechniciansDisplay();
            
            // Inicializar gestión de accesos
            loadAccessRequests();
            updateAccessDisplay();
            updateAccessCounters();
            checkForPendingAccess();
            
            // Configurar indicador de tiempo real
            setInterval(updateSyncIndicator, 1000); // Actualizar cada segundo
            
            console.log('✅ Sistema iniciado con sincronización automática activa');
            console.log('📡 Monitoreando cambios en localStorage');
            console.log('🔄 Sincronización cada 5 segundos + eventos instantáneos');
            console.log('🔐 Sistema de gestión de accesos con códigos de 4 dígitos inicializado');
        });
    </script>
<!-- Firebase Funciones -->
<script type="module">
  import {
    getFirestore, collection, addDoc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const db = window.firebaseDB;

  // Función para guardar solicitud
  window.guardarSolicitudFirebase = async function (data) {
    try {
      await addDoc(collection(db, "solicitudes"), data);
      alert("✅ Solicitud enviada correctamente a la base de datos.");
    } catch (error) {
      console.error("❌ Error al guardar la solicitud:", error);
      alert("Error al guardar la solicitud.");
    }
  };

  // Función para cargar solicitudes en tiempo real
  window.cargarSolicitudesFirebase = function (contenedorId) {
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) return;

    onSnapshot(collection(db, "solicitudes"), (snapshot) => {
      contenedor.innerHTML = "";
      snapshot.forEach((doc) => {
        const data = doc.data();
        contenedor.innerHTML += `
          <div class="request-card pending">
            <div class="request-header">
              <div class="request-number">📝 Solicitud ID: ${doc.id}</div>
            </div>
            <div class="request-details">
              <div><strong>Servicio:</strong> ${data.servicio || "No especificado"}</div>
              <div><strong>Descripción:</strong> ${data.descripcion || "Sin descripción"}</div>
              <div><strong>Fecha:</strong> ${data.fecha || "Desconocida"}</div>
            </div>
          </div>`;
      });
    });
  };
</script>
</script>

<!-- Firebase Config -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
  apiKey: "AIzaSyAtj36T7EiECJosYP_5127tQnm_kRnwPMs",
  authDomain: "gestion-de-solicitudes-25a93.firebaseapp.com",
  projectId: "gestion-de-solicitudes-25a93",
  storageBucket: "gestion-de-solicitudes-25a93.firebasestorage.app",
  messagingSenderId: "399184380837",
  appId: "1:399184380837:web:df0b081cd81938c0a11e4c"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.firebaseDB = db;
</script>


<section class="card">
  <div class="card-header">
    <h2 class="card-title">📋 Solicitudes Recibidas</h2>
  </div>
  <div class="card-content" id="lista-solicitudes">
    <p>Cargando solicitudes desde Firebase...</p>
  </div>
</section>

<script type="module">
  cargarSolicitudesFirebase("lista-solicitudes");
</script>


<!-- Firebase Configuración y Funciones -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_PROYECTO.firebaseapp.com",
    projectId: "TU_PROYECTO",
    storageBucket: "TU_PROYECTO.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcde12345"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.firebaseDB = db;
  console.log("✅ Firebase inicializado correctamente");

  // Guardar solicitud
  window.guardarSolicitudFirebase = async function (data) {
    try {
      const docRef = await addDoc(collection(db, "solicitudes"), data);
      console.log("✅ Solicitud guardada con ID:", docRef.id);
      alert("✅ Solicitud enviada correctamente");
    } catch (error) {
      console.error("❌ Error al guardar solicitud:", error);
      alert("❌ Error al guardar la solicitud");
    }
  };

  // Cargar solicitudes en tiempo real
  window.cargarSolicitudesFirebase = function (contenedorId) {
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) {
      console.warn("⚠️ No se encontró el contenedor:", contenedorId);
      return;
    }
    onSnapshot(collection(db, "solicitudes"), (snapshot) => {
      contenedor.innerHTML = "";
      snapshot.forEach((doc) => {
        const data = doc.data();
        contenedor.innerHTML += `
          <div class="request-card pending">
            <div class="request-header">
              <div class="request-number">📝 Solicitud ID: ${doc.id}</div>
            </div>
            <div class="request-details">
              <div><strong>Servicio:</strong> ${data.servicio || "No especificado"}</div>
              <div><strong>Descripción:</strong> ${data.descripcion || "Sin descripción"}</div>
              <div><strong>Fecha:</strong> ${data.fecha || "Desconocida"}</div>
            </div>
          </div>`;
      });
      console.log("📥 Solicitudes cargadas");
    });
  };
</script>

<section>
  <h2>📋 Solicitudes Recibidas</h2>
  <div id="lista-solicitudes">
    <p>Cargando solicitudes desde Firebase...</p>
  </div>
</section>

<script type="module">
  cargarSolicitudesFirebase("lista-solicitudes");
</script>

</body>
</html>