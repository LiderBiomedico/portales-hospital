<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Susana L√≥pez de Valencia - Portal Gesti√≥n COMPLETO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f8f5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #059669 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            color: white;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto;
            min-height: 5rem;
            padding: 1rem;
            position: relative;
            gap: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .hospital-info h1 {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .hospital-info p {
            font-size: 0.85rem;
            color: #e0f2fe;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-bottom: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .developer-credit {
            font-size: 0.75rem;
            color: #bfdbfe;
            font-weight: 400;
            margin-top: 0.25rem;
            margin-bottom: 0;
            text-align: center;
            font-style: italic;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: white;
            color: #059669;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: rgba(255,255,255,0.1);
            border: none;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
            color: white;
            backdrop-filter: blur(10px);
        }

        .notification-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            font-size: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .metric-card.total { 
            border-top-color: #2563eb; 
            background: linear-gradient(135deg, #ffffff 0%, #dbeafe 100%);
        }
        .metric-card.biomedica { 
            border-top-color: #059669; 
            background: linear-gradient(135deg, #ffffff 0%, #dcfce7 100%);
        }
        .metric-card.mecanica { 
            border-top-color: #f59e0b; 
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
        }
        .metric-card.infraestructura { 
            border-top-color: #8b5cf6; 
            background: linear-gradient(135deg, #ffffff 0%, #ede9fe 100%);
        }
        .metric-card.pendientes { 
            border-top-color: #ef4444; 
            background: linear-gradient(135deg, #ffffff 0%, #fee2e2 100%);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Area Tabs */
        .area-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .area-tab {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .area-tab.active {
            border-color: #059669;
            background: #dcfce7;
            color: #065f46;
        }

        .area-tab:hover:not(.active) {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .area-tab.biomedica.active {
            border-color: #059669;
            background: #dcfce7;
        }

        .area-tab.mecanica.active {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .area-tab.infraestructura.active {
            border-color: #8b5cf6;
            background: #ede9fe;
        }

        /* Action buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 0;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        /* Technician cards */
        .technician-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .technician-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .technician-card.selectable {
            cursor: pointer;
        }

        .technician-card.selected {
            border-color: #059669;
            background: #dcfce7;
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.2);
        }

        .technician-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .technician-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .technician-id {
            background: #2563eb;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .technician-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .technician-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
        }

        .technician-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .status-disponible {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-ocupado {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-inactivo {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-asignada {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-proceso {
            background: #fed7aa;
            color: #ea580c;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-completada {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Request cards */
        .request-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .request-card.pending {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .request-card.assigned {
            border-left: 4px solid #2563eb;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .request-card.completed {
            border-left: 4px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .request-card.critical {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            animation: blink 2s infinite;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .request-number {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.125rem;
        }

        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .request-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .request-detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .request-detail-value {
            color: #1f2937;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* Views */
        .view {
            display: block;
        }

        .view.hidden {
            display: none;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }

        .alert-danger {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* System status */
        .system-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid #059669;
            font-size: 0.875rem;
        }

        .status-online {
            color: #059669;
            font-weight: 600;
        }

        /* Access Code Display */
        .access-code-display {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #2563eb;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
        }

        .access-code-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e40af;
            letter-spacing: 0.5rem;
            font-family: 'Courier New', monospace;
            margin: 0.5rem 0;
            text-shadow: 0 2px 4px rgba(30, 64, 175, 0.3);
        }

        .access-code-label {
            font-size: 0.875rem;
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .access-code-info {
            font-size: 0.75rem;
            color: #3b82f6;
            margin-top: 0.5rem;
        }

        /* Access Request Cards */
        .access-request-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            border-left: 4px solid #f59e0b;
        }

        .access-request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .access-request-card.pending {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .access-request-card.approved {
            border-left-color: #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .access-request-card.rejected {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        /* User cards */
        .user-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            border-left: 4px solid #059669;
        }

        .user-card:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-card.approved {
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        /* Hidden class utility */
        .hidden {
            display: none !important;
        }

        /* Animaci√≥n para notificaciones cr√≠ticas */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.7; }
        }

        /* Assignment Modal */
        .tech-selection-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .tech-selection-item {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .tech-selection-item:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .tech-selection-item.selected {
            border-color: #059669;
            background: #dcfce7;
        }

        .tech-selection-item.unavailable {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f9fafb;
        }

        /* Priority badges */
        .priority-critica {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-alta {
            background: #fed7aa;
            color: #ea580c;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-media {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-baja {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Respuesta del t√©cnico */
        .tecnico-response {
            background: #f0fdf4;
            border: 2px solid #059669;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .tecnico-response-label {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tecnico-response-content {
            color: #047857;
            line-height: 1.6;
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #059669;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 1rem;
                gap: 1rem;
            }

            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }

            .hospital-info h1 {
                font-size: 1rem;
                text-align: center;
            }

            .hospital-info p {
                font-size: 0.75rem;
                text-align: center;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
                margin-top: 1rem;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .technician-details {
                grid-template-columns: 1fr;
            }

            .technician-actions {
                justify-content: center;
            }

            .request-details {
                grid-template-columns: 1fr;
            }

            .request-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content container">
            <div class="logo">
                <div class="hospital-info">
                    <h1>HOSPITAL SUSANA LOPEZ DE VALENCIA E.S.E.</h1>
                    <p class="developer-credit">Desarrollado por Ing. Paul Eduardo Mu√±oz R.</p>
                    <p>Portal Gesti√≥n COMPLETO - Solicitudes y Asignaci√≥n de T√©cnicos</p>
                </div>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showView('dashboard')" data-view="dashboard">
                    üìä Dashboard
                </button>
                <button class="nav-tab" onclick="showView('solicitudes')" data-view="solicitudes">
                    üìã Solicitudes (<span id="total-count">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('areas')" data-view="areas">
                    üîß Por √Åreas
                </button>
                <button class="nav-tab" onclick="showView('tecnicos')" data-view="tecnicos">
                    üë• Ingenieros/T√©cnicos (<span id="total-technicians-nav">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('accesos')" data-view="accesos">
                    üîê Accesos (<span id="pending-access-count">0</span>)
                </button>
                <button class="nav-tab" onclick="showView('reportes')" data-view="reportes">
                    üìà Reportes
                </button>
            </nav>

            <div class="user-info">
                <button class="notification-btn" onclick="showNotifications()">
                    üîî
                    <span class="notification-badge" id="notification-count">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-layout container">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <!-- Alertas de Solicitudes Cr√≠ticas -->
            <div id="critical-alerts"></div>

            <!-- Metrics por √Årea de Ingenier√≠a -->
            <div class="metrics-grid">
                <div class="metric-card total" onclick="showView('solicitudes')">
                    <div class="metric-icon">üìã</div>
                    <div class="metric-number" id="metric-total">0</div>
                    <div class="metric-label">Total Solicitudes</div>
                </div>
                <div class="metric-card biomedica" onclick="filterByArea('INGENIERIA_BIOMEDICA')">
                    <div class="metric-icon">üè•</div>
                    <div class="metric-number" id="metric-biomedica">0</div>
                    <div class="metric-label">Ingenier√≠a Biom√©dica</div>
                </div>
                <div class="metric-card mecanica" onclick="filterByArea('MECANICA')">
                    <div class="metric-icon">‚öôÔ∏è</div>
                    <div class="metric-number" id="metric-mecanica">0</div>
                    <div class="metric-label">Mec√°nica</div>
                </div>
                <div class="metric-card infraestructura" onclick="filterByArea('INFRAESTRUCTURA')">
                    <div class="metric-icon">üèóÔ∏è</div>
                    <div class="metric-number" id="metric-infraestructura">0</div>
                    <div class="metric-label">Infraestructura</div>
                </div>
                <div class="metric-card pendientes" onclick="filterByStatus('PENDIENTE')">
                    <div class="metric-icon">‚è≥</div>
                    <div class="metric-number" id="metric-pendientes">0</div>
                    <div class="metric-label">Pendientes Asignaci√≥n</div>
                </div>
            </div>

            <!-- Alert de Solicitudes Pendientes -->
            <div id="pending-alerts">
                <!-- Las alertas aparecer√°n aqu√≠ cuando haya solicitudes pendientes -->
            </div>

            <!-- Resumen de Personal por √Årea -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üè• Personal Biom√©dica</h2>
                        <span class="status-disponible" id="biomedica-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">No hay personal registrado</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚öôÔ∏è Personal Mec√°nica</h2>
                        <span class="status-disponible" id="mecanica-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">No hay personal registrado</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üèóÔ∏è Personal Infraestructura</h2>
                        <span class="status-disponible" id="infraestructura-personnel-count">0 registrados</span>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-personnel-summary">
                            <p style="color: #6b7280; text-align: center;">No hay personal registrado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Solicitudes View - COMPLETAMENTE FUNCIONAL -->
        <div id="solicitudes-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Gesti√≥n de Solicitudes de Mantenimiento - FUNCIONAL</h2>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-success btn-sm" onclick="autoAssignAllPending()">
                            ü§ñ Auto-asignar Todas
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="syncAllRequests()">
                            üîÑ Sincronizar
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showFilterOptions()">
                            üîç Filtros
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="exportRequestsReport()">
                            üì§ Exportar
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <!-- Filtros r√°pidos -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="filterRequests('all')" id="filter-all">
                            üìã Todas (<span id="count-all">0</span>)
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="filterRequests('PENDIENTE')" id="filter-pending">
                            ‚è≥ Pendientes (<span id="count-pending">0</span>)
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="filterRequests('ASIGNADA')" id="filter-assigned">
                            üë§ Asignadas (<span id="count-assigned">0</span>)
                        </button>
                        <button class="btn btn-success btn-sm" onclick="filterRequests('COMPLETADA')" id="filter-completed">
                            ‚úÖ Completadas (<span id="count-completed">0</span>)
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="filterRequests('CRITICA')" id="filter-critical">
                            üö® Cr√≠ticas (<span id="count-critical">0</span>)
                        </button>
                    </div>

                    <div id="solicitudes-list">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üìã</div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes registradas</h3>
                            <p style="margin-bottom: 1.5rem;">Las solicitudes del Portal de Solicitudes aparecer√°n aqu√≠ autom√°ticamente</p>
                            <button class="btn btn-primary" onclick="syncAllRequests()">
                                üîÑ Sincronizar con Portal de Solicitudes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Areas View -->
        <div id="areas-view" class="view hidden">
            <div class="area-tabs">
                <div class="area-tab active biomedica" onclick="showAreaTab('biomedica')" data-area="biomedica">
                    üè• Ingenier√≠a Biom√©dica (<span id="tab-biomedica-count">0</span>)
                </div>
                <div class="area-tab mecanica" onclick="showAreaTab('mecanica')" data-area="mecanica">
                    ‚öôÔ∏è Mec√°nica (<span id="tab-mecanica-count">0</span>)
                </div>
                <div class="area-tab infraestructura" onclick="showAreaTab('infraestructura')" data-area="infraestructura">
                    üèóÔ∏è Infraestructura (<span id="tab-infraestructura-count">0</span>)
                </div>
            </div>

            <div id="area-biomedica" class="area-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üè• Solicitudes - Ingenier√≠a Biom√©dica</h2>
                        <button class="btn btn-primary btn-sm" onclick="refreshAreaRequests('INGENIERIA_BIOMEDICA')">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-requests">
                            <p style="text-align: center; color: #6b7280;">Las solicitudes del √°rea aparecer√°n aqu√≠...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="area-mecanica" class="area-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚öôÔ∏è Solicitudes - Mec√°nica</h2>
                        <button class="btn btn-primary btn-sm" onclick="refreshAreaRequests('MECANICA')">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-requests">
                            <p style="text-align: center; color: #6b7280;">Las solicitudes del √°rea aparecer√°n aqu√≠...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="area-infraestructura" class="area-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üèóÔ∏è Solicitudes - Infraestructura</h2>
                        <button class="btn btn-primary btn-sm" onclick="refreshAreaRequests('INFRAESTRUCTURA')">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-requests">
                            <p style="text-align: center; color: #6b7280;">Las solicitudes del √°rea aparecer√°n aqu√≠...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tecnicos View -->
        <div id="tecnicos-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Gesti√≥n de Ingenieros/T√©cnicos</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="showAddTechnicianModal()">
                            ‚ûï Agregar Ingeniero/T√©cnico
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="exportTechnicians()">
                            üì§ Exportar Lista
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="clearAllTechnicians()">
                            üóëÔ∏è Limpiar Todos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Personal por √Årea -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
                <!-- Ingenier√≠a Biom√©dica -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);">
                        <h3 class="card-title" style="color: #065f46;">üè• Ingenier√≠a Biom√©dica</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-disponible" id="biomedica-total">0 ingenieros/t√©cnicos</span>
                            <button class="btn btn-success btn-sm" onclick="showAddTechnicianModal('INGENIERIA_BIOMEDICA')">
                                ‚ûï Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="biomedica-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üè•</div>
                                <h4>No hay ingenieros/t√©cnicos registrados</h4>
                                <p style="font-size: 0.875rem;">Comience agregando personal especializado</p>
                                <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('INGENIERIA_BIOMEDICA')" style="margin-top: 1rem;">
                                    ‚ûï Agregar Primer Ingeniero/T√©cnico
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mec√°nica -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #fefbeb 0%, #fef3c7 100%);">
                        <h3 class="card-title" style="color: #d97706;">‚öôÔ∏è Mec√°nica</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-ocupado" id="mecanica-total">0 ingenieros/t√©cnicos</span>
                            <button class="btn btn-warning btn-sm" onclick="showAddTechnicianModal('MECANICA')">
                                ‚ûï Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="mecanica-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">‚öôÔ∏è</div>
                                <h4>No hay t√©cnicos registrados</h4>
                                <p style="font-size: 0.875rem;">Comience agregando personal especializado</p>
                                <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('MECANICA')" style="margin-top: 1rem;">
                                    ‚ûï Agregar Primer T√©cnico
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Infraestructura -->
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #f3f4f6 0%, #ede9fe 100%);">
                        <h3 class="card-title" style="color: #7c3aed;">üèóÔ∏è Infraestructura</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <span class="status-inactivo" id="infraestructura-total">0 ingenieros/t√©cnicos</span>
                            <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('INFRAESTRUCTURA')">
                                ‚ûï Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="infraestructura-technicians-list">
                            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üèóÔ∏è</div>
                                <h4>No hay t√©cnicos registrados</h4>
                                <p style="font-size: 0.875rem;">Comience agregando personal especializado</p>
                                <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('INFRAESTRUCTURA')" style="margin-top: 1rem;">
                                    ‚ûï Agregar Primer T√©cnico
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas de Personal -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Estad√≠sticas de Personal T√©cnico</h3>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2563eb;" id="total-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Total Personal</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #eff6ff; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2563eb;" id="total-engineers">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Ingenieros</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #059669;" id="total-technicians-only">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">T√©cnicos</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #059669;" id="available-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Disponibles</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="busy-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Ocupados</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #fee2e2; border-radius: 0.5rem;">
                            <div style="font-size: 2rem; font-weight: bold; color: #ef4444;" id="inactive-technicians">0</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Inactivos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accesos View -->
        <div id="accesos-view" class="view hidden">
            <!-- Alert de C√≥digos de Acceso -->
            <div class="alert alert-info">
                <h3 style="font-weight: 600; margin-bottom: 0.5rem;">üî¢ Sistema de C√≥digos de Acceso de 4 D√≠gitos</h3>
                <p>Al aprobar solicitudes de acceso, el sistema genera autom√°ticamente c√≥digos √∫nicos de 4 d√≠gitos para el acceso al Portal de Solicitudes.</p>
            </div>

            <!-- Alert de Solicitudes de Acceso Pendientes -->
            <div id="access-alerts">
                <!-- Las alertas aparecer√°n aqu√≠ cuando haya solicitudes pendientes -->
            </div>

            <!-- Estad√≠sticas de Accesos -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="metric-card total">
                    <div class="metric-icon">üë•</div>
                    <div class="metric-number" id="total-users">0</div>
                    <div class="metric-label">Usuarios Registrados</div>
                </div>
                <div class="metric-card pendientes">
                    <div class="metric-icon">‚è≥</div>
                    <div class="metric-number" id="pending-access">0</div>
                    <div class="metric-label">Accesos Pendientes</div>
                </div>
                <div class="metric-card biomedica">
                    <div class="metric-icon">‚úÖ</div>
                    <div class="metric-number" id="approved-users">0</div>
                    <div class="metric-label">Usuarios Aprobados</div>
                </div>
                <div class="metric-card infraestructura">
                    <div class="metric-icon">‚ùå</div>
                    <div class="metric-number" id="rejected-users">0</div>
                    <div class="metric-label">Accesos Rechazados</div>
                </div>
            </div>

            <!-- Solicitudes de Acceso Pendientes -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚è≥ Solicitudes de Acceso Pendientes</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="approveAllPending()">
                            ‚úÖ Aprobar Todas
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="syncAccessRequests()">
                            üîÑ Sincronizar
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="pending-access-list">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üîê</div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes de acceso pendientes</h3>
                            <p style="margin-bottom: 1.5rem;">Las solicitudes aparecer√°n aqu√≠ cuando los usuarios se registren</p>
                            <button class="btn btn-primary" onclick="syncAccessRequests()">
                                üîÑ Sincronizar Solicitudes de Acceso
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usuarios Aprobados -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚úÖ Usuarios con Acceso Aprobado</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="regenerateAllCodes()">
                            üîÑ Regenerar C√≥digos
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="exportUsersList()">
                            üì§ Exportar Lista
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="approved-users-list">
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                            <h4>No hay usuarios aprobados</h4>
                            <p style="font-size: 0.875rem;">Los usuarios aprobados aparecer√°n aqu√≠</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reportes View -->
        <div id="reportes-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìà Reportes y Estad√≠sticas</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="generateFullReport()">
                            üìä Reporte Completo
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportAllData()">
                            üì§ Exportar Todo
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="reports-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb;">
                                <h4 style="color: #1f2937; margin-bottom: 1rem;">üìã Solicitudes por Estado</h4>
                                <div id="status-chart" style="font-size: 0.875rem;">
                                    <div>Pendientes: <span id="report-pending">0</span></div>
                                    <div>Asignadas: <span id="report-assigned">0</span></div>
                                    <div>Completadas: <span id="report-completed">0</span></div>
                                </div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb;">
                                <h4 style="color: #1f2937; margin-bottom: 1rem;">üë• Personal por √Årea</h4>
                                <div id="personnel-chart" style="font-size: 0.875rem;">
                                    <div>Biom√©dica: <span id="report-biomedica-staff">0</span></div>
                                    <div>Mec√°nica: <span id="report-mecanica-staff">0</span></div>
                                    <div>Infraestructura: <span id="report-infraestructura-staff">0</span></div>
                                </div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb;">
                                <h4 style="color: #1f2937; margin-bottom: 1rem;">üîê Gesti√≥n de Accesos</h4>
                                <div id="access-chart" style="font-size: 0.875rem;">
                                    <div>Pendientes: <span id="report-access-pending">0</span></div>
                                    <div>Aprobados: <span id="report-access-approved">0</span></div>
                                    <div>Total Usuarios: <span id="report-total-users">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- System Status -->
    <div class="system-status">
        <div class="status-online">
            üîÑ Sistema Iniciando...
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES COMPLETAS =====
        let solicitudesFromPortal = []; // Solicitudes del Portal de Solicitudes
        let accessRequests = []; // Solicitudes de acceso
        let approvedUsers = []; // Usuarios aprobados
        let rejectedUsers = []; // Usuarios rechazados
        let currentFilter = 'all'; // Filtro actual de solicitudes
        let selectedTechnicianForAssignment = null;
        let lastSyncTime = new Date();

        // Base de datos de t√©cnicos por √°rea
        let tecnicosPorArea = {
            'INGENIERIA_BIOMEDICA': [],
            'MECANICA': [],
            'INFRAESTRUCTURA': []
        };

        // Mapas de servicios y areas
        const serviciosHospitalarios = {
            'URGENCIAS_ADULTO': 'Urgencias Adulto',
            'URGENCIAS_PEDIATRICAS': 'Urgencias Pedi√°tricas',
            'URGENCIAS_GINECOLOGIA': 'Urgencias Ginecolog√≠a',
            'UCI_ADULTO': 'UCI Adulto',
            'UCI_NEONATAL': 'UCI Neonatal',
            'UCI_INTERMEDIOS': 'UCI Intermedios',
            'HOSPITALIZACION_ADULTO': 'Hospitalizaci√≥n Adulto',
            'HOSPITALIZACION_PEDIATRIA': 'Hospitalizaci√≥n Pediatr√≠a',
            'CIRUGIA_ADULTO': 'Cirug√≠a Adulto',
            'CIRUGIA_PEDIATRICA': 'Cirug√≠a Pedi√°trica',
            'SALA_PARTOS': 'Sala de Partos',
            'CONSULTA_EXTERNA': 'Consulta Externa',
            'ENDOSCOPIA': 'Endoscopia',
            'IMAGENES_DIAGNOSTICAS': 'Im√°genes Diagn√≥sticas',
            'LABORATORIO_CLINICO': 'Laboratorio Cl√≠nico',
            'FARMACIA_CENTRAL': 'Farmacia Central',
            'FISIOTERAPIA': 'Fisioterapia',
            'VACUNACION': 'Vacunaci√≥n',
            'CENTRAL_ESTERILIZACION_ADULTOS': 'Central de Esterilizaci√≥n Adultos',
            'CENTRAL_ESTERILIZACION_UMI': 'Central de Esterilizaci√≥n UMI',
            'INGENIERIA_BIOMEDICA': 'Ingenier√≠a Biom√©dica',
            'INFRAESTRUCTURA': 'Infraestructura',
            'MECANICOS': 'Mec√°nicos',
            'TRAILER': 'Trailer',
            'AMBULANCIAS': 'Ambulancias'
        };

        const serviciosIngenieria = {
            'INGENIERIA_BIOMEDICA': 'Ingenier√≠a Biom√©dica',
            'INFRAESTRUCTURA': 'Infraestructura',
            'MECANICA': 'Mec√°nica'
        };

        const iconosIngenieria = {
            'INGENIERIA_BIOMEDICA': 'üè•',
            'INFRAESTRUCTURA': 'üèóÔ∏è',
            'MECANICA': '‚öôÔ∏è'
        };

        // ===== FUNCIONES DE PERSISTENCIA =====
        function saveAllData() {
            try {
                localStorage.setItem('hospital_technicians', JSON.stringify(tecnicosPorArea));
                localStorage.setItem('hospital_solicitudes', JSON.stringify(solicitudesFromPortal));
                localStorage.setItem('hospital_access_requests', JSON.stringify(accessRequests));
                localStorage.setItem('hospital_approved_users', JSON.stringify(approvedUsers));
                localStorage.setItem('hospital_rejected_users', JSON.stringify(rejectedUsers));
                console.log('üíæ Todos los datos guardados correctamente');
                return true;
            } catch (error) {
                console.error('‚ùå Error al guardar datos:', error);
                return false;
            }
        }

        function loadAllData() {
            try {
                console.log('üìÇ Cargando todos los datos...');
                
                // Cargar t√©cnicos
                const savedTechnicians = localStorage.getItem('hospital_technicians');
                if (savedTechnicians) {
                    const parsed = JSON.parse(savedTechnicians);
                    if (parsed && typeof parsed === 'object') {
                        tecnicosPorArea = {
                            'INGENIERIA_BIOMEDICA': Array.isArray(parsed['INGENIERIA_BIOMEDICA']) ? parsed['INGENIERIA_BIOMEDICA'] : [],
                            'MECANICA': Array.isArray(parsed['MECANICA']) ? parsed['MECANICA'] : [],
                            'INFRAESTRUCTURA': Array.isArray(parsed['INFRAESTRUCTURA']) ? parsed['INFRAESTRUCTURA'] : []
                        };
                    }
                }
                
                // Cargar solicitudes
                const savedRequests = localStorage.getItem('hospital_solicitudes');
                if (savedRequests) {
                    const parsed = JSON.parse(savedRequests);
                    if (Array.isArray(parsed)) {
                        solicitudesFromPortal = parsed;
                    }
                }
                
                // Cargar datos de accesos
                const savedAccessRequests = localStorage.getItem('hospital_access_requests');
                if (savedAccessRequests) {
                    const parsed = JSON.parse(savedAccessRequests);
                    if (Array.isArray(parsed)) {
                        accessRequests = parsed;
                    }
                }
                
                const savedApprovedUsers = localStorage.getItem('hospital_approved_users');
                if (savedApprovedUsers) {
                    const parsed = JSON.parse(savedApprovedUsers);
                    if (Array.isArray(parsed)) {
                        approvedUsers = parsed;
                    }
                }
                
                const savedRejectedUsers = localStorage.getItem('hospital_rejected_users');
                if (savedRejectedUsers) {
                    const parsed = JSON.parse(savedRejectedUsers);
                    if (Array.isArray(parsed)) {
                        rejectedUsers = parsed;
                    }
                }
                
                const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
                const totalRequests = solicitudesFromPortal.length;
                const totalUsers = approvedUsers.length;
                const pendingAccess = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
                
                console.log(`üìä Datos cargados: ${totalTechnicians} t√©cnicos, ${totalRequests} solicitudes, ${totalUsers} usuarios, ${pendingAccess} accesos pendientes`);
                
                return true;
            } catch (error) {
                console.error('‚ùå Error al cargar datos:', error);
                return false;
            }
        }

        // ===== FUNCIONES DE GENERACI√ìN DE C√ìDIGOS =====
        function generateAccessCode() {
            let code;
            let isUnique = false;
            
            do {
                code = Math.floor(1000 + Math.random() * 9000).toString();
                isUnique = !approvedUsers.some(user => user.codigoAcceso === code);
            } while (!isUnique);
            
            return code;
        }

        function generateTechnicianId(area) {
            let areaPrefix;
            switch(area) {
                case 'INGENIERIA_BIOMEDICA': areaPrefix = 'IB'; break;
                case 'MECANICA': areaPrefix = 'ME'; break;
                case 'INFRAESTRUCTURA': areaPrefix = 'IN'; break;
                default: areaPrefix = 'XX';
            }
            
            const existingIds = tecnicosPorArea[area].map(t => t.id);
            let newId = 1;
            let techId;
            do {
                techId = `${areaPrefix}${String(newId).padStart(3, '0')}`;
                newId++;
            } while (existingIds.includes(techId));
            
            return techId;
        }

        // ===== FUNCIONES DE GESTI√ìN DE SOLICITUDES COMPLETAMENTE FUNCIONALES =====
        function syncAllRequests() {
            console.log('üîÑ Sincronizando todas las solicitudes...');
            
            try {
                // Recargar datos desde localStorage
                loadAllData();
                
                // Actualizar contadores
                updateAllCounters();
                
                // Actualizar visualizaci√≥n de solicitudes
                updateRequestsDisplay();
                
                // Actualizar vista por √°reas
                updateAreaRequests();
                
                // Mostrar alertas si hay solicitudes cr√≠ticas
                showCriticalAlerts();
                
                const totalRequests = solicitudesFromPortal.length;
                const pendingRequests = solicitudesFromPortal.filter(req => !req.tecnicoAsignado || req.estadoGestion === 'PENDIENTE').length;
                
                alert(`üîÑ SINCRONIZACI√ìN COMPLETADA\n\nüìä RESULTADOS:\n‚Ä¢ ${totalRequests} solicitudes de mantenimiento encontradas\n‚Ä¢ ${pendingRequests} solicitudes pendientes de asignaci√≥n\n\n‚úÖ Sistema completamente sincronizado\nüîß Listo para asignar t√©cnicos`);
                
                updateSystemStatus(`üîÑ Sincronizado: ${totalRequests} solicitudes, ${pendingRequests} pendientes`);
                
                return true;
            } catch (error) {
                console.error('‚ùå Error en sincronizaci√≥n:', error);
                alert('‚ùå Error durante la sincronizaci√≥n. Intente nuevamente.');
                return false;
            }
        }

        function updateRequestsDisplay() {
            console.log('üé® Actualizando visualizaci√≥n de solicitudes...');
            
            const container = document.getElementById('solicitudes-list');
            if (!container) return;
            
            let filteredRequests = solicitudesFromPortal;
            
            // Aplicar filtro actual
            if (currentFilter !== 'all') {
                if (currentFilter === 'PENDIENTE') {
                    filteredRequests = solicitudesFromPortal.filter(req => !req.tecnicoAsignado || req.estadoGestion === 'PENDIENTE');
                } else if (currentFilter === 'ASIGNADA') {
                    filteredRequests = solicitudesFromPortal.filter(req => req.tecnicoAsignado && req.estadoGestion !== 'COMPLETADA');
                } else if (currentFilter === 'COMPLETADA') {
                    filteredRequests = solicitudesFromPortal.filter(req => req.estadoGestion === 'COMPLETADA');
                } else if (currentFilter === 'CRITICA') {
                    filteredRequests = solicitudesFromPortal.filter(req => req.prioridad === 'CRITICA');
                }
            }
            
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üìã</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes ${currentFilter === 'all' ? '' : 'con este filtro'}</h3>
                        <p style="margin-bottom: 1.5rem;">
                            ${currentFilter === 'all' ? 
                                'Las solicitudes del Portal de Solicitudes aparecer√°n aqu√≠ autom√°ticamente' : 
                                `No hay solicitudes ${currentFilter.toLowerCase()} en este momento`
                            }
                        </p>
                        <button class="btn btn-primary" onclick="syncAllRequests()">
                            üîÑ Sincronizar con Portal de Solicitudes
                        </button>
                    </div>
                `;
            } else {
                // Ordenar por fecha de creaci√≥n (m√°s recientes primero) y prioridad
                const sortedRequests = filteredRequests.sort((a, b) => {
                    // Primero por prioridad (cr√≠tica primero)
                    const priorityOrder = { 'CRITICA': 0, 'ALTA': 1, 'MEDIA': 2, 'BAJA': 3 };
                    const aPriority = priorityOrder[a.prioridad] || 4;
                    const bPriority = priorityOrder[b.prioridad] || 4;
                    
                    if (aPriority !== bPriority) {
                        return aPriority - bPriority;
                    }
                    
                    // Luego por fecha (m√°s reciente primero)
                    const aDate = new Date(a.fechaCreacionISO || a.fechaCreacion);
                    const bDate = new Date(b.fechaCreacionISO || b.fechaCreacion);
                    return bDate - aDate;
                });
                
                const requestsHTML = sortedRequests.map(request => createRequestCard(request)).join('');
                container.innerHTML = requestsHTML;
                
                console.log(`‚úÖ Mostrando ${filteredRequests.length} solicitudes`);
            }
            
            // Actualizar contadores de filtros
            updateFilterCounts();
        }

        function createRequestCard(request) {
            const serviceName = serviciosHospitalarios[request.servicioHospitalario] || request.servicioHospitalario;
            const areaName = serviciosIngenieria[request.servicioIngenieria] || request.servicioIngenieria;
            const estado = request.estadoGestion || request.estado || 'PENDIENTE';
            const isPending = !request.tecnicoAsignado || estado === 'PENDIENTE';
            const isCritical = request.prioridad === 'CRITICA';
            
            let cardClass = 'request-card';
            if (isCritical) cardClass += ' critical';
            else if (isPending) cardClass += ' pending';
            else if (estado === 'COMPLETADA') cardClass += ' completed';
            else cardClass += ' assigned';
            
            const priorityClass = `priority-${request.prioridad.toLowerCase()}`;
            const statusClass = isPending ? 'status-pendiente' : 
                                estado === 'COMPLETADA' ? 'status-completada' : 
                                'status-asignada';
            
            return `
                <div class="${cardClass}">
                    <div class="request-header">
                        <div class="request-number">üìã ${request.numero}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <span class="${priorityClass}">${request.prioridad}</span>
                            <span class="${statusClass}">${isPending ? 'PENDIENTE' : estado}</span>
                        </div>
                    </div>
                    
                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">üîß √Årea T√©cnica</div>
                            <div class="request-detail-value">${areaName}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üî® Tipo de Servicio</div>
                            <div class="request-detail-value">${(request.tipoServicio || 'No especificado').replace('_', ' ')}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üè• Servicio Solicitante</div>
                            <div class="request-detail-value">${serviceName}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üë§ Solicitante</div>
                            <div class="request-detail-value">${request.solicitante || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üñ•Ô∏è Equipo</div>
                            <div class="request-detail-value">${request.equipo || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üìç Ubicaci√≥n</div>
                            <div class="request-detail-value">${request.ubicacion || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üìÖ Fecha de Solicitud</div>
                            <div class="request-detail-value">${request.fechaCreacion || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üë®‚Äçüîß T√©cnico Asignado</div>
                            <div class="request-detail-value">
                                ${request.tecnicoAsignado ? 
                                    `<span style="color: #059669; font-weight: 600;">${request.tecnicoAsignado}</span>` : 
                                    '<span style="color: #f59e0b;">Pendiente de asignaci√≥n</span>'
                                }
                            </div>
                        </div>
                    </div>

                    <div style="margin: 1rem 0; padding: 1rem; background: #f0f9ff; border-radius: 0.5rem; border-left: 3px solid #2563eb;">
                        <div class="request-detail-label">üìù Descripci√≥n del Problema</div>
                        <div style="margin-top: 0.5rem; color: #1f2937;">${request.descripcion || 'No especificada'}</div>
                        ${request.observaciones ? `
                            <div style="margin-top: 0.5rem; font-style: italic; color: #6b7280;">
                                <strong>Observaciones:</strong> ${request.observaciones}
                            </div>
                        ` : ''}
                    </div>

                    ${request.respuestaTecnico ? `
                        <div class="tecnico-response">
                            <div class="tecnico-response-label">
                                ‚úÖ Respuesta del T√©cnico
                            </div>
                            <div class="tecnico-response-content">
                                ${request.respuestaTecnico}
                            </div>
                        </div>
                    ` : ''}

                    <div class="request-actions">
                        ${isPending ? `
                            <button class="btn btn-success btn-sm" onclick="showAssignTechnicianModal('${request.numero}')">
                                üë§ Asignar
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="autoAssignTechnician('${request.numero}')">
                                ü§ñ Auto-asignar
                            </button>
                        ` : ''}
                        
                        ${request.tecnicoAsignado && estado !== 'COMPLETADA' ? `
                            <button class="btn btn-warning btn-sm" onclick="changeRequestStatus('${request.numero}', 'EN_PROCESO')">
                                ‚è≥ Marcar En Proceso
                            </button>
                            <button class="btn btn-success btn-sm" onclick="changeRequestStatus('${request.numero}', 'COMPLETADA')">
                                ‚úÖ Marcar Completada
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="reassignTechnician('${request.numero}')">
                                üîÑ Reasignar
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-secondary btn-sm" onclick="viewRequestDetails('${request.numero}')">
                            üëÅÔ∏è Ver Detalles
                        </button>
                        
                        ${estado === 'COMPLETADA' ? `
                            <button class="btn btn-primary btn-sm" onclick="generateWorkReport('${request.numero}')">
                                üìÑ Reporte de Trabajo
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function filterRequests(filter) {
            currentFilter = filter;
            
            // Actualizar estado visual de botones de filtro
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });
            
            const activeBtn = document.getElementById(`filter-${filter}`);
            if (activeBtn) {
                activeBtn.style.background = '#2563eb';
                activeBtn.style.color = 'white';
            }
            
            // Actualizar visualizaci√≥n
            updateRequestsDisplay();
            
            console.log(`üîç Filtro aplicado: ${filter}`);
        }

        function updateFilterCounts() {
            const counts = {
                all: solicitudesFromPortal.length,
                pending: solicitudesFromPortal.filter(req => !req.tecnicoAsignado || req.estadoGestion === 'PENDIENTE').length,
                assigned: solicitudesFromPortal.filter(req => req.tecnicoAsignado && req.estadoGestion !== 'COMPLETADA' && req.estadoGestion !== 'PENDIENTE').length,
                completed: solicitudesFromPortal.filter(req => req.estadoGestion === 'COMPLETADA').length,
                critical: solicitudesFromPortal.filter(req => req.prioridad === 'CRITICA').length
            };
            
            const updateCount = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };
            
            updateCount('count-all', counts.all);
            updateCount('count-pending', counts.pending);
            updateCount('count-assigned', counts.assigned);
            updateCount('count-completed', counts.completed);
            updateCount('count-critical', counts.critical);
        }

        // ===== FUNCIONES DE ASIGNACI√ìN DE T√âCNICOS COMPLETAMENTE FUNCIONALES =====
        function showAssignTechnicianModal(requestNumber) {
            const request = solicitudesFromPortal.find(req => req.numero === requestNumber);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }
            
            const availableTechnicians = tecnicosPorArea[request.servicioIngenieria] || [];
            const freeTechnicians = availableTechnicians.filter(tech => tech.estado === 'disponible');
            
            if (freeTechnicians.length === 0) {
                const confirmation = confirm(`‚ùå No hay t√©cnicos disponibles en ${serviciosIngenieria[request.servicioIngenieria]}\n\n¬øDesea ver todos los t√©cnicos del √°rea (incluyendo ocupados)?`);
                if (!confirmation) return;
            }
            
            const modalHTML = `
                <div id="assign-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">üë§ Asignar - ${request.numero}</h3>
                            <button class="modal-close" onclick="closeAssignModal()">‚úï</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 3px solid #2563eb;">
                                <h4 style="color: #1e40af; margin-bottom: 0.5rem;">üìã Detalles de la Solicitud</h4>
                                <div style="color: #1e40af; font-size: 0.875rem;">
                                    <div><strong>Equipo:</strong> ${request.equipo}</div>
                                    <div><strong>Ubicaci√≥n:</strong> ${request.ubicacion}</div>
                                    <div><strong>Prioridad:</strong> ${request.prioridad}</div>
                                    <div><strong>√Årea:</strong> ${serviciosIngenieria[request.servicioIngenieria]}</div>
                                </div>
                            </div>
                            
                            <h4 style="margin-bottom: 1rem;">üîß T√©cnicos de ${serviciosIngenieria[request.servicioIngenieria]}</h4>
                            
                            <div class="tech-selection-list">
                                ${availableTechnicians.length === 0 ? 
                                    '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay t√©cnicos registrados en esta √°rea</p>' :
                                    availableTechnicians.map(tech => createTechnicianSelectionCard(tech)).join('')
                                }
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
                                <button class="btn btn-secondary" onclick="closeAssignModal()">Cancelar</button>
                                <button class="btn btn-success" onclick="confirmTechnicianAssignment('${requestNumber}')" id="confirm-assign-btn" disabled>
                                    ‚úÖ Asignar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function createTechnicianSelectionCard(tech) {
            const isAvailable = tech.estado === 'disponible';
            const typeIcon = tech.tipo === 'INGENIERO' ? 'üéì' : 'üîß';
            
            return `
                <div class="tech-selection-item ${isAvailable ? 'selectable' : 'unavailable'}" 
                     onclick="${isAvailable ? `selectTechnician('${tech.id}')` : ''}"
                     data-tech-id="${tech.id}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; color: #1f2937;">${typeIcon} ${tech.nombre}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="background: #2563eb; color: white; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem;">${tech.id}</span>
                            <span class="status-${tech.estado}">${tech.estado.charAt(0).toUpperCase() + tech.estado.slice(1)}</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                        <div>üéØ ${tech.especialidad}</div>
                        <div>üìû ${tech.telefono}</div>
                        <div>üìß ${tech.email}</div>
                        <div>üìÖ ${tech.fechaCreacion}</div>
                    </div>
                    ${tech.solicitudAsignada ? `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 0.375rem; font-size: 0.75rem; color: #d97706;">
                            üîß Trabajando en: ${tech.solicitudAsignada}
                        </div>
                    ` : ''}
                    ${!isAvailable ? `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border-radius: 0.375rem; font-size: 0.75rem; color: #dc2626;">
                            ‚ö†Ô∏è No disponible - Estado: ${tech.estado}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function selectTechnician(techId) {
            // Deseleccionar todos
            document.querySelectorAll('.tech-selection-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Seleccionar el elegido
            const selectedItem = document.querySelector(`[data-tech-id="${techId}"]`);
            if (selectedItem && selectedItem.classList.contains('selectable')) {
                selectedItem.classList.add('selected');
                selectedTechnicianForAssignment = techId;
                
                // Habilitar bot√≥n de confirmaci√≥n
                const confirmBtn = document.getElementById('confirm-assign-btn');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                }
            }
        }

        function confirmTechnicianAssignment(requestNumber) {
            if (!selectedTechnicianForAssignment) {
                alert('‚ùå Por favor seleccione un t√©cnico');
                return;
            }
            
            const request = solicitudesFromPortal.find(req => req.numero === requestNumber);
            const technician = findTechnicianById(selectedTechnicianForAssignment);
            
            if (!request || !technician) {
                alert('‚ùå Error: Solicitud o t√©cnico no encontrado');
                return;
            }
            
            const confirmation = confirm(`¬øAsignar la solicitud ${requestNumber} a ${technician.nombre}?\n\nEquipo: ${request.equipo}\nUbicaci√≥n: ${request.ubicacion}\nPrioridad: ${request.prioridad}`);
            
            if (!confirmation) return;
            
            // Realizar asignaci√≥n
            request.tecnicoAsignado = technician.nombre;
            request.estadoGestion = 'ASIGNADA';
            request.fechaAsignacion = new Date().toLocaleString('es-CO');
            
            // Actualizar estado del t√©cnico
            technician.estado = 'ocupado';
            technician.disponible = false;
            technician.solicitudAsignada = requestNumber;
            
            // Guardar cambios
            saveAllData();
            
            // Cerrar modal
            closeAssignModal();
            
            // Actualizar interfaz
            updateRequestsDisplay();
            updateTechniciansDisplay();
            updateAllCounters();
            
            alert(`‚úÖ ASIGNACI√ìN EXITOSA\n\nüë§ T√©cnico: ${technician.nombre}\nüìã Solicitud: ${requestNumber}\nüîß √Årea: ${serviciosIngenieria[request.servicioIngenieria]}\nüìÖ Fecha: ${request.fechaAsignacion}\n\n‚úÖ El t√©cnico ha sido marcado como ocupado`);
            
            updateSystemStatus(`‚úÖ Solicitud ${requestNumber} asignada a ${technician.nombre}`);
        }

        function autoAssignTechnician(requestNumber) {
            const request = solicitudesFromPortal.find(req => req.numero === requestNumber);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }
            
            const availableTechnicians = tecnicosPorArea[request.servicioIngenieria] || [];
            const freeTechnicians = availableTechnicians.filter(tech => tech.estado === 'disponible');
            
            if (freeTechnicians.length === 0) {
                alert(`‚ùå No hay t√©cnicos disponibles en ${serviciosIngenieria[request.servicioIngenieria]}\n\nUse la asignaci√≥n manual para ver todas las opciones.`);
                return;
            }
            
            // Seleccionar t√©cnico basado en carga de trabajo (el que tiene menos solicitudes asignadas)
            const selectedTechnician = freeTechnicians.reduce((best, current) => {
                // Contar solicitudes asignadas actualmente
                const bestCount = solicitudesFromPortal.filter(req => req.tecnicoAsignado === best.nombre && req.estadoGestion !== 'COMPLETADA').length;
                const currentCount = solicitudesFromPortal.filter(req => req.tecnicoAsignado === current.nombre && req.estadoGestion !== 'COMPLETADA').length;
                
                return currentCount < bestCount ? current : best;
            });
            
            const confirmation = confirm(`ü§ñ AUTO-ASIGNACI√ìN\n\nSolicitud: ${requestNumber}\nüë§ T√©cnico seleccionado: ${selectedTechnician.nombre}\nüéØ Especialidad: ${selectedTechnician.especialidad}\n\n¬øConfirmar asignaci√≥n autom√°tica?`);
            
            if (!confirmation) return;
            
            // Realizar asignaci√≥n
            request.tecnicoAsignado = selectedTechnician.nombre;
            request.estadoGestion = 'ASIGNADA';
            request.fechaAsignacion = new Date().toLocaleString('es-CO');
            
            // Actualizar estado del t√©cnico
            selectedTechnician.estado = 'ocupado';
            selectedTechnician.disponible = false;
            selectedTechnician.solicitudAsignada = requestNumber;
            
            // Guardar cambios
            saveAllData();
            
            // Actualizar interfaz
            updateRequestsDisplay();
            updateTechniciansDisplay();
            updateAllCounters();
            
            alert(`‚úÖ ASIGNACI√ìN AUTOM√ÅTICA EXITOSA\n\nüë§ T√©cnico: ${selectedTechnician.nombre}\nüìã Solicitud: ${requestNumber}\nü§ñ Seleccionado autom√°ticamente por menor carga de trabajo`);
            
            updateSystemStatus(`ü§ñ Auto-asignaci√≥n: ${requestNumber} ‚Üí ${selectedTechnician.nombre}`);
        }

        function autoAssignAllPending() {
            const pendingRequests = solicitudesFromPortal.filter(req => !req.tecnicoAsignado || req.estadoGestion === 'PENDIENTE');
            
            if (pendingRequests.length === 0) {
                alert('üìã No hay solicitudes pendientes para asignar');
                return;
            }
            
            const confirmation = confirm(`ü§ñ AUTO-ASIGNACI√ìN MASIVA\n\n¬øAsignar autom√°ticamente ${pendingRequests.length} solicitudes pendientes?\n\nEl sistema distribuir√° las solicitudes entre los t√©cnicos disponibles de cada √°rea.`);
            
            if (!confirmation) return;
            
            let assigned = 0;
            let errors = 0;
            let noTechnicians = 0;
            
            pendingRequests.forEach(request => {
                try {
                    const availableTechnicians = tecnicosPorArea[request.servicioIngenieria] || [];
                    const freeTechnicians = availableTechnicians.filter(tech => tech.estado === 'disponible');
                    
                    if (freeTechnicians.length === 0) {
                        noTechnicians++;
                        return;
                    }
                    
                    // Seleccionar t√©cnico con menor carga
                    const selectedTechnician = freeTechnicians.reduce((best, current) => {
                        const bestCount = solicitudesFromPortal.filter(req => req.tecnicoAsignado === best.nombre && req.estadoGestion !== 'COMPLETADA').length;
                        const currentCount = solicitudesFromPortal.filter(req => req.tecnicoAsignado === current.nombre && req.estadoGestion !== 'COMPLETADA').length;
                        return currentCount < bestCount ? current : best;
                    });
                    
                    // Asignar
                    request.tecnicoAsignado = selectedTechnician.nombre;
                    request.estadoGestion = 'ASIGNADA';
                    request.fechaAsignacion = new Date().toLocaleString('es-CO');
                    
                    // Actualizar t√©cnico
                    selectedTechnician.estado = 'ocupado';
                    selectedTechnician.disponible = false;
                    selectedTechnician.solicitudAsignada = request.numero;
                    
                    assigned++;
                    
                } catch (error) {
                    console.error(`‚ùå Error asignando ${request.numero}:`, error);
                    errors++;
                }
            });
            
            // Guardar cambios
            saveAllData();
            
            // Actualizar interfaz
            updateRequestsDisplay();
            updateTechniciansDisplay();
            updateAllCounters();
            
            alert(`ü§ñ AUTO-ASIGNACI√ìN MASIVA COMPLETADA\n\nüìä RESULTADOS:\n‚Ä¢ ${assigned} solicitudes asignadas exitosamente\n‚Ä¢ ${noTechnicians} solicitudes sin t√©cnicos disponibles\n‚Ä¢ ${errors} errores encontrados\n\n‚úÖ Proceso completado`);
            
            updateSystemStatus(`ü§ñ Asignaci√≥n masiva: ${assigned} asignadas, ${noTechnicians} sin t√©cnicos`);
        }

        function changeRequestStatus(requestNumber, newStatus) {
            const request = solicitudesFromPortal.find(req => req.numero === requestNumber);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }
            
            const statusNames = {
                'EN_PROCESO': 'En Proceso',
                'COMPLETADA': 'Completada',
                'PENDIENTE': 'Pendiente'
            };

            // Si se est√° completando la solicitud, solicitar la respuesta del t√©cnico
            if (newStatus === 'COMPLETADA') {
                const tecnicoResponse = prompt(`üìù Ingrese la respuesta/informe del t√©cnico para completar la solicitud ${requestNumber}:\n\n(Describa brevemente el trabajo realizado, hallazgos, reparaciones efectuadas, etc.)`, '');
                
                if (tecnicoResponse === null) {
                    return; // Usuario cancel√≥
                }
                
                if (tecnicoResponse.trim() === '') {
                    alert('‚ö†Ô∏è Es obligatorio ingresar una respuesta del t√©cnico para completar la solicitud.');
                    return;
                }
                
                const confirmation = confirm(`¬øCompletar la solicitud ${requestNumber}?\n\nEstado: COMPLETADA\nRespuesta del t√©cnico: ${tecnicoResponse.substring(0, 100)}${tecnicoResponse.length > 100 ? '...' : ''}`);
                
                if (!confirmation) return;
                
                // Guardar la respuesta del t√©cnico
                request.respuestaTecnico = tecnicoResponse.trim();
                request.fechaRespuesta = new Date().toLocaleString('es-CO');
            } else {
                const confirmation = confirm(`¬øCambiar el estado de la solicitud ${requestNumber} a "${statusNames[newStatus]}"?`);
                if (!confirmation) return;
            }
            
            const oldStatus = request.estadoGestion;
            request.estadoGestion = newStatus;
            
            // Si se completa la solicitud, liberar al t√©cnico
            if (newStatus === 'COMPLETADA' && request.tecnicoAsignado) {
                const technician = findTechnicianByName(request.tecnicoAsignado);
                if (technician) {
                    technician.estado = 'disponible';
                    technician.disponible = true;
                    technician.solicitudAsignada = null;
                }
                request.fechaCompletada = new Date().toLocaleString('es-CO');
            }
            
            // Guardar cambios
            saveAllData();
            
            // Actualizar interfaz
            updateRequestsDisplay();
            updateTechniciansDisplay();
            updateAllCounters();
            
            if (newStatus === 'COMPLETADA') {
                alert(`‚úÖ Solicitud completada: ${requestNumber}\n\nüìù Respuesta registrada del t√©cnico\nüéâ T√©cnico liberado para nuevas asignaciones\nüìÖ Fecha de finalizaci√≥n: ${request.fechaCompletada}`);
            } else {
                alert(`‚úÖ Estado actualizado: ${requestNumber}\n\nAnterior: ${oldStatus || 'PENDIENTE'}\nNuevo: ${newStatus}`);
            }
            
            updateSystemStatus(`‚úÖ ${requestNumber} ‚Üí ${statusNames[newStatus]}`);
        }

        function reassignTechnician(requestNumber) {
            const request = solicitudesFromPortal.find(req => req.numero === requestNumber);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }
            
            // Liberar t√©cnico actual
            if (request.tecnicoAsignado) {
                const currentTechnician = findTechnicianByName(request.tecnicoAsignado);
                if (currentTechnician) {
                    currentTechnician.estado = 'disponible';
                    currentTechnician.disponible = true;
                    currentTechnician.solicitudAsignada = null;
                }
            }
            
            // Limpiar asignaci√≥n
            request.tecnicoAsignado = null;
            request.estadoGestion = 'PENDIENTE';
            request.fechaAsignacion = null;
            
            // Guardar cambios
            saveAllData();
            
            // Mostrar modal de asignaci√≥n
            showAssignTechnicianModal(requestNumber);
            
            // Actualizar interfaz
            updateRequestsDisplay();
            updateTechniciansDisplay();
            updateAllCounters();
            
            updateSystemStatus(`üîÑ Solicitud ${requestNumber} liberada para reasignaci√≥n`);
        }

        function closeAssignModal() {
            const modal = document.getElementById('assign-modal');
            if (modal) {
                modal.remove();
            }
            selectedTechnicianForAssignment = null;
        }

        // ===== FUNCIONES DE GESTI√ìN DE T√âCNICOS =====
        function showAddTechnicianModal(area = '') {
            const modalHTML = `
                <div id="add-technician-modal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">‚ûï Agregar Nuevo Ingeniero/T√©cnico</h3>
                            <button class="modal-close" onclick="closeAddTechnicianModal()">‚úï</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <form id="add-technician-form">
                                <div class="form-group">
                                    <label class="form-label">üîß √Årea de Ingenier√≠a *</label>
                                    <select id="tech-area" class="form-select" required>
                                        <option value="">Seleccionar √°rea</option>
                                        <option value="INGENIERIA_BIOMEDICA" ${area === 'INGENIERIA_BIOMEDICA' ? 'selected' : ''}>üè• Ingenier√≠a Biom√©dica</option>
                                        <option value="MECANICA" ${area === 'MECANICA' ? 'selected' : ''}>‚öôÔ∏è Mec√°nica</option>
                                        <option value="INFRAESTRUCTURA" ${area === 'INFRAESTRUCTURA' ? 'selected' : ''}>üèóÔ∏è Infraestructura</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üë®‚Äçüéì Tipo de Personal *</label>
                                    <select id="tech-type" class="form-select" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="INGENIERO">üéì Ingeniero</option>
                                        <option value="TECNICO">üîß T√©cnico</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üë§ Nombre Completo *</label>
                                    <input type="text" id="tech-name" class="form-input" required placeholder="Ej: Juan P√©rez">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üéì Especialidad *</label>
                                    <input type="text" id="tech-specialty" class="form-input" required placeholder="Ej: Equipos Biom√©dicos">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üìû Tel√©fono *</label>
                                    <input type="tel" id="tech-phone" class="form-input" required placeholder="+57 300 123 4567">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üìß Email *</label>
                                    <input type="email" id="tech-email" class="form-input" required placeholder="juan.perez@hospital.com">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">üìã Estado Inicial</label>
                                    <select id="tech-status" class="form-select">
                                        <option value="disponible">‚úÖ Disponible</option>
                                        <option value="ocupado">‚è≥ Ocupado</option>
                                        <option value="inactivo">‚ùå Inactivo</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
                                    <button type="button" class="btn btn-secondary" onclick="closeAddTechnicianModal()">Cancelar</button>
                                    <button type="submit" class="btn btn-success">‚úÖ Agregar T√©cnico</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Manejar env√≠o del formulario
            document.getElementById('add-technician-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewTechnician();
            });
        }

        function addNewTechnician() {
            try {
                const area = document.getElementById('tech-area').value;
                const type = document.getElementById('tech-type').value;
                const name = document.getElementById('tech-name').value.trim();
                const specialty = document.getElementById('tech-specialty').value.trim();
                const phone = document.getElementById('tech-phone').value.trim();
                const email = document.getElementById('tech-email').value.trim();
                const status = document.getElementById('tech-status').value;

                // Validaciones
                if (!area || !type || !name || !specialty || !phone || !email) {
                    alert('‚ùå Por favor complete todos los campos obligatorios');
                    return;
                }

                if (!email.includes('@')) {
                    alert('‚ùå Por favor ingrese un email v√°lido');
                    return;
                }

                // Asegurar que el √°rea existe
                if (!tecnicosPorArea[area]) {
                    tecnicosPorArea[area] = [];
                }

                // Generar ID √∫nico
                const techId = generateTechnicianId(area);

                // Crear t√©cnico
                const prefix = type === 'INGENIERO' ? 'Ing.' : 'T√©c.';
                const fullName = `${prefix} ${name}`;

                const newTechnician = {
                    id: techId,
                    nombre: fullName,
                    tipo: type,
                    especialidad: specialty,
                    telefono: phone,
                    email: email,
                    disponible: status === 'disponible',
                    estado: status,
                    solicitudAsignada: null,
                    fechaCreacion: new Date().toLocaleString('es-CO')
                };

                // Agregar a la lista
                tecnicosPorArea[area].push(newTechnician);

                // Guardar cambios
                saveAllData();

                // Cerrar modal
                closeAddTechnicianModal();

                // Actualizar interfaz
                updateTechniciansDisplay();
                updateAllCounters();

                alert(`‚úÖ T√©cnico agregado exitosamente\n\nüë§ ${fullName}\nüè• ${serviciosIngenieria[area]}\nüÜî ${techId}`);

                updateSystemStatus(`‚úÖ T√©cnico agregado: ${fullName}`);

            } catch (error) {
                console.error('‚ùå Error al agregar t√©cnico:', error);
                alert('‚ùå Error al agregar el t√©cnico');
            }
        }

        function closeAddTechnicianModal() {
            const modal = document.getElementById('add-technician-modal');
            if (modal) {
                modal.remove();
            }
        }

        function updateTechniciansDisplay() {
            const areas = [
                { key: 'INGENIERIA_BIOMEDICA', name: 'biomedica', icon: 'üè•' },
                { key: 'MECANICA', name: 'mecanica', icon: '‚öôÔ∏è' },
                { key: 'INFRAESTRUCTURA', name: 'infraestructura', icon: 'üèóÔ∏è' }
            ];
            
            areas.forEach(area => {
                const technicians = tecnicosPorArea[area.key] || [];
                const listContainer = document.getElementById(`${area.name}-technicians-list`);
                
                if (!listContainer) return;
                
                if (technicians.length === 0) {
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">${area.icon}</div>
                            <h4>No hay ingenieros/t√©cnicos registrados</h4>
                            <p style="font-size: 0.875rem;">Comience agregando personal especializado</p>
                            <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal('${area.key}')" style="margin-top: 1rem;">
                                ‚ûï Agregar Primer Ingeniero/T√©cnico
                            </button>
                        </div>
                    `;
                } else {
                    const techniciansHTML = technicians.map(tech => createTechnicianCard(tech, area.key)).join('');
                    listContainer.innerHTML = techniciansHTML;
                }
            });
        }

        function createTechnicianCard(tech, area) {
            const statusClass = `status-${tech.estado}`;
            const typeIcon = tech.tipo === 'INGENIERO' ? 'üéì' : 'üîß';
            
            return `
                <div class="technician-card">
                    <div class="technician-header">
                        <div class="technician-name">${typeIcon} ${tech.nombre}</div>
                        <div class="technician-id">${tech.id}</div>
                    </div>
                    <div class="technician-details">
                        <div class="technician-detail">
                            <span>üéØ</span>
                            <span>${tech.especialidad}</span>
                        </div>
                        <div class="technician-detail">
                            <span>üìû</span>
                            <span>${tech.telefono}</span>
                        </div>
                        <div class="technician-detail">
                            <span>üìß</span>
                            <span>${tech.email}</span>
                        </div>
                        <div class="technician-detail">
                            <span>üìÖ</span>
                            <span>${tech.fechaCreacion}</span>
                        </div>
                        ${tech.solicitudAsignada ? `
                            <div class="technician-detail">
                                <span>üìã</span>
                                <span>Solicitud: ${tech.solicitudAsignada}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <span class="${statusClass}">${tech.estado.charAt(0).toUpperCase() + tech.estado.slice(1)}</span>
                    </div>
                    <div class="technician-actions">
                        <button class="btn btn-warning btn-sm" onclick="toggleTechnicianStatus('${area}', '${tech.id}')">
                            üîÑ Cambiar Estado
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTechnician('${area}', '${tech.id}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleTechnicianStatus(area, techId) {
            const technician = tecnicosPorArea[area]?.find(tech => tech.id === techId);
            if (!technician) {
                alert('‚ùå T√©cnico no encontrado');
                return;
            }

            const statusOptions = ['disponible', 'ocupado', 'inactivo'];
            const currentIndex = statusOptions.indexOf(technician.estado);
            const nextIndex = (currentIndex + 1) % statusOptions.length;
            const newStatus = statusOptions[nextIndex];

            const confirmation = confirm(`¬øCambiar estado de ${technician.nombre}?\n\nActual: ${technician.estado}\nNuevo: ${newStatus}`);
            
            if (confirmation) {
                technician.estado = newStatus;
                technician.disponible = newStatus === 'disponible';
                
                if (newStatus === 'disponible') {
                    technician.solicitudAsignada = null;
                }
                
                saveAllData();
                updateTechniciansDisplay();
                updateAllCounters();
                
                alert(`‚úÖ Estado cambiado: ${technician.nombre} ‚Üí ${newStatus}`);
            }
        }

        function deleteTechnician(area, techId) {
            const technician = tecnicosPorArea[area]?.find(tech => tech.id === techId);
            if (!technician) {
                alert('‚ùå T√©cnico no encontrado');
                return;
            }

            const confirmation = confirm(`¬øELIMINAR a ${technician.nombre}?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`);
            
            if (confirmation) {
                const index = tecnicosPorArea[area].findIndex(tech => tech.id === techId);
                if (index > -1) {
                    tecnicosPorArea[area].splice(index, 1);
                    saveAllData();
                    updateTechniciansDisplay();
                    updateAllCounters();
                    alert(`üóëÔ∏è ${technician.nombre} eliminado`);
                }
            }
        }

        function exportTechnicians() {
            const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            
            if (totalTechnicians === 0) {
                alert('üìã No hay t√©cnicos para exportar');
                return;
            }

            const exportData = {
                fechaExportacion: new Date().toLocaleString('es-CO'),
                totalTecnicos: totalTechnicians,
                datosPorArea: tecnicosPorArea
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `tecnicos_hospital_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert(`üì§ Lista de ${totalTechnicians} t√©cnicos exportada`);
        }

        function clearAllTechnicians() {
            const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            
            if (totalTechnicians === 0) {
                alert('üìã No hay t√©cnicos para eliminar');
                return;
            }

            const confirmation = confirm(`¬øELIMINAR TODOS los ${totalTechnicians} t√©cnicos?\n\n‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER`);
            
            if (confirmation) {
                tecnicosPorArea = {
                    'INGENIERIA_BIOMEDICA': [],
                    'MECANICA': [],
                    'INFRAESTRUCTURA': []
                };
                
                saveAllData();
                updateTechniciansDisplay();
                updateAllCounters();
                
                alert('üóëÔ∏è TODOS los t√©cnicos eliminados');
            }
        }

        // ===== FUNCIONES DE GESTI√ìN DE ACCESOS =====
        function syncAccessRequests() {
            console.log('üîÑ Sincronizando solicitudes de acceso...');
            
            try {
                loadAllData();
                updateAccessRequestsDisplay();
                updateApprovedUsersDisplay();
                updateAllCounters();
                
                const pendingCount = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
                
                alert(`üîÑ Sincronizaci√≥n de accesos completada\n\nüìä Estado:\n‚Ä¢ ${pendingCount} solicitudes pendientes\n‚Ä¢ ${approvedUsers.length} usuarios aprobados`);
                
                return true;
            } catch (error) {
                console.error('‚ùå Error en sincronizaci√≥n de accesos:', error);
                alert('‚ùå Error durante la sincronizaci√≥n');
                return false;
            }
        }

        function updateAccessRequestsDisplay() {
            const container = document.getElementById('pending-access-list');
            if (!container) return;
            
            const pendingRequests = accessRequests.filter(req => req.estado === 'PENDIENTE');
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üîê</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes pendientes</h3>
                        <p style="margin-bottom: 1.5rem;">Las solicitudes aparecer√°n aqu√≠ cuando los usuarios se registren</p>
                        <button class="btn btn-primary" onclick="syncAccessRequests()">
                            üîÑ Sincronizar
                        </button>
                    </div>
                `;
            } else {
                const requestsHTML = pendingRequests.map(request => createAccessRequestCard(request)).join('');
                container.innerHTML = requestsHTML;
            }
        }

        function createAccessRequestCard(request) {
            const serviceName = serviciosHospitalarios[request.servicioHospitalario] || request.servicioHospitalario;
            const fechaFormatted = new Date(request.fechaSolicitud).toLocaleString('es-CO');
            
            return `
                <div class="access-request-card pending">
                    <div class="request-header">
                        <div class="request-number">üìã ${request.id}</div>
                        <div>
                            <span class="status-pendiente">PENDIENTE</span>
                        </div>
                    </div>
                    
                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">üë§ Nombre</div>
                            <div class="request-detail-value">${request.nombreCompleto}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üìß Email</div>
                            <div class="request-detail-value">${request.email}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üè• Servicio</div>
                            <div class="request-detail-value">${serviceName}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üíº Cargo</div>
                            <div class="request-detail-value">${request.cargo}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üìÖ Fecha</div>
                            <div class="request-detail-value">${fechaFormatted}</div>
                        </div>
                    </div>

                    <div class="request-actions">
                        <button class="btn btn-success" onclick="approveAccessRequest('${request.id}')">
                            ‚úÖ Aprobar
                        </button>
                        <button class="btn btn-danger" onclick="rejectAccessRequest('${request.id}')">
                            ‚ùå Rechazar
                        </button>
                    </div>
                </div>
            `;
        }

        function approveAccessRequest(requestId) {
            const request = accessRequests.find(req => req.id === requestId);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }
            
            const confirmation = confirm(`¬øAprobar solicitud de ${request.nombreCompleto}?\n\nSe generar√° un c√≥digo de acceso autom√°ticamente.`);
            if (!confirmation) return;
            
            const accessCode = generateAccessCode();
            
            const approvedUser = {
                id: `USR${Date.now()}`,
                nombreCompleto: request.nombreCompleto,
                email: request.email,
                telefono: request.telefono,
                servicioHospitalario: request.servicioHospitalario,
                cargo: request.cargo,
                codigoAcceso: accessCode,
                estado: 'ACTIVO',
                fechaAprobacion: new Date().toISOString(),
                ultimoAcceso: null
            };
            
            approvedUsers.push(approvedUser);
            
            // Remover de pendientes
            const index = accessRequests.findIndex(req => req.id === requestId);
            accessRequests.splice(index, 1);
            
            saveAllData();
            updateAccessRequestsDisplay();
            updateApprovedUsersDisplay();
            updateAllCounters();
            
            alert(`‚úÖ SOLICITUD APROBADA\n\nüë§ Usuario: ${request.nombreCompleto}\nüî¢ C√≥digo: ${accessCode}\n\nüìß Comunique el c√≥digo al usuario`);
        }

        function rejectAccessRequest(requestId) {
            const request = accessRequests.find(req => req.id === requestId);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }
            
            const reason = prompt(`¬øRechazar solicitud de ${request.nombreCompleto}?\n\nIngrese el motivo:`, 'No autorizado');
            if (reason === null) return;
            
            request.estado = 'RECHAZADA';
            request.motivoRechazo = reason;
            request.fechaRechazo = new Date().toISOString();
            
            rejectedUsers.push(request);
            
            // Remover de pendientes
            const index = accessRequests.findIndex(req => req.id === requestId);
            accessRequests.splice(index, 1);
            
            saveAllData();
            updateAccessRequestsDisplay();
            updateAllCounters();
            
            alert(`‚ùå Solicitud rechazada: ${request.nombreCompleto}`);
        }

        function updateApprovedUsersDisplay() {
            const container = document.getElementById('approved-users-list');
            if (!container) return;
            
            if (approvedUsers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                        <h4>No hay usuarios aprobados</h4>
                    </div>
                `;
            } else {
                const usersHTML = approvedUsers.map(user => createApprovedUserCard(user)).join('');
                container.innerHTML = usersHTML;
            }
        }

        function createApprovedUserCard(user) {
            const serviceName = serviciosHospitalarios[user.servicioHospitalario] || user.servicioHospitalario;
            const fechaAprobacion = new Date(user.fechaAprobacion).toLocaleString('es-CO');
            const ultimoAcceso = user.ultimoAcceso ? new Date(user.ultimoAcceso).toLocaleString('es-CO') : 'Nunca';
            
            return `
                <div class="user-card approved">
                    <div class="request-header">
                        <div class="request-number">üë§ ${user.nombreCompleto}</div>
                        <div>
                            <span class="status-disponible">ACTIVO</span>
                        </div>
                    </div>
                    
                    <div class="access-code-display">
                        <div class="access-code-label">üî¢ C√ìDIGO DE ACCESO</div>
                        <div class="access-code-number">${user.codigoAcceso}</div>
                        <div class="access-code-info">V√°lido para: ${user.email}</div>
                    </div>
                    
                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">üìß Email</div>
                            <div class="request-detail-value">${user.email}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üè• Servicio</div>
                            <div class="request-detail-value">${serviceName}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üíº Cargo</div>
                            <div class="request-detail-value">${user.cargo}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üìÖ Aprobaci√≥n</div>
                            <div class="request-detail-value">${fechaAprobacion}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üïê √öltimo Acceso</div>
                            <div class="request-detail-value">${ultimoAcceso}</div>
                        </div>
                    </div>

                    <div class="request-actions">
                        <button class="btn btn-warning btn-sm" onclick="regenerateUserCode('${user.id}')">
                            üîÑ Regenerar C√≥digo
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `;
        }

        function approveAllPending() {
            const pending = accessRequests.filter(req => req.estado === 'PENDIENTE');
            
            if (pending.length === 0) {
                alert('üìã No hay solicitudes pendientes');
                return;
            }
            
            const confirmation = confirm(`¬øAprobar todas las ${pending.length} solicitudes pendientes?`);
            if (!confirmation) return;
            
            let approved = 0;
            
            pending.forEach(request => {
                const accessCode = generateAccessCode();
                
                const approvedUser = {
                    id: `USR${Date.now()}_${Math.random().toString(36).substring(2, 5)}`,
                    nombreCompleto: request.nombreCompleto,
                    email: request.email,
                    telefono: request.telefono,
                    servicioHospitalario: request.servicioHospitalario,
                    cargo: request.cargo,
                    codigoAcceso: accessCode,
                    estado: 'ACTIVO',
                    fechaAprobacion: new Date().toISOString(),
                    ultimoAcceso: null
                };
                
                approvedUsers.push(approvedUser);
                approved++;
            });
            
            // Limpiar pendientes
            accessRequests = accessRequests.filter(req => req.estado !== 'PENDIENTE');
            
            saveAllData();
            updateAccessRequestsDisplay();
            updateApprovedUsersDisplay();
            updateAllCounters();
            
            alert(`‚úÖ ${approved} usuarios aprobados masivamente`);
        }

        function regenerateUserCode(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) {
                alert('‚ùå Usuario no encontrado');
                return;
            }
            
            const confirmation = confirm(`¬øRegenerar c√≥digo para ${user.nombreCompleto}?`);
            if (!confirmation) return;
            
            const oldCode = user.codigoAcceso;
            user.codigoAcceso = generateAccessCode();
            
            saveAllData();
            updateApprovedUsersDisplay();
            
            alert(`üîÑ C√≥digo regenerado para ${user.nombreCompleto}\n\nAnterior: ${oldCode}\nNuevo: ${user.codigoAcceso}`);
        }

        function regenerateAllCodes() {
            if (approvedUsers.length === 0) {
                alert('üìã No hay usuarios aprobados');
                return;
            }
            
            const confirmation = confirm(`¬øRegenerar c√≥digos para ${approvedUsers.length} usuarios?`);
            if (!confirmation) return;
            
            approvedUsers.forEach(user => {
                user.codigoAcceso = generateAccessCode();
            });
            
            saveAllData();
            updateApprovedUsersDisplay();
            
            alert(`üîÑ ${approvedUsers.length} c√≥digos regenerados`);
        }

        function deleteUser(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) {
                alert('‚ùå Usuario no encontrado');
                return;
            }
            
            const confirmation = confirm(`¬øEliminar acceso de ${user.nombreCompleto}?`);
            if (!confirmation) return;
            
            const index = approvedUsers.findIndex(u => u.id === userId);
            approvedUsers.splice(index, 1);
            
            saveAllData();
            updateApprovedUsersDisplay();
            updateAllCounters();
            
            alert(`üóëÔ∏è Acceso eliminado: ${user.nombreCompleto}`);
        }

        function exportUsersList() {
            if (approvedUsers.length === 0) {
                alert('üìã No hay usuarios para exportar');
                return;
            }
            
            const exportData = {
                fechaExportacion: new Date().toLocaleString('es-CO'),
                totalUsuarios: approvedUsers.length,
                usuarios: approvedUsers
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `usuarios_aprobados_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert(`üì§ ${approvedUsers.length} usuarios exportados`);
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function findTechnicianById(techId) {
            for (const area of Object.keys(tecnicosPorArea)) {
                const technician = tecnicosPorArea[area].find(tech => tech.id === techId);
                if (technician) return technician;
            }
            return null;
        }

        function findTechnicianByName(name) {
            for (const area of Object.keys(tecnicosPorArea)) {
                const technician = tecnicosPorArea[area].find(tech => tech.nombre === name);
                if (technician) return technician;
            }
            return null;
        }

        function showCriticalAlerts() {
            const criticalRequests = solicitudesFromPortal.filter(req => req.prioridad === 'CRITICA' && (!req.tecnicoAsignado || req.estadoGestion === 'PENDIENTE'));
            
            const alertsContainer = document.getElementById('critical-alerts');
            if (!alertsContainer) return;
            
            if (criticalRequests.length > 0) {
                alertsContainer.innerHTML = `
                    <div class="alert alert-danger" style="animation: blink 2s infinite;">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">üö® SOLICITUDES CR√çTICAS PENDIENTES</h3>
                        <p>Hay <strong>${criticalRequests.length}</strong> solicitudes cr√≠ticas sin asignar que requieren atenci√≥n inmediata.</p>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-danger btn-sm" onclick="showView('solicitudes'); filterRequests('CRITICA');">
                                üö® Ver Cr√≠ticas
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="autoAssignAllPending()">
                                ü§ñ Auto-asignar Todas
                            </button>
                        </div>
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = '';
            }
        }

        function updateAreaRequests() {
            const areas = ['INGENIERIA_BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'];
            
            areas.forEach(area => {
                const areaRequests = solicitudesFromPortal.filter(req => req.servicioIngenieria === area);
                const containerName = area === 'INGENIERIA_BIOMEDICA' ? 'biomedica' : 
                                   area === 'MECANICA' ? 'mecanica' : 'infraestructura';
                
                const container = document.getElementById(`${containerName}-requests`);
                if (!container) return;
                
                if (areaRequests.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay solicitudes para esta √°rea</p>';
                } else {
                    const requestsHTML = areaRequests.map(request => createRequestCard(request)).join('');
                    container.innerHTML = requestsHTML;
                }
            });
        }

        function refreshAreaRequests(area) {
            console.log(`üîÑ Actualizando solicitudes de ${area}`);
            syncAllRequests();
            updateAreaRequests();
        }

        function updateAllCounters() {
            try {
                // Contadores de solicitudes
                const total = solicitudesFromPortal.length;
                const biomedica = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INGENIERIA_BIOMEDICA').length;
                const mecanica = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'MECANICA').length;
                const infraestructura = solicitudesFromPortal.filter(r => r.servicioIngenieria === 'INFRAESTRUCTURA').length;
                const pendientes = solicitudesFromPortal.filter(r => !r.tecnicoAsignado || r.estadoGestion === 'PENDIENTE').length;

                // Contadores de t√©cnicos
                const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
                const biomedicaPersonnel = tecnicosPorArea['INGENIERIA_BIOMEDICA'].length;
                const mecanicaPersonnel = tecnicosPorArea['MECANICA'].length;
                const infraestructuraPersonnel = tecnicosPorArea['INFRAESTRUCTURA'].length;

                // Contadores de accesos
                const pendingAccess = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
                const totalUsers = approvedUsers.length;

                // Funci√≥n para actualizar elementos
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };

                // Actualizar m√©tricas del dashboard
                updateElement('metric-total', total);
                updateElement('metric-biomedica', biomedica);
                updateElement('metric-mecanica', mecanica);
                updateElement('metric-infraestructura', infraestructura);
                updateElement('metric-pendientes', pendientes);

                // Actualizar navegaci√≥n
                updateElement('total-count', total);
                updateElement('notification-count', pendientes);
                updateElement('total-technicians-nav', totalTechnicians);
                updateElement('pending-access-count', pendingAccess);

                // Actualizar tabs de √°rea
                updateElement('tab-biomedica-count', biomedica);
                updateElement('tab-mecanica-count', mecanica);
                updateElement('tab-infraestructura-count', infraestructura);

                // Actualizar contadores de personal
                updateElement('biomedica-personnel-count', `${biomedicaPersonnel} registrados`);
                updateElement('mecanica-personnel-count', `${mecanicaPersonnel} registrados`);
                updateElement('infraestructura-personnel-count', `${infraestructuraPersonnel} registrados`);

                updateElement('biomedica-total', `${biomedicaPersonnel} ingenieros/t√©cnicos`);
                updateElement('mecanica-total', `${mecanicaPersonnel} ingenieros/t√©cnicos`);
                updateElement('infraestructura-total', `${infraestructuraPersonnel} ingenieros/t√©cnicos`);

                // Estad√≠sticas de t√©cnicos
                let totalEngineers = 0;
                let totalTechsOnly = 0;
                let availableCount = 0;
                let busyCount = 0;
                let inactiveCount = 0;

                Object.values(tecnicosPorArea).forEach(areaList => {
                    areaList.forEach(tech => {
                        if (tech.tipo === 'INGENIERO') totalEngineers++;
                        else totalTechsOnly++;

                        if (tech.estado === 'disponible') availableCount++;
                        else if (tech.estado === 'ocupado') busyCount++;
                        else if (tech.estado === 'inactivo') inactiveCount++;
                    });
                });

                updateElement('total-technicians', totalTechnicians);
                updateElement('total-engineers', totalEngineers);
                updateElement('total-technicians-only', totalTechsOnly);
                updateElement('available-technicians', availableCount);
                updateElement('busy-technicians', busyCount);
                updateElement('inactive-technicians', inactiveCount);

                // Contadores de accesos
                updateElement('total-users', totalUsers);
                updateElement('pending-access', pendingAccess);
                updateElement('approved-users', totalUsers);
                updateElement('rejected-users', rejectedUsers.length);

                // Actualizar res√∫menes de personal en dashboard
                updatePersonnelSummaries();

                // Actualizar reportes
                updateReports();

                console.log(`üìä Contadores actualizados: ${total} solicitudes, ${totalTechnicians} t√©cnicos, ${pendingAccess} accesos pendientes`);

            } catch (error) {
                console.error('‚ùå Error en updateAllCounters:', error);
            }
        }

        function updatePersonnelSummaries() {
            const areas = [
                { key: 'INGENIERIA_BIOMEDICA', name: 'biomedica' },
                { key: 'MECANICA', name: 'mecanica' },
                { key: 'INFRAESTRUCTURA', name: 'infraestructura' }
            ];

            areas.forEach(area => {
                const personnel = tecnicosPorArea[area.key] || [];
                const summaryContainer = document.getElementById(`${area.name}-personnel-summary`);
                
                if (!summaryContainer) return;
                
                if (personnel.length === 0) {
                    summaryContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No hay personal registrado</p>';
                } else {
                    const available = personnel.filter(p => p.estado === 'disponible').length;
                    const busy = personnel.filter(p => p.estado === 'ocupado').length;
                    const inactive = personnel.filter(p => p.estado === 'inactivo').length;
                    
                    summaryContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                            <div>
                                <div style="font-weight: bold; color: #059669;">${available}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Disponibles</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #f59e0b;">${busy}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Ocupados</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #ef4444;">${inactive}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Inactivos</div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function updateReports() {
            // Reportes por estado
            const pendingCount = solicitudesFromPortal.filter(req => !req.tecnicoAsignado || req.estadoGestion === 'PENDIENTE').length;
            const assignedCount = solicitudesFromPortal.filter(req => req.tecnicoAsignado && req.estadoGestion !== 'COMPLETADA' && req.estadoGestion !== 'PENDIENTE').length;
            const completedCount = solicitudesFromPortal.filter(req => req.estadoGestion === 'COMPLETADA').length;

            // Personal por √°rea
            const biomedicaStaff = tecnicosPorArea['INGENIERIA_BIOMEDICA'].length;
            const mecanicaStaff = tecnicosPorArea['MECANICA'].length;
            const infraestructuraStaff = tecnicosPorArea['INFRAESTRUCTURA'].length;

            // Accesos
            const accessPending = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
            const accessApproved = approvedUsers.length;
            const totalUsersCount = approvedUsers.length;

            const updateReportElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };

            updateReportElement('report-pending', pendingCount);
            updateReportElement('report-assigned', assignedCount);
            updateReportElement('report-completed', completedCount);

            updateReportElement('report-biomedica-staff', biomedicaStaff);
            updateReportElement('report-mecanica-staff', mecanicaStaff);
            updateReportElement('report-infraestructura-staff', infraestructuraStaff);

            updateReportElement('report-access-pending', accessPending);
            updateReportElement('report-access-approved', accessApproved);
            updateReportElement('report-total-users', totalUsersCount);
        }

        function updateSystemStatus(message) {
            const statusElement = document.querySelector('.system-status .status-online');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // ===== FUNCIONES DE NAVEGACI√ìN =====
        function showView(viewName) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            
            // Mostrar vista seleccionada
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            // Actualizar tabs de navegaci√≥n
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`[data-view="${viewName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // Acciones espec√≠ficas por vista
            if (viewName === 'solicitudes') {
                syncAllRequests();
            } else if (viewName === 'tecnicos') {
                updateTechniciansDisplay();
            } else if (viewName === 'accesos') {
                syncAccessRequests();
            } else if (viewName === 'areas') {
                updateAreaRequests();
            }

            // Siempre actualizar contadores
            updateAllCounters();
        }

        function showAreaTab(area) {
            // Ocultar todos los contenidos de √°rea
            document.querySelectorAll('.area-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Mostrar el contenido del √°rea seleccionada
            const targetContent = document.getElementById(`area-${area}`);
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
            
            // Actualizar tabs activos
            document.querySelectorAll('.area-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-area="${area}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        function filterByArea(area) {
            showView('solicitudes');
            setTimeout(() => {
                if (area === 'all') {
                    filterRequests('all');
                } else {
                    // Implementar filtro por √°rea espec√≠fica
                    currentFilter = area;
                    updateRequestsDisplay();
                }
            }, 100);
        }

        function filterByStatus(status) {
            showView('solicitudes');
            setTimeout(() => {
                filterRequests(status);
            }, 100);
        }

        // ===== FUNCIONES ADICIONALES =====
        function showFilterOptions() {
            alert('üîç Filtros disponibles:\n\n‚Ä¢ Todas las solicitudes\n‚Ä¢ Por estado (Pendiente, Asignada, Completada)\n‚Ä¢ Por prioridad (Cr√≠tica, Alta, Media, Baja)\n‚Ä¢ Por √°rea de ingenier√≠a\n\nUse los botones de filtros r√°pidos para navegar');
        }

        function exportRequestsReport() {
            if (solicitudesFromPortal.length === 0) {
                alert('üìã No hay solicitudes para exportar');
                return;
            }

            const exportData = {
                fechaExportacion: new Date().toLocaleString('es-CO'),
                totalSolicitudes: solicitudesFromPortal.length,
                solicitudes: solicitudesFromPortal,
                estadisticas: {
                    pendientes: solicitudesFromPortal.filter(r => !r.tecnicoAsignado || r.estadoGestion === 'PENDIENTE').length,
                    asignadas: solicitudesFromPortal.filter(r => r.tecnicoAsignado && r.estadoGestion !== 'COMPLETADA' && r.estadoGestion !== 'PENDIENTE').length,
                    completadas: solicitudesFromPortal.filter(r => r.estadoGestion === 'COMPLETADA').length,
                    criticas: solicitudesFromPortal.filter(r => r.prioridad === 'CRITICA').length
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `solicitudes_mantenimiento_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert(`üì§ Reporte de ${solicitudesFromPortal.length} solicitudes exportado`);
        }

        function viewRequestDetails(requestNumber) {
            const request = solicitudesFromPortal.find(req => req.numero === requestNumber);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }

            const serviceName = serviciosHospitalarios[request.servicioHospitalario] || request.servicioHospitalario;
            const areaName = serviciosIngenieria[request.servicioIngenieria] || request.servicioIngenieria;

            let details = `üìã DETALLES COMPLETOS DE SOLICITUD\n\nüÜî N√∫mero: ${request.numero}\nüîß √Årea: ${areaName}\nüî® Tipo: ${(request.tipoServicio || 'No especificado').replace('_', ' ')}\n‚ö° Prioridad: ${request.prioridad}\nüè• Servicio: ${serviceName}\nüë§ Solicitante: ${request.solicitante || 'No especificado'}\nüìß Email: ${request.emailSolicitante || 'No especificado'}\nüñ•Ô∏è Equipo: ${request.equipo || 'No especificado'}\nüìç Ubicaci√≥n: ${request.ubicacion || 'No especificado'}\nüìÖ Fecha: ${request.fechaCreacion || 'No especificado'}\nüë®‚Äçüîß T√©cnico: ${request.tecnicoAsignado || 'Sin asignar'}\nüìä Estado: ${request.estadoGestion || request.estado || 'PENDIENTE'}\n\nüìù Descripci√≥n:\n${request.descripcion || 'No especificada'}\n\n${request.observaciones ? `üí≠ Observaciones:\n${request.observaciones}\n\n` : ''}`;

            if (request.respuestaTecnico) {
                details += `‚úÖ RESPUESTA DEL T√âCNICO:\n${request.respuestaTecnico}\nüìÖ Fecha respuesta: ${request.fechaRespuesta || 'No especificada'}`;
            }

            alert(details);
        }

        function generateWorkReport(requestNumber) {
            const request = solicitudesFromPortal.find(req => req.numero === requestNumber);
            if (!request) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }

            if (request.estadoGestion !== 'COMPLETADA') {
                alert('‚ö†Ô∏è Solo se pueden generar reportes para solicitudes completadas');
                return;
            }

            const serviceName = serviciosHospitalarios[request.servicioHospitalario] || request.servicioHospitalario;
            const areaName = serviciosIngenieria[request.servicioIngenieria] || request.servicioIngenieria;

            const reportData = {
                numeroSolicitud: request.numero,
                fechaGeneracion: new Date().toLocaleString('es-CO'),
                area: areaName,
                tipoServicio: (request.tipoServicio || 'No especificado').replace('_', ' '),
                prioridad: request.prioridad,
                servicio: serviceName,
                solicitante: request.solicitante || 'No especificado',
                equipo: request.equipo || 'No especificado',
                ubicacion: request.ubicacion || 'No especificado',
                fechaSolicitud: request.fechaCreacion || 'No especificado',
                tecnicoAsignado: request.tecnicoAsignado || 'No especificado',
                fechaAsignacion: request.fechaAsignacion || 'No especificado',
                fechaCompletada: request.fechaCompletada || 'No especificado',
                descripcionProblema: request.descripcion || 'No especificada',
                observaciones: request.observaciones || 'Ninguna',
                respuestaTecnico: request.respuestaTecnico || 'No disponible',
                fechaRespuesta: request.fechaRespuesta || 'No especificada'
            };

            const reportContent = `
REPORTE DE TRABAJO - SOLICITUD DE MANTENIMIENTO
===============================================

üìã INFORMACI√ìN GENERAL:
- N√∫mero de Solicitud: ${reportData.numeroSolicitud}
- Fecha de Generaci√≥n: ${reportData.fechaGeneracion}
- √Årea T√©cnica: ${reportData.area}
- Tipo de Servicio: ${reportData.tipoServicio}
- Prioridad: ${reportData.prioridad}

üè• INFORMACI√ìN DEL SOLICITANTE:
- Servicio: ${reportData.servicio}
- Solicitante: ${reportData.solicitante}
- Fecha de Solicitud: ${reportData.fechaSolicitud}

üîß INFORMACI√ìN T√âCNICA:
- Equipo/Sistema: ${reportData.equipo}
- Ubicaci√≥n: ${reportData.ubicacion}
- T√©cnico Asignado: ${reportData.tecnicoAsignado}
- Fecha de Asignaci√≥n: ${reportData.fechaAsignacion}
- Fecha de Finalizaci√≥n: ${reportData.fechaCompletada}

üìù DESCRIPCI√ìN DEL PROBLEMA:
${reportData.descripcionProblema}

üí≠ OBSERVACIONES:
${reportData.observaciones}

‚úÖ RESPUESTA/INFORME DEL T√âCNICO:
${reportData.respuestaTecnico}
Fecha de Respuesta: ${reportData.fechaRespuesta}

===============================================
Hospital Susana L√≥pez de Valencia E.S.E.
Sistema de Gesti√≥n de Mantenimiento
            `;

            // Crear y descargar el reporte
            const reportBlob = new Blob([reportContent], {type: 'text/plain;charset=utf-8'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(reportBlob);
            link.download = `Reporte_Trabajo_${request.numero}_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();

            alert(`üìÑ Reporte de trabajo generado para la solicitud ${request.numero}`);
        }

        function generateFullReport() {
            const totalRequests = solicitudesFromPortal.length;
            const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            const totalUsers = approvedUsers.length;
            const pendingAccess = accessRequests.filter(req => req.estado === 'PENDIENTE').length;

            const report = `üìä REPORTE COMPLETO DEL SISTEMA\n\nüìÖ Fecha: ${new Date().toLocaleString('es-CO')}\n\nüìã SOLICITUDES DE MANTENIMIENTO:\n‚Ä¢ Total: ${totalRequests}\n‚Ä¢ Pendientes: ${solicitudesFromPortal.filter(r => !r.tecnicoAsignado || r.estadoGestion === 'PENDIENTE').length}\n‚Ä¢ Asignadas: ${solicitudesFromPortal.filter(r => r.tecnicoAsignado && r.estadoGestion !== 'COMPLETADA' && r.estadoGestion !== 'PENDIENTE').length}\n‚Ä¢ Completadas: ${solicitudesFromPortal.filter(r => r.estadoGestion === 'COMPLETADA').length}\n‚Ä¢ Cr√≠ticas: ${solicitudesFromPortal.filter(r => r.prioridad === 'CRITICA').length}\n\nüë• PERSONAL T√âCNICO:\n‚Ä¢ Total: ${totalTechnicians}\n‚Ä¢ Biom√©dica: ${tecnicosPorArea['INGENIERIA_BIOMEDICA'].length}\n‚Ä¢ Mec√°nica: ${tecnicosPorArea['MECANICA'].length}\n‚Ä¢ Infraestructura: ${tecnicosPorArea['INFRAESTRUCTURA'].length}\n\nüîê GESTI√ìN DE ACCESOS:\n‚Ä¢ Usuarios aprobados: ${totalUsers}\n‚Ä¢ Solicitudes pendientes: ${pendingAccess}\n‚Ä¢ Total rechazados: ${rejectedUsers.length}\n\n‚úÖ Sistema funcionando correctamente`;

            alert(report);
        }

        function exportAllData() {
            const exportData = {
                fechaExportacion: new Date().toLocaleString('es-CO'),
                solicitudes: solicitudesFromPortal,
                tecnicos: tecnicosPorArea,
                usuariosAprobados: approvedUsers,
                solicitudesAcceso: accessRequests,
                usuariosRechazados: rejectedUsers,
                estadisticas: {
                    totalSolicitudes: solicitudesFromPortal.length,
                    totalTecnicos: Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0),
                    totalUsuarios: approvedUsers.length
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `hospital_datos_completos_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('üì§ Exportaci√≥n completa de todos los datos realizada');
        }

        function showNotifications() {
            const totalRequests = solicitudesFromPortal.length;
            const pendingRequests = solicitudesFromPortal.filter(r => !r.tecnicoAsignado || r.estadoGestion === 'PENDIENTE').length;
            const criticalRequests = solicitudesFromPortal.filter(r => r.prioridad === 'CRITICA').length;
            const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
            const availableTechnicians = Object.values(tecnicosPorArea).flat().filter(tech => tech.estado === 'disponible').length;
            const totalUsers = approvedUsers.length;
            const pendingAccess = accessRequests.filter(req => req.estado === 'PENDIENTE').length;

            alert(`üîî NOTIFICACIONES DEL SISTEMA\n\nüìä ESTADO ACTUAL:\n‚Ä¢ ${totalRequests} Solicitudes de mantenimiento\n‚Ä¢ ${pendingRequests} Solicitudes pendientes\n‚Ä¢ ${criticalRequests} Solicitudes cr√≠ticas\n‚Ä¢ ${totalTechnicians} T√©cnicos registrados\n‚Ä¢ ${availableTechnicians} T√©cnicos disponibles\n‚Ä¢ ${totalUsers} Usuarios con acceso\n‚Ä¢ ${pendingAccess} Accesos pendientes\n\nüéØ SISTEMA COMPLETAMENTE FUNCIONAL:\n‚Ä¢ ‚úÖ Recepci√≥n de solicitudes\n‚Ä¢ ‚úÖ Asignaci√≥n de t√©cnicos\n‚Ä¢ ‚úÖ Gesti√≥n de accesos\n‚Ä¢ ‚úÖ Reportes y estad√≠sticas\n‚Ä¢ ‚úÖ Persistencia de datos\n‚Ä¢ ‚úÖ Respuestas de t√©cnicos\n\n${pendingRequests > 0 ? `‚ö†Ô∏è HAY ${pendingRequests} SOLICITUDES PENDIENTES` : 'üü¢ No hay solicitudes pendientes'}\n${criticalRequests > 0 ? `üö® HAY ${criticalRequests} SOLICITUDES CR√çTICAS` : ''}\n${pendingAccess > 0 ? `üîê HAY ${pendingAccess} ACCESOS PENDIENTES` : ''}`);
        }

        // ===== INICIALIZACI√ìN DEL SISTEMA COMPLETO =====
        function initializeCompleteSystem() {
            console.log('üöÄ Inicializando Portal de Gesti√≥n COMPLETO...');
            updateSystemStatus('üöÄ Iniciando sistema completo...');
            
            try {
                // Cargar todos los datos
                loadAllData();
                
                // Inicializar interfaz
                updateTechniciansDisplay();
                updateRequestsDisplay();
                updateAccessRequestsDisplay();
                updateApprovedUsersDisplay();
                updateAreaRequests();
                
                // Actualizar contadores
                updateAllCounters();
                
                // Mostrar alertas cr√≠ticas
                showCriticalAlerts();
                
                // Configurar auto-guardado
                setInterval(() => {
                    saveAllData();
                }, 30000); // Cada 30 segundos
                
                // Configurar auto-sincronizaci√≥n
                setInterval(() => {
                    loadAllData();
                    updateAllCounters();
                    showCriticalAlerts();
                }, 10000); // Cada 10 segundos
                
                // Guardar al cerrar
                window.addEventListener('beforeunload', () => {
                    saveAllData();
                });
                
                const totalRequests = solicitudesFromPortal.length;
                const totalTechnicians = Object.values(tecnicosPorArea).reduce((sum, area) => sum + area.length, 0);
                const totalUsers = approvedUsers.length;
                const pendingAccess = accessRequests.filter(req => req.estado === 'PENDIENTE').length;
                
                console.log(`‚úÖ SISTEMA COMPLETO INICIADO:`);
                console.log(`üìã ${totalRequests} solicitudes`);
                console.log(`üë• ${totalTechnicians} t√©cnicos`);
                console.log(`üîê ${totalUsers} usuarios, ${pendingAccess} pendientes`);
                
                updateSystemStatus(`‚úÖ Sistema completo activo - ${totalRequests} solicitudes, ${totalTechnicians} t√©cnicos`);
                
                return true;
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                updateSystemStatus('‚ùå Error en inicializaci√≥n');
                return false;
            }
        }

        // ===== INICIALIZACI√ìN AUTOM√ÅTICA =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Portal de Gesti√≥n Hospital Susana L√≥pez de Valencia - VERSI√ìN COMPLETA');
            console.log('üìã Gesti√≥n de solicitudes de mantenimiento');
            console.log('üë• Gesti√≥n de t√©cnicos e ingenieros');
            console.log('üîê Gesti√≥n de accesos con c√≥digos');
            console.log('üìä Reportes y estad√≠sticas');
            console.log('üìù Respuestas de t√©cnicos al completar solicitudes');
            
            setTimeout(() => {
                initializeCompleteSystem();
            }, 100);
        });

        console.log('‚úÖ Portal de Gesti√≥n COMPLETO - Todas las funcionalidades implementadas');
        console.log('üîß Funcionalidades: Solicitudes, T√©cnicos, Accesos, Reportes, Respuestas');
        console.log('üíæ Persistencia: localStorage con auto-guardado');
        console.log('üîÑ Sincronizaci√≥n: Autom√°tica cada 10 segundos');
        console.log('üìù Nueva funci√≥n: Respuesta del t√©cnico al completar solicitudes');
        console.log('üéØ Estado: COMPLETAMENTE FUNCIONAL CON RESPUESTAS');
    </script>
</body>
</html>